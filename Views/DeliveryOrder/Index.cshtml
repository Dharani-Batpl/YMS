@using Microsoft.AspNetCore.Mvc.Rendering
@{
    // Read JSON payload for grid from ViewData
    var deliveryOrderData = ViewData["DeliveryOrderData"] ?? "[]";
    Layout = "_Layout";
}

<head>
    <!-- Keep head empty as requested -->
</head>


<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
</style>
<div class="main-container">
    <!-- Page title header -->
@*     <div id="pageTitle" class="col-12 text-center py-1 mb-3">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Delivery Order Configuration</h6>
    </div> *@

    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Delivery Order Configuration</h6>
    </div>

    <!-- Toolbar row with search + actions -->
    <div class="row align-items-center mb-3">
        <div class="w-100 d-md-none"></div>

        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search" style="max-width: 280px; min-width: 150px;" />

            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file input (CSV) -->
    <form id="afForm" style="display:none" method="post">
        @Html.AntiForgeryToken()
        <input type="file" id="upload-file" style="display:none" accept=".csv,text/csv" />

    </form>

    <!-- Split area -->
    <div class="row g-2">
        <!-- Parent table -->
        <div class="col-12">
            <div class="card split-pane-card">
                <div class="card-header card-header-compact">Delivery Order</div>
                <div class="card-body card-body-compact">
                    <div id="DeliveryOrderTable" class="tabulator-bootstrap5"></div>
                    @* <div id="recordCount" class="text-end mt-2 fw-semibold text-secondary"></div> *@
                     <div id="recordCount" class="footer-total-records"></div>
                </div>
            </div>
        </div>

        <!-- Child table -->
        <div class="col-12">
            <div class="card split-pane-card">
                <div class="card-header card-header-compact">
                    <span class="text-muted" id="childTitle">(select a Delivery Order)</span>
                </div>
                <div class="card-body card-body-compact">
                    <div id="DeliveryOrderDetailsTable" class="tabulator-bootstrap5"></div>
                    @* <div id="recordCount1" class="text-end mt-2 fw-semibold text-secondary"></div> *@
                     <div id="recordCount1" class="footer-total-records"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit modal -->
<div class="modal fade" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Delivery Order Configuration</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>

            <div class="modal-body">
                <form id="addEditForm">
                    <input type="hidden" id="Do_id" name="Do_id" />

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="Do_number" class="form-label">Delivery Order Number</label>
                            <span class="text-danger"><strong>*</strong></span>
                            <input type="text" class="form-control" id="Do_number" name="Do_number" maxlength="50" required />
                        </div>

                        <div class="col-md-4">
                            <label for="Do_at" class="form-label">Order Date</label>
                            <span class="text-danger"><strong>*</strong></span>
                            <input type="date" class="form-control" id="Do_at" name="Do_at" required />
                        </div>
                        <div class="col-md-4">
                            <label for="Planned_dispatch_at" class="form-label">Planned Dispatch Date</label>
                            <span class="text-danger"><strong>*</strong></span>
                            <input type="date" class="form-control" id="Planned_dispatch_at" name="Planned_dispatch_at" required />
                        </div>
                        <div class="col-md-4">
                            <label for="Customer_id" class="form-label">Dealer Name</label>
                            <span class="text-danger"><strong>*</strong></span>
                            <select class="form-select" id="Customer_id" name="Customer_id"
                                    asp-items="@(ViewBag.CustomerList as IEnumerable<SelectListItem>)" maxlength="50" required>
                                <option value="" selected disabled>Select Dealer Name</option>
                            </select>
                        </div>

                        @* <div class="col-md-4">
                            <label for="Date_of_production" class="form-label">Date of Production</label>
                            <input type="datetime-local" class="form-control" id="Date_of_production" name="Date_of_production" required />
                        </div> *@

                        <div class="col-md-4">
                            <label for="Delivery_location_id" class="form-label">Delivery Location</label>
                            <span class="text-danger"><strong>*</strong></span>
                            <select class="form-select" id="Delivery_location_id" name="Delivery_location_id"
                                    asp-items="@(ViewBag.locationList as IEnumerable<SelectListItem>)" required>
                                <option value="" selected disabled>Select Location</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label d-block">
                                Priority
                                <!-- Required asterisk symbol -->
                                <span class="text-danger"><strong>*</strong></span>
                            </label>

                            <!-- Hidden input that stores the selected priority -->
                            <input type="hidden" id="Priority" name="Priority" required />

                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn priority-btn" data-value="Low" style="background: transparent; border: 1px solid #ccc;">Low</button>
                                <button type="button" class="btn priority-btn" data-value="Medium" style="background: transparent; border: 1px solid #ccc;">Medium</button>
                                <button type="button" class="btn priority-btn" data-value="High" style="background: transparent; border: 1px solid #ccc;">High</button>
                                <button type="button" class="btn priority-btn" data-value="Critical" style="background: transparent; border: 1px solid #ccc;">Critical</button>
                            </div>

                            <!-- Validation message for Priority -->
                            <small id="priorityError" class="text-danger" style="display:none;">Please select a priority.</small>
                        </div>



                    </div>

                    <hr class="my-4">

                    <div class="mt-3 d-flex align-items-center justify-content-between">
                        <label class="mb-0 fw-semibold">Delivery Order Details</label>
                        <button type="button" class="btn btn-primary-professional" id="addScreenBtn">
                            <i class="bi bi-plus-circle"></i> Add Details
                        </button>
                    </div>

                    <!-- Dynamic detail rows -->
                    <div class="mt-3" id="screensContainer"></div>

                    <input type="hidden" id="Assigned_modules" name="Assigned_modules" />
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary-professional" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary-professional" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for Upload (CSV/XLSX) -->
<input type="file" id="upload-file" class="d-none" accept=".csv,.xlsx" />

<!-- Option templates -->
<div id="tpl-Brand-options" class="d-none">
    <option value="">Select Brand</option>
    @foreach (var m in (IEnumerable<SelectListItem>)ViewBag.brandList ?? Enumerable.Empty<SelectListItem>())
    {
        <option value="@m.Value">@m.Text</option>
    }
</div>

<div id="tpl-VehicleType-options" class="d-none">
    <option value="">Select Vehicle Type</option>
    @foreach (var s in (IEnumerable<SelectListItem>)ViewBag.VehicleTypeList ?? Enumerable.Empty<SelectListItem>())
    {
        <option value="@s.Value">@s.Text</option>
    }
</div>

<div id="tpl-Variant-options" class="d-none">
    <option value="">Select Vehicle Model</option>
    @foreach (var p in (IEnumerable<SelectListItem>)ViewBag.VehicleModalList ?? Enumerable.Empty<SelectListItem>())
    {
        <option value="@p.Value">@p.Text</option>
    }
</div>

<div id="tpl-Color-options" class="d-none">
    <option value="">Select Color</option>
    @foreach (var p in (IEnumerable<SelectListItem>)ViewBag.ColorList ?? Enumerable.Empty<SelectListItem>())
    {
        <option value="@p.Value">@p.Text</option>
    }
</div>



<script>
    document.addEventListener("DOMContentLoaded", () => {
        // ---------- Reusable ----------
        initTooltips();

            // Get references to the date input fields
        const orderDate = document.getElementById('Do_at');
        const dispatchDate = document.getElementById('Planned_dispatch_at');

        // Get today's date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];

        // Restrict Order Date: Only past and current dates
        orderDate.setAttribute('max', today);

        // Restrict Dispatch Date: Only current and future dates
        dispatchDate.setAttribute('min', today);

            document.querySelectorAll('input[type="date"]').forEach(input => {
        // Prevent typing in the date input fields (calendar-only)
        input.addEventListener('keydown', (e) => {
            e.preventDefault(); // Block typing
        });

        // Open calendar on focus if it's not triggered automatically in all browsers
        input.addEventListener('focus', function () {
            // Check if the input is empty and required
            if (!this.value && this.hasAttribute('required')) {
                // Prevent calendar from opening if required field is empty
                return;
            }

            // If the field is valid or not required, show the calendar
            this.showPicker();
        });
    });

        const deliveryOrderData = JSON.parse('@Html.Raw(deliveryOrderData)');
        let selectedRow = null;
        let currentMode = "";

        // Modal + form (single definitions)
        const addEditModalEl = document.getElementById('addEditModal');
        const addEditModal = new bootstrap.Modal(addEditModalEl);
        const form = document.getElementById("addEditForm");

        // ---------- Utilities ----------
        function generateTabulatorColumns(data) {
            if (!data || data.length === 0) return [];
            const fields = Object.keys(data[0]);
            const formatTitle = (str) => {
                let result = str.replace(/[_\-]/g, ' ');
                result = result.replace(/([a-z])([A-Z])/g, '$1 $2');
                return result.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            };
            return fields.map(field => ({ title: formatTitle(field), field }));
        }

        function generateChildColumns() {
            return [
                { title: "Brand", field: "Brand_name" },
                { title: "Vehicle Type Name", field: "Vehicle_type_name" },
                { title: "Variant Name", field: "Variant_name" },
                { title: "Color Name", field: "Color_name" },
                { title: "Quantity Ordered", field: "Quantity_ordered" },
            ];
        }
            const childTable = initializeTabulatorFitColumns(
              "#DeliveryOrderDetailsTable",
               [],
              generateChildColumns(deliveryOrderData),
              (data) => {

              }
            );


        function resetDropdown($select, placeholder = 'Select Option') {
            $select.empty();
            $select.append($('<option>', { value: '', text: placeholder }));
        }

        function populateDropdown($select, data, selectedValue = null) {
            if (!Array.isArray(data)) return;
            // keep first option as placeholder
            $.each(data, function (_, item) {
                const $opt = $('<option>', { value: item.value, text: item.text });
                if (selectedValue != null && Number(selectedValue) === Number(item.value)) {
                    $opt.prop('selected', true);
                }
                $select.append($opt);
            });
        }

        function addScreenRow(values = {}) {
            const idx = document.querySelectorAll('#screensContainer .screen-row').length;

            const brandOpts       = document.getElementById("tpl-Brand-options").innerHTML;
            const vehicleTypeOpts = document.getElementById("tpl-VehicleType-options").innerHTML;
            const variantOpts     = document.getElementById("tpl-Variant-options").innerHTML;
            const colorOpts       = document.getElementById("tpl-Color-options").innerHTML;

            const tpl = `
              <div class="screen-row mb-3" data-row-index="${idx}">
                <div class="row g-3">

                  <div class="col-md-4">
                    <label class="form-label" for="Details_${idx}__Brand_id">Brand Name</label>
                    <span class="text-danger"><strong>*</strong></span>
                    <select class="form-select" id="Details_${idx}__Brand_id" name="Details[${idx}].Brand_id" required >
                      ${brandOpts}
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="Details_${idx}__Vehicle_type_id">Vehicle Type</label>
                    <span class="text-danger"><strong>*</strong></span>
                    <select class="form-select" id="Details_${idx}__Vehicle_type_id" name="Details[${idx}].Vehicle_type_id" required >
                      ${vehicleTypeOpts}
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="Details_${idx}__Variant_id">Vehicle Variant</label>
                    <span class="text-danger"><strong>*</strong></span>
                    <select class="form-select" id="Details_${idx}__Variant_id" name="Details[${idx}].Variant_id" required >
                      ${variantOpts}
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="Details_${idx}__Color_id">Color</label>
                    <span class="text-danger"><strong>*</strong></span>
                    <select class="form-select" id="Details_${idx}__Color_id" name="Details[${idx}].Color_id" required >
                      ${colorOpts}
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="Details_${idx}__Quantity_ordered">Quantity Ordered</label>
                    <span class="text-danger"><strong>*</strong></span>
                    <input type="number" class="form-control" id="Details_${idx}__Quantity_ordered" name="Details[${idx}].Quantity_ordered" min="1" step="1" required />
                  </div>

                </div>

                       <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-screen"><i class="fas fa-trash-alt"></i></button>


              </div>`;

            const container = document.getElementById("screensContainer");
            container.insertAdjacentHTML('beforeend', tpl);

            const row = container.lastElementChild;

            // Set values if provided
            if (values.Brand_id)        row.querySelector('[name$=".Brand_id"]').value = values.Brand_id;
            if (values.Vehicle_type_id) row.querySelector('[name$=".Vehicle_type_id"]').value = values.Vehicle_type_id;
            if (values.Variant_id)      row.querySelector('[name$=".Variant_id"]').value = values.Variant_id;
            if (values.Color_id)        row.querySelector('[name$=".Color_id"]').value = values.Color_id;
            if (values.Quantity_ordered != null) row.querySelector('[name$=".Quantity_ordered"]').value = values.Quantity_ordered;

            row.querySelector('.remove-screen').addEventListener('click', () => {
                row.remove();
                reindexScreenRows();
            });
        }

        function reindexScreenRows() {
            const rows = document.querySelectorAll('#screensContainer .screen-row');
            rows.forEach((row, i) => {
                row.dataset.rowIndex = i;
                // Update controls and their labels
                row.querySelectorAll('select, input').forEach(el => {
                    const oldId = el.id;
                    const oldName = el.name;
                    const newId = oldId.replace(/Details_\d+__/, `Details_${i}__`);
                    const newName = oldName.replace(/Details\[\d+\]\./, `Details[${i}].`);
                    el.id = newId;
                    el.name = newName;

                    // Update matching label[for]
                    const label = row.querySelector(`label[for="${oldId}"]`);
                    if (label) label.setAttribute('for', newId);
                });
            });
        }

        function collectDetailsFromForm() {
            const rows = [...document.querySelectorAll('#screensContainer .screen-row')];
            return rows.map(r => {
                const pick = sel => r.querySelector(sel);
                const brandEl = pick('select[name$=".Brand_id"]');
                const vtEl    = pick('select[name$=".Vehicle_type_id"]');
                const varEl   = pick('select[name$=".Variant_id"]');
                const colorEl = pick('select[name$=".Color_id"]');
                const qtyEl   = pick('input[name$=".Quantity_ordered"]');

                return {
                    Brand_id:         brandEl?.value ? Number(brandEl.value) : 0,
                    Vehicle_type_id:  vtEl?.value    ? Number(vtEl.value)    : 0,
                    Variant_id:       varEl?.value   ? Number(varEl.value)   : 0,
                    Color_id:         colorEl?.value ? Number(colorEl.value) : 0,
                    Quantity_ordered: qtyEl?.value   ? Number(qtyEl.value)   : 0
                };
            }).filter(x => x.Brand_id || x.Vehicle_type_id || x.Variant_id || x.Color_id || x.Quantity_ordered);
        }

        // ---------- Tables ----------
        // const dataTable = initializeTabulator(
        //     "#DeliveryOrderTable",
        //     deliveryOrderData,
        //     generateTabulatorColumns(deliveryOrderData),
        //     (data) => {
        //         selectedRow = data[0] || null;
        //         if (selectedRow && selectedRow.Details) {
        //             childTable.setData(selectedRow.Details);
        //         } else {
        //             childTable.clearData();
        //         }
        //     }
        // );
        const dataTable = new Tabulator("#DeliveryOrderTable", {
                data: deliveryOrderData,
                columns: generateTabulatorColumns(deliveryOrderData),
                  columns: [
                 { title: "Do Number", field: "Do_number", width: 220 },
                 { title: "Customer Name", field: "Customer_name", width: 220 },                 
                 { title: "Delivery Location Name", field: "Delivery_location_name", width: 220 },
                 { title: "Priority", field: "Priority", width: 220 },
                 
             ],
                rowSelectionChanged: function (data) {
                    selectedRow = data[0] || null;

                    if (selectedRow && selectedRow.Details) {
                        childTable.setData(selectedRow.Details);
                    } else {
                        childTable.clearData();
                    }
                },

                layout: "fitDataStretch",
                height: "60vh",
                selectable: 1,
                pagination: "local",
                resizableRows:false,
                resizableRowGuide:false,
                resizableColumnGuide:false,
                columnDefaults:{ resizable:false },
                movableColumns: false,
                paginationSize: 10,
                paginationSizeSelector: [5, 10, 20, 50, 100],

                locale: true,
                langs: {
                    "en": {
                        pagination: {
                            first: "<<",
                            first_title: "First",
                            last: ">>",
                            last_title: "Last",
                            prev: "<",
                            prev_title: "Prev",
                            next: ">",
                            next_title: "Next",
                            page_size: "Page Size"
                        }
                    }
                },

                rowClick: function (e, row) {
                    selectedRow = row.getData();
                }
            });


        childTable.on("dataFiltered", function(filters, rows){
        document.getElementById("recordCount1").innerText = "Total Records: " + rows.length;
      });
      childTable.on("dataLoaded", function(data){
        document.getElementById("recordCount1").innerText = "Total Records: " + data.length;
      });

          dataTable.on("tableBuilt", function(){

        const hideFields = [

                "Do_id",
                "Do_at",
                "Customer_id",
                "Shift_id",
                "Date_of_production",
                "Vehicle_number",
                "Transporter_id",
                "Transporter_name",
                "Driver_name",
                "Driver_contact_no",
                "Delivery_location_id",
                "Delivery_location_code",
                "Delivery_address",
                "Status_id",
                "Status_name",
                "Planned_dispatch_at",
                "Is_deleted",
                "Created_by",
                "Created_at",
                "Updated_by",
                "Updated_at",
                "Actual_dispatch_at",
                "Shift_name",
                "Version",
                "Details",
                "AdditionalProperties"

        ];

        hideFields.forEach(field => dataTable.hideColumn(field));

    });

        function renderChildFor(rowData) {
            const titleEl = document.getElementById("childTitle");
            const details = Array.isArray(rowData?.Details) ? rowData.Details : [];
            childTable.replaceData(details);
            titleEl.textContent = rowData ? `DO Details   "${rowData.Do_number ?? ""}"` : "(select a Delivery Order)";
        }

        dataTable.on("rowClick", function (e, row) {
            dataTable.deselectRow();
            row.select();
        });

        dataTable.on("rowSelectionChanged", function (data) {
            const selected = data.length ? data[0] : null;
            renderChildFor(selected);
        });

        // ---------- Search ----------
        document.getElementById("searchField").addEventListener("input", function () {
            const searchTerm = this.value.toLowerCase();
            const visible = dataTable.getColumns().filter(col => col.isVisible()).map(col => col.getField());
            dataTable.setFilter(function (row) {
                return visible.some(f => {
                    const v = row[f];
                    return v != null && v.toString().toLowerCase().includes(searchTerm);
                });
            });
        });

         // Record count for filtered data
         dataTable.on("dataFiltered", function(filters, rows) {
               updateRecordCount(dataTable, rows, "Do_id");  // Pass the field name >>replace with your table primary id column
         });

         // Record count for loaded data
         dataTable.on("dataLoaded", function(data) {
               updateRecordCount(dataTable, data, "Do_id");  // Pass the field name >>replace with your table primary id column
         });

    //  dataTable.on("tableBuilt", function(){
    //     const hideFields = [

    //             "Created_by",
    //             "Created_at",
    //             "Updated_by",
    //             "Updated_at",
    //             "Version",
    //             "AdditionalProperties"

    //     ];

    //     hideFields.forEach(field => dataTable.hideColumn(field));
    // });
        // ---------- Priority pills ----------
     document.querySelectorAll(".priority-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            // Reset all buttons to default style
            document.querySelectorAll(".priority-btn").forEach(b => {
                b.style.borderColor = "#ccc";
                b.style.color = "inherit";
                b.style.background = "transparent";
                b.classList.remove("active");
            });

            // Set the style for the selected button
            this.style.borderColor = "#b31225";
            this.style.color = "#b31225";
            this.style.background = "rgba(179,18,37,0.1)";
            this.classList.add("active");

            // Set the hidden input value
            document.getElementById("Priority").value = this.dataset.value;

            // Clear any existing error message
            document.getElementById("priorityError").style.display = "none";
        });
    });
        // ---------- Add ----------
        document.getElementById("add-btn").addEventListener("click", () => {
            currentMode = "Add";
            form.reset();
            document.getElementById("addEditModalLabel").textContent = " Add Delivery Order";
            document.getElementById("modalSubmitBtn").textContent = "Add";
            document.getElementById("Do_id").value = 0;
            document.getElementById("screensContainer").innerHTML = "";
            addScreenRow();
            addEditModal.show();
        });

        // ---------- Edit (with dropdown pre-binding) ----------
        // document.getElementById("edit-btn").addEventListener("click", () => {
        //     const row = dataTable.getSelectedData()?.[0];
        //     if (!row) {
        //         return showAppAlert({ icon: 'warning', title: 'No Selection', text: 'Please select a row to edit.' });
        //     }

        //     currentMode = "Edit";
        //     form.reset();
        //     document.getElementById("addEditModalLabel").textContent = "Edit Delivery Order";
        //     document.getElementById("modalSubmitBtn").textContent = "Update";
        //     document.getElementById("screensContainer").innerHTML = "";

        //     // Top fields
        //     Object.keys(row).forEach(field => {
        //         const el = document.getElementById(field);
        //         if (!el) return;
        //         if (el.type === "datetime-local" && row[field]) {
        //             el.value = new Date(row[field]).toISOString().slice(0, 16);
        //         } else {
        //             el.value = row[field] ?? "";
        //         }
        //     });

        //     // Priority
        //     if (row.Priority) {
        //         document.getElementById("Priority").value = row.Priority;
        //         document.querySelectorAll(".priority-btn").forEach(b => {
        //             const active = b.dataset.value === row.Priority;
        //             b.classList.toggle("active", active);
        //             b.style.borderColor = active ? "#b31225" : "#ccc";
        //             b.style.color = active ? "#b31225" : "inherit";
        //             b.style.background = active ? "rgba(179,18,37,0.1)" : "transparent";
        //         });
        //     }

        //     // Details
        //     const details = Array.isArray(row.Details) ? row.Details : [];
        //     if (details.length === 0) addScreenRow();

        //     details.forEach((d, index) => {
        //         addScreenRow(d);

        //         const $brand   = $(`#Details_${index}__Brand_id`);
        //         const $vtype   = $(`#Details_${index}__Vehicle_type_id`);
        //         const $variant = $(`#Details_${index}__Variant_id`);

        //         if (d.Brand_id) {
        //             $.ajax({
        //                 url: '/DeliveryOrder/GetVehicleTypesByBrand',
        //                 type: 'GET',
        //                 data: { brandId: d.Brand_id },
        //                 success: function (vehicleTypes) {
        //                     resetDropdown($vtype, 'Select Vehicle Type');
        //                     populateDropdown($vtype, vehicleTypes, d.Vehicle_type_id);

        //                     if (d.Vehicle_type_id) {
        //                         $.ajax({
        //                             url: '/DeliveryOrder/GetVariantsByVehicleType',
        //                             type: 'GET',
        //                             data: { vehicleTypeId: d.Vehicle_type_id },
        //                             success: function (variants) {
        //                                 resetDropdown($variant, 'Select Vehicle Variant');
        //                                 populateDropdown($variant, variants, d.Variant_id);
        //                             }
        //                         });
        //                     }
        //                 }
        //             });
        //         }

        //         if (d.Color_id) $(`#Details_${index}__Color_id`).val(d.Color_id);
        //         if (d.Quantity_ordered != null) $(`#Details_${index}__Quantity_ordered`).val(d.Quantity_ordered);
        //     });

        //     reindexScreenRows();
        //     addEditModal.show();
        // });

            // ---------- Edit (with dropdown pre-binding) ----------
    document.getElementById("edit-btn").addEventListener("click", () => {
        const row = dataTable.getSelectedData()?.[0];
        if (!row) {
            return showAppAlert({ icon: 'warning', title: 'No Selection', text: 'Please select a row to edit.' });
        }

        currentMode = "Edit";
        form.reset();
        document.getElementById("addEditModalLabel").textContent = "Edit Delivery Order";
        document.getElementById("modalSubmitBtn").textContent = "Update";
        document.getElementById("screensContainer").innerHTML = "";

        // Helper function to format date to YYYY-MM-DD
        function formatDateToInputDate(date) {
            const d = new Date(date);
            return d.toISOString().split('T')[0];
        }

        // Top fields
        Object.keys(row).forEach(field => {
            const el = document.getElementById(field);
            if (!el) return;
            if (el.type === "datetime-local" && row[field]) {
                el.value = new Date(row[field]).toISOString().slice(0, 16); // Handle datetime-local field
            } else if (el.type === "date" && row[field]) {
                // Handle date fields (Do_at and Planned_dispatch_at)
                el.value = formatDateToInputDate(row[field]);
            } else {
                el.value = row[field] ?? "";
            }
        });

        // Manually set the date values for Do_at and Planned_dispatch_at
        if (row.Do_at) {
            document.getElementById("Do_at").value = formatDateToInputDate(row.Do_at);
        }
        if (row.Planned_dispatch_at) {
            document.getElementById("Planned_dispatch_at").value = formatDateToInputDate(row.Planned_dispatch_at);
        }

        // Priority
        if (row.Priority) {
            document.getElementById("Priority").value = row.Priority;
            document.querySelectorAll(".priority-btn").forEach(b => {
                const active = b.dataset.value === row.Priority;
                b.classList.toggle("active", active);
                b.style.borderColor = active ? "#b31225" : "#ccc";
                b.style.color = active ? "#b31225" : "inherit";
                b.style.background = active ? "rgba(179,18,37,0.1)" : "transparent";
            });
        }

        // Details
        const details = Array.isArray(row.Details) ? row.Details : [];
        if (details.length === 0) addScreenRow();

        details.forEach((d, index) => {
            addScreenRow(d);

            const $brand   = $(`#Details_${index}__Brand_id`);
            const $vtype   = $(`#Details_${index}__Vehicle_type_id`);
            const $variant = $(`#Details_${index}__Variant_id`);

            if (d.Brand_id) {
                $.ajax({
                    url: '/DeliveryOrder/GetVehicleTypesByBrand',
                    type: 'GET',
                    data: { brandId: d.Brand_id },
                    success: function (vehicleTypes) {
                        resetDropdown($vtype, 'Select Vehicle Type');
                        populateDropdown($vtype, vehicleTypes, d.Vehicle_type_id);

                        if (d.Vehicle_type_id) {
                            $.ajax({
                                url: '/DeliveryOrder/GetVariantsByVehicleType',
                                type: 'GET',
                                data: { vehicleTypeId: d.Vehicle_type_id },
                                success: function (variants) {
                                    resetDropdown($variant, 'Select Vehicle Variant');
                                    populateDropdown($variant, variants, d.Variant_id);
                                }
                            });
                        }
                    }
                });
            }

            if (d.Color_id) $(`#Details_${index}__Color_id`).val(d.Color_id);
            if (d.Quantity_ordered != null) $(`#Details_${index}__Quantity_ordered`).val(d.Quantity_ordered);
        });

        reindexScreenRows();
        addEditModal.show();
    });



        // ---------- Delete ----------
        document.getElementById("delete-btn").addEventListener("click", async () => {
            const row = dataTable.getSelectedData()?.[0];
            if (!row) {
                return showAppAlert({ icon: "warning", title: "No Selection", text: "Please select a row to delete." });
            }

            const confirm = await showAppAlert({
                type: "confirm",
                icon: "question",
                title: "Delete Confirmation",
                text: "Are you sure you want to delete this record?"
            });

            if (!confirm.isConfirmed) return;

            const ok = await deleteRecord("/DeliveryOrder/Delete", { Do_number: row.Do_number });
            if (ok) {
                setTimeout(() => { window.location.href = "/DeliveryOrder/Index"; }, 900);
            }
        });

        // // ---------- Submit (Add/Edit) ----------
        // form.addEventListener("submit", async (e) => {
        //     e.preventDefault();

        //     const formData = Object.fromEntries(new FormData(form).entries());
        //     formData.Priority = document.getElementById("Priority").value || formData.Priority;
        //     formData.Details = collectDetailsFromForm();

        //     const fetchUrl = currentMode === "Add" ? "/DeliveryOrder/Create" : "/DeliveryOrder/Update";
        //     const ok = await saveRecord(fetchUrl, formData, currentMode, addEditModal, form);
        //     if (ok) {
        //         setTimeout(() => { window.location.href = "/DeliveryOrder/Index"; }, 900);
        //     }
        // });

            form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Check if the Priority is selected
        const priority = document.getElementById("Priority").value;
        if (!priority) {
            // Show the error message if no priority is selected
            document.getElementById("priorityError").style.display = "inline";

            // Optionally, flash or highlight the buttons (UI feedback)
            document.querySelectorAll(".priority-btn").forEach(b => {
                b.style.borderColor = "red"; // Flash red border
            });

            // Focus on the first priority button for better UX
            document.querySelector(".priority-btn").focus();
            return; // Stop form submission
        }

        // Continue with the form data collection and submission if validation passes
        const formData = Object.fromEntries(new FormData(form).entries());
        formData.Priority = priority || formData.Priority;
        formData.Details = collectDetailsFromForm();

        const fetchUrl = currentMode === "Add" ? "/DeliveryOrder/Create" : "/DeliveryOrder/Update";
        const ok = await saveRecord(fetchUrl, formData, currentMode, addEditModal, form);
        if (ok) {
            setTimeout(() => { window.location.href = "/DeliveryOrder/Index"; }, 900);
        }
    });

        // ---------- Downloads / Uploads ----------

    document.getElementById("download-btn").addEventListener("click", function () {
        // Assuming dataTable is the table holding Delivery Order data
        const deliveryData = dataTable.getData(); // All delivery orders
        if (!deliveryData || deliveryData.length === 0) {
            return showAppAlert({
                icon: "info",
                title: "No Data",
                text: "There is no data to download."
            });
        }

        // Flatten Delivery Order → Details (including Brand, Vehicle Type, etc.)
        const flattenedData = [];
        deliveryData.forEach(order => {
            const details = order.Details || []; // Assuming each delivery order has a 'Details' array

            if (details.length === 0) {
                // Delivery Order with no details
                flattenedData.push({
                    DoNumber: order.Do_number,
                    OrderDate: order.Do_at,
                    PlannedDispatchDate: order.Planned_dispatch_at,
                    DealerName: order.Customer_id,
                    DeliveryLocation: order.Delivery_location_id,
                    Priority: order.Priority,
                    // Empty columns for details
                    Brand: "",
                    VehicleType: "",
                    Variant: "",
                    Color: "",
                    QuantityOrdered: ""
                });
            } else {
                details.forEach(detail => {
                    flattenedData.push({
                        DoNumber: order.Do_number,
                        OrderDate: order.Do_at,
                        PlannedDispatchDate: order.Planned_dispatch_at,
                        DealerName: order.Customer_id,
                        DeliveryLocation: order.Delivery_location_id,
                        Priority: order.Priority,
                        Brand: detail.Brand_id, // Assuming this is the Brand ID
                        VehicleType: detail.Vehicle_type_id, // Assuming this is the Vehicle Type ID
                        Variant: detail.Variant_id, // Assuming this is the Variant ID
                        Color: detail.Color_id, // Assuming this is the Color ID
                        QuantityOrdered: detail.Quantity_ordered
                    });
                });
            }
        });

        if (flattenedData.length === 0) {
            return showAppAlert({
                icon: "info",
                title: "Empty",
                text: "No valid data to export."
            });
        }

        // Convert the flattened data to CSV
        const headers = Object.keys(flattenedData[0]);
        const csv = [
            headers.join(","), // header row
            ...flattenedData.map(row =>
                headers.map(h => `"${(row[h] ?? "").toString().replace(/"/g, '""')}"`).join(",")
            )
        ].join("\n");

        // Trigger file download
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "DeliveryOrderDetails.csv"; // Set the download file name
        link.click();
    });
    // document.getElementById("download-template-btn").addEventListener("click", () =>
    //         downloadCsvTemplate(dataTable, "DeliveryOrderTemplate")
    //     );

       // // Upload (CSV)
       //  function getRequestVerificationToken() {
       //      const tokenInput = document.querySelector('#afForm input[name="__RequestVerificationToken"]');
       //      return tokenInput ? tokenInput.value : null;
       //  }



       //  document.getElementById("upload-file").addEventListener("change", function (event) {
       //      const fileInput = event.target;
       //      if (!fileInput.files || fileInput.files.length === 0) {
       //          return showAppAlert({ icon: 'warning', title: 'No File', text: 'Please select a file to upload.' });
       //      }
       //      const file = fileInput.files[0];

       //      const extOk = /\.csv$/i.test(file.name);
       //      const type = (file.type || '').toLowerCase();
       //      const typeOk = type.includes('csv') || type === 'application/vnd.ms-excel';
       //      if (!extOk && !typeOk) {
       //          showAppAlert({ icon: 'warning', title: 'Invalid File', text: 'Please select a .csv file.' });
       //          fileInput.value = '';
       //          return;
       //      }

       //      uploadFile('/DeliveryOrder/Upload', file);
       //  });

       //  async function uploadFile(url, file) {
       //      const formData = new FormData();
       //      formData.append("file", file);
       //      console.log("Uploading file:", file.name);


       //      const csrfToken = getRequestVerificationToken();

       //      try {
       //          const response = await fetch(url, {
       //              method: 'POST',
       //              headers: { 'RequestVerificationToken': csrfToken },
       //              body: formData
       //          });
       //          await handleUploadResponse(response);
       //      } catch (error) {
       //          showToast({ icon: "error", text: error.message || "Action failed" });
       //      }
       //  }

       //  async function handleUploadResponse(response) {
       //    if (response.ok) {
       //      const result = await response.json();
       //      // showAppAlert({ icon: 'success', title: result.title, text: result.message });
       //        showAppAlert({ icon: result.status, title: result.title, text: result.message });
       //      if (result.invalidRecords) downloadInvalidRecords(result.invalidRecords);

       //      if (result.status === "success") {
       //        setTimeout(() => { window.location.href = "/DeliveryOrder/Index"; }, 900);
       //      }
       //    } else {
       //      let title = "Upload Failed", text = "An unexpected error occurred.";
       //      try {
       //        const err = await response.json();
       //        title = err.title || title;
       //        text = err.message || text;
       //        if (err.status === "error") {
       //          setTimeout(() => { window.location.href = "/DeliveryOrder/Index"; }, 1500);
       //        }
       //      } catch (_) { /* ignore JSON parse errors */ }
       //      showAppAlert({ icon: 'error', title, text });
       //    }
       //  }

       //  function downloadInvalidRecords(fileData) {
       //      const csvData = atob(fileData);
       //      const blob = new Blob([csvData], { type: 'text/csv' });
       //      const link = document.createElement('a');
       //      link.href = URL.createObjectURL(blob);
       //      link.download = 'invalid_records.csv';
       //      link.click();
       //  }


        // ---------- Dependent dropdowns (delegated, single definition) ----------
        // Brand -> VehicleType
        $(document).on('change', '[id^="Details_"][id$="__Brand_id"]', function () {
            const $brand = $(this);
            const rowDiv = $brand.closest('.screen-row');
            const brandId = $brand.val();
            const rowIndex = rowDiv.data('row-index');

            const $vtype   = rowDiv.find(`#Details_${rowIndex}__Vehicle_type_id`);
            const $variant = rowDiv.find(`#Details_${rowIndex}__Variant_id`);

            resetDropdown($vtype, 'Select Vehicle Type');
            resetDropdown($variant, 'Select Vehicle Variant');

            if (brandId) {
                $.ajax({
                    url: '/DeliveryOrder/GetVehicleTypesByBrand',
                    type: 'GET',
                    data: { brandId },
                    success: function (data) {
                        populateDropdown($vtype, data);
                    },
                    error: function () {
                        alert('Failed to load Vehicle Types');
                    }
                });
            }
        });

        // VehicleType -> Variant
        $(document).on('change', '[id^="Details_"][id$="__Vehicle_type_id"]', function () {
            const $vtype = $(this);
            const rowDiv = $vtype.closest('.screen-row');
            const vehicleTypeId = $vtype.val();
            const rowIndex = rowDiv.data('row-index');

            const $variant = rowDiv.find(`#Details_${rowIndex}__Variant_id`);
            resetDropdown($variant, 'Select Vehicle Variant');

            if (vehicleTypeId) {
                $.ajax({
                    url: '/DeliveryOrder/GetVariantsByVehicleType',
                    type: 'GET',
                    data: { vehicleTypeId },
                    success: function (data) {
                        populateDropdown($variant, data);
                    },
                    error: function () {
                        alert('Failed to load Vehicle Variants');
                    }
                });
            }
        });

        // Add detail row button
        document.getElementById("addScreenBtn").addEventListener("click", () => addScreenRow());
    });
</script>
