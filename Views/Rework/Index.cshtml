@using Microsoft.AspNetCore.Mvc.Rendering
@{
    //  Read JSON payload for grid from ViewData
    var reworkMasterData = ViewData["ReworkData"] ?? "[]";
    // set layout
    Layout = "_Layout";
}

<head>
    <!--  Keep head empty as per request (no changes to assets/includes) -->
</head>
<div class="container">

    <!------- Page Title Section ------->
@*     <div id="pageTitle" class="col-12 text-center py-1 mb-3">
        <!-- Page heading -->
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Rework Master</h6>
    </div> *@
    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Rework Master</h6>
    </div>
    <!------- Toolbar: Search + Actions ------->
    <div class="row align-items-center mb-3">

        <!-- Spacer on xs devices -->
        <div class="w-100 d-md-none"></div>

        <!-- Right-aligned toolbar container -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

            <!-- Search input -->
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;" />

            <!-- Action buttons group -->
            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">

                <!-- Add -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <!-- Edit -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <!-- Delete -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <!-- Download -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <!-- Upload -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <!-- Download Template -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <!------- Hidden file input for CSV upload ------->
    <form id="afForm" style="display:none" method="post">
        @Html.AntiForgeryToken()
        <input type="file" id="upload-file" style="display:none" accept=".csv,text/csv" />
    </form>


    <!------- Data grid + record count ------->
    <div id="reworkTable" class="tabulator-bootstrap5"></div>
    <div id="recordCount" class="text-end mt-2 fw-semibold text-secondary"></div>
</div>

<!------- Add/Edit Modal ------->
<div class="modal fade" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <!-- Modal header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Rework Master</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>

            <!-- Modal body with form -->
            <div class="modal-body">
                <form id="addEditForm">
                    <!-- Hidden primary key -->
                    <input type="hidden" id="Rework_production_id" name="Id" />

                    <!-- Form grid -->
                    <div class="row g-3">

                        <!-- Brand and Vehicle type in one row -->
                        <div class="col-md-6">
                            <label class="form-label">Brand  <span class="text-danger"><strong>*</strong></span></label>
                            <select class="form-select" id="Brand_id" name="Brand_id" asp-items="@(ViewBag.BrandList as IEnumerable<SelectListItem>)" required>
                                <option value="" selected disabled>Select Brand</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="Vehicle_type_id" class="form-label">Vehicle Type  <span class="text-danger"><strong>*</strong></span></label>
                            <select class="form-select" id="Vehicle_type_id" name="Vehicle_type_id" required>
                                <option value="" selected disabled>Select Type</option>
                            </select>
                        </div>

                        <!-- Variant and VIN in one row -->
                        <div class="col-md-6">
                            <label for="Variant_id" class="form-label">Variant  <span class="text-danger"><strong>*</strong></span></label>
                            <select class="form-select" id="Variant_id" name="Variant_id" required>
                                <option value="" selected disabled>Select Variant</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="Vin" class="form-label">VIN  <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text"
                                   class="form-control"
                                   id="Vin"
                                   name="Vin"
                                   minlength="17"
                                   maxlength="17"
                                   required
                                   pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z0-9]{17}$"
                                   inputmode="latin-prose"
                                   title="VIN must be exactly 17 characters and contain both letters and numbers.">
                        </div>

                        <!-- Line ID and Rework Quality Inspector ID in one row -->
                        <div class="col-md-6">
                            <label for="Rework_bay_id" class="form-label">Rework Bay ID  <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text"
                                   class="form-control"
                                   id="Rework_bay_id"
                                   name="Rework_bay_id"
                                   maxlength="50"
                                   required
                                   pattern="^[A-Za-z0-9 ]+$"
                                   inputmode="text"
                                   title="Only letters,spaces and numbers are allowed (no special characters).">
                        </div>

                        <div class="col-md-6" id="hiddenfeilds" hidden>
                            <label for="Rework_quality_inspector_id" class="form-label">Rework Quality Inspector ID  <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text"
                                   class="form-control"
                                   id="Rework_quality_inspector_id"
                                   name="Rework_quality_inspector_id"
                                   value="0"
                                   maxlength="50"
                                   pattern="^[A-Za-z0-9 ]+$"
                                   inputmode="text"
                                   required
                                   title="Only letters,spaces and numbers are allowed (no special characters).">
                        </div>

                       @*  <!-- Completion Timestamp and Rework Status in one row -->
                        <div class="col-md-6" id="hiddenfeilds1" hidden>
                            <label for="Completion_at" class="form-label">Completion Timestamp</label>
                            <input type="datetime-local"
                                   class="form-control"

                                   id="Completion_at"
                                   name="completion_at">
                        </div> *@

                        <div class="col-md-6">
                            <label class="form-label">Rework Status  <span class="text-danger"><strong>*</strong></span></label>
                            <select class="form-select" id="Quality_status_id" name="Quality_status_id" asp-items="@(ViewBag.ReworkStatusList as IEnumerable<SelectListItem>)" required>
                                <option value="">Select Status</option>
                            </select>
                        </div>

                    </div>

                </form>
            </div>

            <!-- Modal footer with actions -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary-professional" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary-professional" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>



<script>
   
    // Server-driven dependent dropdowns on user change
    document.getElementById('Brand_id').addEventListener('change', function () {
        const brandId = this.value;
        fetch(`/Rework/GetVehicleType?brandId=${brandId}`)
            .then(res => {
                if (!res.ok) throw new Error("Network error while loading vehicle types");
                return res.json();
            })
            .then(data => {
                populateDropdown('Vehicle_type_id', data.vehicletypeList, 'Select Type');
                // clear variant too
                populateDropdown('Variant_id', [], 'Select Variant');
            })
            .catch(err => console.error("Error fetching vehicle types:", err));
    });

    document.getElementById('Vehicle_type_id').addEventListener('change', function () {
        const vehicleTypeId = this.value;
        fetch(`/Rework/GetVariant?vehicleTypeId=${vehicleTypeId}`)
            .then(res => {
                if (!res.ok) throw new Error("Network error while loading vehicle variant");
                return res.json();
            })
            .then(data => {
                populateDropdown('Variant_id', data.variantList, 'Select Variant');
            })
            .catch(err => console.error("Error fetching vehicle variant:", err));
    });

    // Helper: fill any dropdown by id with items: [{id, name}]
    function populateDropdown(dropdownId, items, defaultText) {
        const dropdown = document.getElementById(dropdownId);
        dropdown.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.text = defaultText;
        defaultOption.value = '';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        dropdown.appendChild(defaultOption);

        if (items && items.length > 0) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;   // ensure these keys match your API
                option.text = item.name;
                dropdown.appendChild(option);
            });
        }
    }

    // ---------- NEW HELPERS FOR BINDING SELECTED ROW ----------
    function ensureOption(selectEl, value, label) {
        const val = String(value ?? "");
        if (!val) return;
        let opt = selectEl.querySelector(`option[value="${CSS.escape(val)}"]`);
        if (!opt) {
            opt = document.createElement('option');
            opt.value = val;
            opt.textContent = label ?? val;
            selectEl.appendChild(opt);
        }
    }

    async function fetchVehicleTypes(brandId) {
        const res = await fetch(`/Rework/GetVehicleType?brandId=${encodeURIComponent(brandId)}`);
        if (!res.ok) throw new Error("Failed to load vehicle types");
        const data = await res.json();
        return data.vehicletypeList ?? [];
    }

    async function fetchVariants(vehicleTypeId) {
        const res = await fetch(`/Rework/GetVariant?vehicleTypeId=${encodeURIComponent(vehicleTypeId)}`);
        if (!res.ok) throw new Error("Failed to load variants");
        const data = await res.json();
        return data.variantList ?? [];
    }

    function setOptions(selectEl, items, placeholderText) {
        selectEl.innerHTML = "";
        const ph = document.createElement("option");
        ph.value = "";
        ph.textContent = placeholderText;
        ph.disabled = true;
        ph.selected = true;
        selectEl.appendChild(ph);
        (items || []).forEach(it => {
            const o = document.createElement("option");
            o.value = String(it.id);
            o.textContent = it.name;
            selectEl.appendChild(o);
        });


    }

    async function bindDropdownsFromRow(row) {
        const brandSel   = document.getElementById("Brand_id");
        const typeSel    = document.getElementById("Vehicle_type_id");
        const variantSel = document.getElementById("Variant_id");
        
      

        // Map row fields (adjust keys if needed)
        const brandId       = row.Brand_id;
        const brandName     = row.Brand_name;
        const vehicleTypeId = row.Vehicle_type_id;
        const vehicleTypeNm = row.Vehicle_type_name || row.Vehicle_type;
        const variantId     = row.Variant_id;
        const variantName   = row.Variant_name || row.Variant;
       
        

        // 1) Brand
        ensureOption(brandSel, brandId, brandName);
        brandSel.value = String(brandId ?? "");

        // 2) Vehicle Types (by brand)
        setOptions(typeSel, [], "Loading types…");
        const types = brandId ? await fetchVehicleTypes(brandId) : [];
        setOptions(typeSel, types, "Select Type");
        if (vehicleTypeId) ensureOption(typeSel, vehicleTypeId, vehicleTypeNm);
        typeSel.value = String(vehicleTypeId ?? "");

        // 3) Variants (by vehicle type)
        setOptions(variantSel, [], "Loading variants…");
        const variants = vehicleTypeId ? await fetchVariants(vehicleTypeId) : [];
        setOptions(variantSel, variants, "Select Variant");
        if (variantId) ensureOption(variantSel, variantId, variantName);
        variantSel.value = String(variantId ?? "");
  
    }
     // Helper function to reset a select element with placeholder
    function resetSelect(selectEl, placeholder) {
        selectEl.innerHTML = ""; // remove all options
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = placeholder;
        opt.disabled = true;
        opt.selected = true;
        selectEl.appendChild(opt);
    }



    // ---------- PAGE BOOT ----------
    document.addEventListener("DOMContentLoaded", () => {
        // Initialize reusable components
        initTooltips();

        const reworkMasterData = JSON.parse('@Html.Raw(reworkMasterData)');
        let selectedRow = null;
        let currentMode = "";

        // Init grid
        const dataTable = initializeTabulator("#reworkTable", reworkMasterData, generateTabulatorColumns(reworkMasterData),
            (data) => selectedRow = data[0] || null
        );

        // Search
        document.getElementById("searchField").addEventListener("input", function () {
            var searchTerm = this.value.toLowerCase();
            var visibleColumns = dataTable.getColumns().filter(col => col.isVisible()).map(col => col.getField());
            dataTable.setFilter(function (data) {
                return visibleColumns.some(field => {
                    var value = data[field];
                    return value != null && value.toString().toLowerCase().includes(searchTerm);
                });
            });
        });

        // // Record count
        // dataTable.on("dataFiltered", function(filters, rows){
        //     document.getElementById("recordCount").innerText = "Total Records: " + rows.length;
        // });
        // dataTable.on("dataLoaded", function(data) {
        //     document.getElementById("recordCount").innerText = "Total Records: " + data.length;
        // });
         // Record count for filtered data
     dataTable.on("dataFiltered", function(filters, rows) {
           updateRecordCount(dataTable, rows, "Rework_production_id");  // Pass the field name >>replace with your table primary id column
     });

     // Record count for loaded data
     dataTable.on("dataLoaded", function(data) {
           updateRecordCount(dataTable, data, "Rework_production_id");  // Pass the field name >>replace with your table primary id column
     });

        dataTable.on("tableBuilt", function(){
            const hideFields = [
                   
            ];

        hideFields.forEach(field => dataTable.hideColumn(field));
    });
       dataTable.on("tableBuilt", function() {
            // List of columns to hide
            const hideFields = [
                 "Rework_production_id",
                    "Shift_id",
                    "Shift_name",
                    "Color_name",
                    "Transit_status",
                    "Transit_status",
                    "Production_order_id",
                    "Date_of_production",
                    "Batch_lot_number",
                    "Product_description",
                    "Rework_quality_inspector_name",
                    "Color_id",
                    "Brand_id",
                    "Certificate_id",
                    "Shop_id",
                    "Vehicle_type_id",
                    "Quality_status_id",
                    "Variant_id",
                    "Completion_at",
                    "Updated_by",
                    "Is_deleted",
                    "Created_at",
                    "Updated_at",
                    "Version",
                    "AdditionalProperties"
            ];

            // Define new column names for renaming
            const columnRenameMap = {
                "Vin": "VIN",
                "Rework_bay_id": "Rework Bay ID",
                "Rework_quality_inspector_id":"Rework Quality Inspector ID"
                

            };

            // Hide columns
            hideFields.forEach(field => {
                dataTable.hideColumn(field);  // Tabulator's method to hide columns
            });

            // Rename specified columns based on the columnRenameMap
            Object.keys(columnRenameMap).forEach(field => {
                const column = dataTable.getColumn(field);  // Tabulator's method to get column by field name

                if (column) {
                    column.updateDefinition({
                        title: columnRenameMap[field]  // Update the column title (header)
                    });
                } else {
                    console.log(`Column '${field}' not found.`);
                }
            });
        });

     


        // Modal + form
        const addEditModalEl = document.getElementById('addEditModal');
        const addEditModal = new bootstrap.Modal(addEditModalEl);
        const form = document.getElementById("addEditForm");

        // Add
        document.getElementById("add-btn").addEventListener("click", () => {
            currentMode = "Add";
            form.reset();

            const typeSel    = document.getElementById("Vehicle_type_id");
            const variantSel = document.getElementById("Variant_id");

            resetSelect(typeSel, "Select Type");
            resetSelect(variantSel, "Select Variant");
         

            document.getElementById("addEditModalLabel").textContent = "Add Rework Master";
            document.getElementById("modalSubmitBtn").textContent = "Add";
            document.getElementById("Rework_production_id").value = 0;

            // enable identifiers
            document.getElementById("Brand_id").disabled = false;
            document.getElementById("Vehicle_type_id").disabled = false;
            document.getElementById("Variant_id").disabled = false;
            document.getElementById("Vin").disabled = false;
            document.getElementById("Rework_bay_id").disabled = false;
            document.getElementById("hiddenfeilds").hidden = true;
           
            addEditModal.show();
        });

        // Edit
        document.getElementById("edit-btn").addEventListener("click", async () => {
            const row = dataTable.getSelectedData()?.[0];
            if (!row) {
                return showAppAlert({ icon: 'warning', title: 'No Selection', text: 'Please select a row to edit.' });
            }

            currentMode = "Edit";
            document.getElementById("addEditModalLabel").textContent = "Edit Rework Master";
            document.getElementById("modalSubmitBtn").textContent = "Update";

            // Fill simple inputs
            Object.keys(row).forEach(field => {
                const el = document.getElementById(field);
                if (!el) return;
                if (el.type === "datetime-local" && row[field]) {
                    el.value = new Date(row[field]).toISOString().slice(0,16);
                } else {
                    el.value = row[field] ?? "";
                }
            });

            // ✅ Bind cascading dropdowns in correct async order
            await bindDropdownsFromRow(row);

            // Optional: lock identifiers in Edit
            document.getElementById("Brand_id").disabled = true;
            document.getElementById("Vin").disabled = true;
            document.getElementById("Vehicle_type_id").disabled = true;
            document.getElementById("Variant_id").disabled = true; 
            document.getElementById("Rework_bay_id").disabled = true;
            document.getElementById("hiddenfeilds").hidden = false;
            document.getElementById("Rework_quality_inspector_id").disabled = false;
           
            addEditModal.show();
        });

        // Delete
        document.getElementById("delete-btn").addEventListener("click", async () => {
            const row = dataTable.getSelectedData()?.[0];
            if (!row) {
                return showAppAlert({ icon: "warning", title: "No Selection", text: "Please select a row to delete." });
            }

            // if (row.Quality_status_id != 0) {
            //     showToast({ icon: "error", text: "This Rework record is currently in use and cannot be deleted." });
            //     return;
            // }

            const confirm = await showAppAlert({
                type: "confirm",
                icon: "question",
                title: "Delete Confirmation",
                text: "Are you sure you want to delete this record?"
            });
            if (!confirm.isConfirmed) return;

            const success = await deleteRecord("/Rework/Delete", { Vin: row.Vin });
            if (success) setTimeout(() => { window.location.href = "/Rework/Index"; }, 900);
        });

        // Submit (Add/Edit)
        form.addEventListener("submit", async (e) => {
          
            e.preventDefault();

                // Disable hidden inputs in Add mode to prevent validation errors
            if (currentMode === "Add") {
                form.querySelectorAll('#hiddenfeilds input').forEach(input => {
                    input.disabled = true;   // prevents validation
                    input.removeAttribute('required'); // extra safety
                });
            } else {
                // Enable them for Edit mode
                form.querySelectorAll('#hiddenfeilds input').forEach(input => {
                    input.disabled = false;
                    input.setAttribute('required', '');  // Re-enable validation
                });
            }

    // Collect form data including enabled/disabled fields correctly
            const formData = Object.fromEntries(new FormData(form).entries());

            // Include any remaining disabled fields manually if needed (e.g., if hidden)
            if (currentMode !== "Add") {
                form.querySelectorAll(':disabled').forEach(field => {
                    if (field.name && field.type !== "hidden") {
                        formData[field.name] = field.value;
                    }
                });
            }

            console.log(formData);
            const fetchUrl = currentMode === "Add" ? "/Rework/Create" : "/Rework/Update";
            const success = await saveRecord(fetchUrl, formData, currentMode, addEditModal, form);
            if (success) setTimeout(() => { window.location.href = "/Rework/Index"; }, 900);
        });

        // // Download / Template
        // document.getElementById("download-btn").addEventListener("click", () => {
        //     const rowCount = dataTable.getDataCount ? dataTable.getDataCount() : dataTable.getData().length;

        //     if (rowCount === 0) {
        //         showAppAlert({
        //             icon: 'warning',
        //             title: 'No Data',
        //             text: 'No records found to download.'
        //         });
        //         return; // Stop further execution
        //     }
        //     downloadCsv(dataTable, "Rework.csv");

        // });

              document.getElementById("download-btn").addEventListener("click", function () {

       let rowCount = dataTable.getDataCount ? dataTable.getDataCount() : dataTable.getData().length;

     if (rowCount === 1) {
         let firstRowData = dataTable.getData()[0];
         let firstRowFieldValue = firstRowData ? firstRowData["Rework_production_id"] : null;
         if (firstRowFieldValue === null || firstRowFieldValue === 0 || firstRowFieldValue === "") {
             rowCount = 0;
         }
     }
     if (rowCount === 0) {
         showAppAlert({
             icon: 'warning',
             title: 'No Data',
             text: 'No records found to download.'
         });
         return; // Stop further execution
     }

        downloadCsv(dataTable, "Rework.csv");
    });

        document.getElementById("download-template-btn").addEventListener("click", () =>
            downloadCsvTemplate(dataTable, "ReworkTemplate")
        );

        // Upload (CSV)
        function getRequestVerificationToken() {
            const tokenInput = document.querySelector('#afForm input[name="__RequestVerificationToken"]');
            return tokenInput ? tokenInput.value : null;
        }

        document.getElementById("upload-btn").addEventListener("click", () => {
            document.getElementById("upload-file").click();
        });

        document.getElementById("upload-file").addEventListener("change", function (event) {
            const fileInput = event.target;
            if (!fileInput.files || fileInput.files.length === 0) {
                return showAppAlert({ icon: 'warning', title: 'No File', text: 'Please select a file to upload.' });
            }
            const file = fileInput.files[0];

            const extOk = /\.csv$/i.test(file.name);
            const type = (file.type || '').toLowerCase();
            const typeOk = type.includes('csv') || type === 'application/vnd.ms-excel';
            if (!extOk && !typeOk) {
                showAppAlert({ icon: 'warning', title: 'Invalid File', text: 'Please select a .csv file.' });
                fileInput.value = '';
                return;
            }

            uploadFile('/Rework/Upload', file);
        });

        async function uploadFile(url, file) {
            const formData = new FormData();
            formData.append("file", file);

            const csrfToken = getRequestVerificationToken();

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': csrfToken },
                    body: formData
                });
                await handleUploadResponse(response);
            } catch (error) {
                showToast({ icon: "error", text: error.message || "Action failed" });
            }
        }

       async function handleUploadResponse(response) {
          if (response.ok) {
            const result = await response.json();
            // showAppAlert({ icon: 'success', title: result.title, text: result.message });
              showAppAlert({ icon: result.status, title: result.title, text: result.message });
              setTimeout(() => { window.location.href = "/Rework/Index"; }, 900);
            if (result.invalidRecords) downloadInvalidRecords(result.invalidRecords);

            if (result.status === "success") {
              setTimeout(() => { window.location.href = "/Rework/Index"; }, 900);
            }
          } else {
            let title = "Upload Failed", text = "An unexpected error occurred.";
            try {
              const err = await response.json();
              title = err.title || title;
              text = err.message || text;
              if (err.status === "error") {
                setTimeout(() => { window.location.href = "/Rework/Index"; }, 1500);
              }
            } catch (_) { /* ignore JSON parse errors */ }
            showAppAlert({ icon: 'error', title, text });
            setTimeout(() => { window.location.href = "/Rework/Index"; }, 900);
          }
          setTimeout(() => { window.location.href = "/Rework/Index"; }, 900);
        }

        function downloadInvalidRecords(fileData) {
            const csvData = atob(fileData);
            const blob = new Blob([csvData], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'invalid_records.csv';
            link.click();
        }
       
    });
</script>
