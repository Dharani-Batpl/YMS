
@model YardManagementApplication.Models.ShiftCalendarViewModel
@{
    Layout = "_Layout";
}

<style>
/* -------------------------------------------------------------
   GLOBAL LAYOUT
------------------------------------------------------------- */
.main-container { margin: 0 5px !important; }
#calendar { max-height: 600px; }

/* Inputs / Dropdowns */
.form-label { font-size: .80rem; font-weight: 600; }
.form-select-sm, .form-control-sm {
    padding: 3px 6px !important;
    height: 36px !important;
    border-radius: 4px !important;
}

/* Buttons */
.btn-sm { height: 32px; font-size: .8rem; }
.freq-btn {
    width: 44px; height: 36px; padding: 0;
    text-align: center; font-weight: 600;
    border-radius: 6px;
}
.freq-btn.active { background:#0d6efd!important; color:white!important; }

/* Modal */
.modal-request .btn-close { filter: invert(1); width:36px; height:36px; }

/* Shift Detail Box */
.shift-detail, #shiftDetailsPanel {
    padding: 12px; border-radius: 6px;
    border: 1px solid #e2e2e2;
}
#shiftDetailsPanel { background:#f8f8f8!important; }
#shiftDetailsContent {
    background:white!important;
    border-radius:6px; padding:15px;
    border:1px solid #e1e1e1;
}

/* Legend */
.calendar-legend-container {
    display:flex; gap:18px; align-items:center;
    font-size:.85rem; padding-left:4px;
}
.legend-item { display:flex; align-items:center; gap:6px; }
.legend-color {
    width:14px; height:14px; border-radius:4px;
    border:1px solid #999;
}

/* Icons inside Inputs */
.input-icon-box { position:relative; }
.input-icon-box i {
    position:absolute; left:12px; top:50%;
    transform:translateY(-50%);
    font-size:18px; color:#6b7280;
}
.input-icon-box input { padding-left:38px!important; }

/* -------------------------------------------------------------
   FULLCALENDAR
------------------------------------------------------------- */

/* Header */
.fc-col-header-cell {
    background:#7e7e7b!important;
    border-bottom:1px solid #d7d7d7!important;
    font-weight:700!important; font-size:14px!important;
    color:white!important; padding:12px 0!important;
}
.fc-col-header-cell-cushion {
    color:white!important; text-decoration:none!important;
    letter-spacing:.3px!important;
}

/* Remove thin borders */
.fc .fc-daygrid-day-top,
.fc .fc-daygrid-day-frame,
.fc .fc-daygrid-day-events { border:none!important; }

/* Date numbers */
.fc-daygrid-day-number {
    font-size:13px!important; font-weight:500!important;
    color:#6b6b6b!important; padding:6px!important;
}
.fc-daygrid-day-top a { text-decoration:none!important; }

/* Borders */
.fc-theme-standard td, .fc-theme-standard th {
    border-color:#e9e9e9!important;
}

/* Today highlight */
.fc-day-today { background:#fff7e1!important; border-radius:2px!important; }

/* Events wrap */
.fc-daygrid-event, .fc-event-title {
    white-space:normal!important;
    height:auto!important;
    overflow:visible!important;
    word-break:break-word!important;
}

/* Holiday Pills */
.fc-event-holiday {
    background:#e8f2ff!important;
    border:1px solid #6aa6f8!important;
    color:#094a8f!important;
    padding:2px 6px!important;
    border-radius:6px!important;
    font-size:11px!important;
    font-weight:600!important;
    text-align:center!important;
}

/* Template Tag */
.fc-event-template {
    background:#AA2F33!important;
    border:1px solid #b7cdfc!important;
    color:#003a9b!important;
    padding:3px 8px!important;
    border-radius:6px!important;
    font-size:12px!important;
    font-weight:600!important;
    text-align:center!important;
}

/* Click cursor */
.fc-daygrid-day { cursor:pointer!important; }

</style>

<div class="main-container">

    <div class="col-12 text-center py-1 mb-3" style="background:#242424;color:white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">SHIFT CALENDAR</h6>
    </div>

    <!-- Filters Row -->
    <div class="row g-2 align-items-end mb-3">

        <div class="col-xl-2 col-lg-3 col-md-3">
            <label class="form-label">Select Plant</label>
            <select id="plantDropdown" class="form-select form-select-sm"></select>
        </div>

        <div class="col-xl-3 col-lg-3 col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control form-control-sm" />
        </div>

        <div class="col-xl-3 col-lg-3 col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control form-control-sm" />
        </div>

        <div class="col-xl-2 col-lg-3 col-md-3">
            <label class="form-label">Select Template</label>
            <select id="templateDropdown" class="form-select form-select-sm"></select>
        </div>

        <div class="col-xl-2 col-lg-12 d-flex gap-2 justify-content-end flex-wrap mt-2">
            <button id="assignShiftBtn" class="btn btn-danger btn-sm px-3" disabled>Assign Shifts</button>
            <button id="addHolidayBtn" class="btn bg-success btn-sm px-3" disabled>+ Add Holiday</button>
        </div>
    </div>

    <!-- Legend -->
    <div id="calendarLegend" class="calendar-legend-container mb-2">
        <span class="legend-item"><span class="legend-color" style="background:#CFE9FF;"></span> Holiday</span>
        <span class="legend-item"><span style="font-size:16px;">📝</span> Template</span>
        <span class="legend-item"><span class="legend-color" style="background:#fff7e5;"></span> Today</span>
    </div>

    <div id="calendar"></div>
</div>

<!-- ASSIGN SHIFT MODAL -->
<div class="modal fade modal-request" id="assignShiftModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width:900px!important;">
        <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title">Assign Shifts</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" style="padding:25px 35px!important;">

                <form id="assignShiftForm">

                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="form-label">Start Date</label>
                            <div class="input-icon-box">
                                <i class="fa-solid fa-calendar-day"></i>
                                <input id="modalStartDate" class="form-control" readonly />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">End Date</label>
                            <div class="input-icon-box">
                                <i class="fa-solid fa-calendar-day"></i>
                                <input id="modalEndDate" class="form-control" readonly />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Template</label>
                            <div class="input-icon-box">
                                <i class="fa-solid fa-layer-group"></i>
                                <input id="modalTemplateName" class="form-control" readonly />
                            </div>
                        </div>
                    </div>

                    <label class="form-label mt-3">Repeat Frequency</label>
                    <div class="d-flex gap-2 flex-wrap mt-1" id="freqButtons">
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="1">M</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="2">T</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="3">W</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="4">T</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="5">F</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="6">S</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="0">S</button>
                    </div>

                    <button type="button" id="showShiftDetailsBtn"
                        class="btn btn-outline-primary btn-sm mt-2">View Shift Details</button>

                    <div id="shiftDetailsPanel" class="mt-3 p-3 border rounded" style="display:none;">
                        <h6 class="fw-bold mb-2">Shift Details</h6>
                        <div id="shiftDetailsContent">Loading...</div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button id="saveShiftBtn" class="btn btn-submit">Save</button>
            </div>

        </div>
    </div>
</div>

<!-- HOLIDAY MODAL -->
<div class="modal fade modal-request" id="holidayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title">Add Holiday</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="holidayForm">

                    <div class="mb-3">
                        <label class="form-label">Holiday Date</label>
                        <input id="holidayDate" class="form-control" readonly />
                    </div>

                   <div class="mb-3">
                        <label class="form-label">Holiday Name <span class="text-danger">*</span></label>
                        <input id="holidayName" class="form-control"
                               required maxlength="150" autocomplete="off"
                               pattern="[A-Za-z0-9 ]+"
                               placeholder="Enter Holiday Name"
                               title="Only letters, numbers, and spaces allowed. Maximum 150 characters.">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Holiday Description <span class="text-danger">*</span></label>
                        <input id="holidayDescription" class="form-control"
                               required maxlength="500" autocomplete="off"
                               pattern="[A-Za-z0-9 .,/-]+"
                           placeholder="Enter Holiday Description"
                           title="Letters, numbers, spaces, commas, periods, slashes, and hyphens allowed. Maximum 500 characters.">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Holiday Type <span class="text-danger">*</span></label>
                        <select id="holidayType" class="form-select" required></select>
                    </div>


                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="holidayForm" class="btn btn-submit">Save</button>
            </div>

        </div>
    </div>
</div>

<script src="~/lib/fullcalendar/index.global.min.js"></script>

<script>
// -----------------------------------------------
// Existing Holiday Dates
// -----------------------------------------------
const existingHolidayDates = [
    @foreach (var h in Model.HolidayList)
    {
        if (h.Holiday_date.HasValue)
        {
            <text>"@h.Holiday_date.Value.Date.ToString("yyyy-MM-dd")",</text>
        }
    }
];

// -----------------------------------------------
// Load ShiftData & Templates
// -----------------------------------------------
const allShiftData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.ShiftData));
const allTemplates = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Templates));
const shiftCalendarData  = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.ShiftCalendarData));
console.log("Loaded Shift Data:", shiftCalendarData );
let calendar;
let selectedDate = null;

function todayIso() {
    let d = new Date();
    return d.toISOString().split("T")[0];
}

// -----------------------------------------------
// Validation for Assign Shift filters
// -----------------------------------------------
function validateFilters() {
    let plant = $("#plantDropdown").val();
    let start = $("#startDate").val();
    let end = $("#endDate").val();
    let template = $("#templateDropdown").val();
    let today = todayIso();


    if (start && start < today)
        showToast({ icon: "error", text: "Start date must be in the future" });

    if (end && end < today)
        showToast({ icon: "error", text: "End date must be in the future" });

    if (start && end && start >= end)
        showToast({ icon: "error", text: "End date must be greater than start date" });

    let valid =
        plant && template &&
        start && end &&
        start >= today &&
        end >= today &&
        start < end;

    $("#assignShiftBtn").prop("disabled", !valid);
}

$("#plantDropdown, #templateDropdown, #startDate, #endDate")
    .on("change input", validateFilters);

// -----------------------------------------------
// Document Ready
// -----------------------------------------------
$(document).ready(function () {

    $("#shiftDetailsPanel").hide();   // hide by default
     let today = todayIso();
    $("#startDate").attr("min", today);
    $("#endDate").attr("min", today);
    $("#startDate").on("change", function () {
        $("#endDate").attr("min", $(this).val());
    });
    // When Holiday modal closes → disable the Add Holiday button and clear selectedDate
    $("#holidayModal").on("hidden.bs.modal", function () {
        selectedDate = null;
        $("#addHolidayBtn").prop("disabled", true);
    });

    // Dropdown population
    $("#plantDropdown").append('<option value="" disabled selected>Select Plant</option>');
    @foreach (var p in Model.Plants) {
        <text> $("#plantDropdown").append(`<option value="@p.Plant_id">@p.Plant_name</option>`); </text>
    }

    $("#templateDropdown").append('<option value="" disabled selected>Select Template</option>');
    @foreach (var t in Model.Templates) {
        <text> $("#templateDropdown").append(`<option value="@t.Template_id">@t.Template_name</option>`); </text>
    }

    $("#holidayType").append('<option value="" disabled selected>Select Holiday Type</option>');
    @foreach (var h in Model.Holidays) {
        <text> $("#holidayType").append(`<option value="@h.Id">@h.Name</option>`); </text>
    }

    // Holiday events
    const holidayEvents = [
        @foreach (var h in Model.HolidayList)
        {
            var dt = h.Holiday_date.HasValue
                ? h.Holiday_date.Value.Date.ToString("yyyy-MM-dd")
                : "";
       <text>
{
    title: "@h.Holiday_name".toUpperCase(),
    start: "@dt",
    allDay: true,
    display: "auto",
    backgroundColor: "#e6f0fa",
    borderColor: "#3b82f6",
    textColor: "#1e3a8a",
    extendedProps: { type: "holiday" }
},
</text>

        }
    ];

    // Calendar init
   calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
    initialView: 'dayGridMonth',
       eventDidMount: function(info) {
 if (info.event.extendedProps.type === "holiday") {
        info.el.classList.add("fc-event-holiday");
    }

    if (info.event.extendedProps.type === "template") {
        info.el.classList.add("fc-event-template");
    }
    },

    eventSources: [
     
        { events: holidayEvents }
    ]
});


    calendar.render();
    

    // Calendar click
    calendar.on('dateClick', function (info) {
        let today = todayIso();

        if (info.dateStr < today) {
            selectedDate = null;
            $("#addHolidayBtn").prop("disabled", true);
            showToast({ icon: "error", text: "Cannot add holiday for past dates" });
            return;
        }

        if (existingHolidayDates.includes(info.dateStr)) {
            selectedDate = null;
            $("#addHolidayBtn").prop("disabled", true);
            showToast({ icon: "error", text: "Holiday already exists on this date" });
            return;
        }

        selectedDate = info.dateStr;
        $("#addHolidayBtn").prop("disabled", false);
    });

}); // end ready

$("#plantDropdown").change(function () {

    let plantId = $(this).val();

    if (!plantId) return;

    // Filter shifts for selected plant
    const filtered = shiftCalendarData.filter(x => x.plant_id == plantId);

    // Clear previous template events
    calendar.getEvents().forEach(e => {
        if (e.extendedProps.type === "template") e.remove();
    });

    // Add new template events
    addTemplateEvents(filtered);
});
function addTemplateEvents(data) {

    console.log("Adding template events for:", data);

    data.forEach(rec => {

        const template = allTemplates.find(t => t.template_id == rec.template_id);
        const templateName = template ? template.template_name : "Template";

        const dayFlags = {
            0: rec.sun == 1,
            1: rec.mon == 1,
            2: rec.tue == 1,
            3: rec.wed == 1,
            4: rec.thu == 1,
            5: rec.fri == 1,
            6: rec.sat == 1
        };

        // ------------ FIX: Remove time part ----------------
        let start = new Date(rec.start_date.split("T")[0] + "T00:00:00");
        let end   = new Date(rec.end_date.split("T")[0] + "T00:00:00");

        console.log("START:", start, "END:", end);

        while (start <= end) {

            let iso = start.toLocaleDateString("en-CA");  // yyyy-mm-dd
            let day = start.getDay();

            if (!dayFlags[day]) {
                start.setDate(start.getDate() + 1);
                continue;
            }

            if (existingHolidayDates.includes(iso)) {
                start.setDate(start.getDate() + 1);
                continue;
            }

            calendar.addEvent({
               title: "📝 " + templateName,
                start: iso,
                allDay: true,
                display: "auto",
                extendedProps: { type: "template" },
                eventDidMount: function(info) {
                    info.el.style.fontSize = "14px";
                    info.el.style.fontWeight = "700";
                    info.el.style.color = "#0056b3";
                    info.el.style.backgroundColor = "transparent";
                    info.el.style.border = "none";
                    info.el.style.paddingLeft = "2px";
                }
            });

            start.setDate(start.getDate() + 1);
        }

    });
}


// -----------------------------------------------
// Assign Shift Modal
// -----------------------------------------------
$("#assignShiftBtn").click(function () {

    if ($(this).prop("disabled")) {
        showToast({ icon: "error", text: "Please complete all fields" });
        return;
    }

    $("#modalStartDate").val($("#startDate").val());
    $("#modalEndDate").val($("#endDate").val());
    $("#modalTemplateName").val($("#templateDropdown option:selected").text());

    $("#freqButtons .freq-btn").removeClass("active");
    $("#shiftDetailsPanel").hide();

    new bootstrap.Modal(document.getElementById("assignShiftModal")).show();
});

// frequency toggle
$(document).on("click", ".freq-btn", function () {
    $(this).toggleClass("active");
});

// -----------------------------------------------
// VIEW SHIFT DETAILS  (Fix to show all 5 shifts)
// -----------------------------------------------
$("#showShiftDetailsBtn").click(function () {

    const templateId = $("#templateDropdown").val();

    if (!templateId) {
        showToast({ icon: "error", text: "Select a template first" });
        return;
    }

    $("#shiftDetailsPanel").toggle();

    if (!$("#shiftDetailsPanel").is(":visible")) return;

    $("#shiftDetailsContent").html("Loading...");

    const template = allTemplates.find(t => t.template_id == templateId);

    if (!template) {
        $("#shiftDetailsContent").html("<p class='text-muted'>Invalid template.</p>");
        return;
    }

    // FIXED: Correct syntax
    const shiftIds = [
        template.assigned_shift1,
        template.assigned_shift2,
        template.assigned_shift3,
        template.assigned_shift4,
        template.assigned_shift5
    ].filter(x => x != null);

    const shifts = allShiftData.filter(s => shiftIds.includes(s.shift_id));

    if (shifts.length === 0) {
        $("#shiftDetailsContent").html("<p class='text-muted'>No shift details found.</p>");
        return;
    }

    let html = "";
    shifts.forEach((shift, index) => {

        html += `
            <div class="mb-3 p-2 border rounded">
                <h6 class="fw-bold">Shift ${index + 1}: ${shift.shift_name}</h6>
                <div><strong>Start Time:</strong> ${shift.start_time}</div>
                <div><strong>End Time:</strong> ${shift.end_time}</div>
        `;

        if (shift.break_details) {
            try {
                const breaks = JSON.parse(shift.break_details);
                if (breaks.length > 0) {
                    html += `<div class="mt-2"><strong>Breaks:</strong></div>`;

                    breaks.forEach((b, i) => {
                        let num = i + 1;
                        html += `
                            <div class="ms-3">
                               • Break ${num}: ${b[`Break${num}In`]} – ${b[`Break${num}Out`]}
                                 (${b[`Break${num}Description`]})
                            </div>`;
                    });
                }
            } catch {}
        }

        html += `</div>`;
    });

    $("#shiftDetailsContent").html(html);
});


// ------------------------------------------------------------
// SAVE SHIFT  (Assign Shift → Save button)
// ------------------------------------------------------------
$("#saveShiftBtn").click(async function () {

    const plantId = $("#plantDropdown").val();
    const templateId = $("#templateDropdown").val();
    const startDate = $("#modalStartDate").val();
    const endDate = $("#modalEndDate").val();

    const selectedDays = $("#freqButtons .freq-btn.active")
        .map(function () { return $(this).data("day"); }).get();

    if (!plantId) return showToast({ icon: "error", text: "Select plant" });
    if (!templateId) return showToast({ icon: "error", text: "Select template" });
    if (!startDate) return showToast({ icon: "error", text: "Start date missing" });
    if (!endDate) return showToast({ icon: "error", text: "End date missing" });

    if (selectedDays.length === 0)
        return showToast({ icon: "error", text: "Select at least one frequency day" });


    // ------------------------------------------
    // BUILD PAYLOAD (ShiftCalendarModel)
    // ------------------------------------------
    const payload = {
            assignment_id: 0,
            plant_id: parseInt(plantId),
            template_id: parseInt(templateId),

            
            start_date: startDate + "T00:00:00+05:30",
            end_date: endDate + "T00:00:00+05:30",

            sun: selectedDays.includes(0),
            mon: selectedDays.includes(1),
            tue: selectedDays.includes(2),
            wed: selectedDays.includes(3),
            thu: selectedDays.includes(4),
            fri: selectedDays.includes(5),
            sat: selectedDays.includes(6),

            is_active: true,
            created_by: $("#loggedInUser").val() || "system"
    };

    console.log("Payload for Create:", payload);


    // ------------------------------------------
    // SEND TO CONTROLLER
    // ------------------------------------------
    try {

        const modal = bootstrap.Modal.getInstance(
            document.getElementById("assignShiftModal")
        );

        const response = await fetch("/ShiftCalendar/Create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        console.log("Create Response:", result);
        console.log("Create Response:", response);

       if (response.ok && result.title?.toLowerCase() === "success") {

            showToast({ icon: "success", text: result.message || "Shift Assigned Successfully" });

            // Safe modal close
            var modalEl = document.getElementById("assignShiftModal");
            var modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInstance.hide();

            setTimeout(() => {
                window.location.href = "/ShiftCalendar/Index";
            }, 300);
            }
    else {
        showToast({
            icon: "error",
            text: (result.message || "Failed to assign shift").replace(/\n/g, " ")
        });
        }


    } catch (err) {
        console.error(err);
        showToast({ icon: "error", text: "Server error" });
    }
});

function isTemplateAssigned(dateStr) {
    return calendar.getEvents().some(ev =>
        ev.extendedProps.type === "template" &&
        ev.startStr === dateStr
    );
}

// -----------------------------------------------
// Add Holiday
// -----------------------------------------------
$("#addHolidayBtn").click(function () {

    if (!selectedDate)
        return showToast({ icon: "error", text: "Select a date first" });

    // Check if template already exists
    if (isTemplateAssigned(selectedDate)) {
        return showToast({
            icon: "error",
            text: "Cannot add holiday. Shift already assigned for this date."
        });
    }

    if (existingHolidayDates.includes(selectedDate))
        return showToast({ icon: "error", text: "Holiday already exists" });

    $("#holidayDate").val(selectedDate);
    $("#holidayName").val("");
    $("#holidayDescription").val("");
    $("#holidayType").val("");

    new bootstrap.Modal(document.getElementById("holidayModal")).show();
});

// -----------------------------------------------
// SAVE HOLIDAY
// -----------------------------------------------
$("#holidayForm").on("submit", async function (e) {

    // Browser validation
    if (!this.checkValidity()) {
        return; // shows browser bubble automatically
    }

    e.preventDefault(); // now safe to stop default submit

    const name = $("#holidayName").val().trim();
    const desc = $("#holidayDescription").val().trim();
    const type = $("#holidayType").val();

    const formData = {
        Holiday_date: selectedDate,
        Holiday_name: name,
        Description: desc,
        Holiday_type_id: type
    };

    const modal = bootstrap.Modal.getInstance(document.getElementById("holidayModal"));
    const success = await saveRecord("/HolidayMaster/Create", formData, "Add", modal, this);

    if (success) {
        showToast({ icon: "success", text: "Holiday Saved" });
        setTimeout(() => location.href = "/ShiftCalendar/Index", 900);
    }
});


</script>

