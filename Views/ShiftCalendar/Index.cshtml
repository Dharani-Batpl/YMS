@model YardManagementApplication.Models.ShiftCalendarViewModel
@{
    Layout = "_Layout";
}

<style>
    .main-container {
        margin-left: 5px !important;
        margin-right: 5px !important;
    }

    #calendar {
        max-height: 600px;
    }

    .form-label {
        font-size: 0.80rem;
        font-weight: 600;
    }

    .form-select-sm, .form-control-sm {
        padding: 3px 6px !important;
        height: 36px !important;
        border-radius: 4px !important;
    }

    .btn-sm {
        height: 32px;
        font-size: 0.8rem;
    }

    /* Frequency buttons */
    .freq-btn.active {
        background-color: #0d6efd !important;
        color: white !important;
        border-color: #0d6efd !important;
    }

    .freq-btn {
        width: 44px;
        height: 36px;
        padding: 0;
        text-align: center;
        font-weight: 600;
        border-radius: 6px;
    }

    .modal-request .btn-close {
        filter: invert(1);
        width: 36px;
        height: 36px;
    }

    .shift-detail {
        padding: 12px;
        border: 1px solid #e9e9e9;
        border-radius: 6px;
        margin-bottom: 10px;
    }
</style>

<div class="main-container">

    <div class="col-12 text-center py-1 mb-3" style="background:#242424;color:white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">SHIFT CALENDAR</h6>
    </div>

    <div class="row g-2 align-items-end mb-3">

        <div class="col-xl-2 col-lg-3 col-md-3">
            <label class="form-label">Select Plant</label>
            <select id="plantDropdown" class="form-select form-select-sm"></select>
        </div>

        <div class="col-xl-3 col-lg-3 col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control form-control-sm" />
        </div>

        <div class="col-xl-3 col-lg-3 col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control form-control-sm" />
        </div>

        <div class="col-xl-2 col-lg-3 col-md-3">
            <label class="form-label">Select Template</label>
            <select id="templateDropdown" class="form-select form-select-sm"></select>
        </div>

        <div class="col-xl-2 col-lg-12 d-flex gap-2 justify-content-end flex-wrap mt-2">
            <button id="assignShiftBtn" class="btn btn-danger btn-sm px-3" disabled>Assign Shifts</button>
            <button id="addHolidayBtn" class="btn bg-success btn-sm px-3" disabled>+ Add Holiday</button>
        </div>
    </div>

    <div class="card p-3" style="border-radius:10px;">
        <div id="calendar"></div>
    </div>

</div>


<!-- ===================== MODAL ===================== -->
<div class="modal fade modal-request" id="assignShiftModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                 <h6 class="modal-title">Assign Shifts</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <form id="assignShiftForm">

                    <div class="row g-3 mb-1">

                        <div class="col-md-8">
                            <label class="form-label">Start Date</label>
                            <input id="modalStartDate" class="form-control" readonly />
                        </div>

                        <div class="col-md-8">
                            <label class="form-label">End Date</label>
                            <input id="modalEndDate" class="form-control" readonly />
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Template</label>
                            <input id="modalTemplateName" class="form-control" readonly />
                        </div>

                    </div>

                    <label class="form-label mt-3">Repeat Frequency</label>
                    <div class="d-flex gap-2 flex-wrap mt-1" id="freqButtons">
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="1">M</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="2">T</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="3">W</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="4">T</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="5">F</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="6">S</button>
                        <button type="button" class="btn btn-outline-secondary freq-btn" data-day="0">S</button>
                    </div>

                   <button type="button" id="showShiftDetailsBtn"
                        class="btn btn-outline-primary btn-sm mt-2">
                    View Shift Details
                </button>
                <div id="shiftDetailsPanel" class="mt-3 p-3 border rounded" style="display:none;">
                <h6 class="fw-bold mb-2">Shift Details</h6>
                <div id="shiftDetailsContent">Loading...</div>
            </div>


                </form>

            </div>

            <div class="modal-footer">
                <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button id="saveShiftBtn" class="btn btn-submit">Save</button>
            </div>

        </div>
    </div>
</div>
<!-- ===================== HOLIDAY MODAL ===================== -->
<div class="modal fade modal-request" id="holidayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title">Add Holiday</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="holidayForm">

                    <div class="mb-3">
                        <label class="form-label">Holiday Date</label>
                        <input id="holidayDate" class="form-control" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Holiday Name <span class="text-danger">*</span></label>
                        <input id="holidayName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Holiday Description <span class="text-danger">*</span></label>
                        <input id="holidayDescription" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Holiday Type <span class="text-danger">*</span></label>
                        <select id="holidayType" class="form-select" required></select>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button id="saveHolidayBtn" class="btn btn-submit">Save</button>
            </div>

        </div>
    </div>
</div>

<script src="~/lib/fullcalendar/index.global.min.js"></script>

<script>
// -----------------------------------------------
// Existing Holiday Dates
// -----------------------------------------------
const existingHolidayDates = [
    @foreach (var h in Model.HolidayList)
    {
        var date = h.Holiday_date.HasValue
            ? h.Holiday_date.Value.Date.ToString("yyyy-MM-dd")
            : "";
        <text>"@date",</text>
    }
];

// -----------------------------------------------
// Load ShiftData & Templates
// -----------------------------------------------
const allShiftData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.ShiftData));
const allTemplates = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Templates));

let calendar;
let selectedDate = null;

function todayIso() {
    let d = new Date();
    return d.toISOString().split("T")[0];
}

// -----------------------------------------------
// Validation for Assign Shift filters
// -----------------------------------------------
function validateFilters() {
    let plant = $("#plantDropdown").val();
    let start = $("#startDate").val();
    let end = $("#endDate").val();
    let template = $("#templateDropdown").val();
    let today = todayIso();

    if (start && start < today)
        showToast({ icon: "error", text: "Start date must be in the future" });

    if (end && end < today)
        showToast({ icon: "error", text: "End date must be in the future" });

    if (start && end && start >= end)
        showToast({ icon: "error", text: "End date must be greater than start date" });

    let valid =
        plant && template &&
        start && end &&
        start >= today &&
        end >= today &&
        start < end;

    $("#assignShiftBtn").prop("disabled", !valid);
}

$("#plantDropdown, #templateDropdown, #startDate, #endDate")
    .on("change input", validateFilters);

// -----------------------------------------------
// Document Ready
// -----------------------------------------------
$(document).ready(function () {

    $("#shiftDetailsPanel").hide();   // hide by default

    // Dropdown population
    $("#plantDropdown").append('<option value="" disabled selected>Select Plant</option>');
    @foreach (var p in Model.Plants) {
        <text> $("#plantDropdown").append(`<option value="@p.Plant_id">@p.Plant_name</option>`); </text>
    }

    $("#templateDropdown").append('<option value="" disabled selected>Select Template</option>');
    @foreach (var t in Model.Templates) {
        <text> $("#templateDropdown").append(`<option value="@t.Template_id">@t.Template_name</option>`); </text>
    }

    $("#holidayType").append('<option value="" disabled selected>Select Holiday Type</option>');
    @foreach (var h in Model.Holidays) {
        <text> $("#holidayType").append(`<option value="@h.Id">@h.Name</option>`); </text>
    }

    // Holiday events
    const holidayEvents = [
        @foreach (var h in Model.HolidayList)
        {
            var dt = h.Holiday_date.HasValue
                ? h.Holiday_date.Value.Date.ToString("yyyy-MM-dd")
                : "";
        <text>
        {
            title: "@h.Holiday_name",
            start: "@dt",
            display: "background",
            backgroundColor: "#FFA500",
            borderColor: "#cc8400",
            textColor: "black"
        },
        </text>
        }
    ];

    // Calendar init
    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        eventSources: [
            { url: '/Calendar/GetEvents', method: 'GET' },
            { events: holidayEvents }
        ]
    });

    calendar.render();

    // Calendar click
    calendar.on('dateClick', function (info) {
        let today = todayIso();

        if (info.dateStr < today) {
            selectedDate = null;
            $("#addHolidayBtn").prop("disabled", true);
            showToast({ icon: "error", text: "Cannot add holiday for past dates" });
            return;
        }

        if (existingHolidayDates.includes(info.dateStr)) {
            selectedDate = null;
            $("#addHolidayBtn").prop("disabled", true);
            showToast({ icon: "error", text: "Holiday already exists on this date" });
            return;
        }

        selectedDate = info.dateStr;
        $("#addHolidayBtn").prop("disabled", false);
    });

}); // end ready

// -----------------------------------------------
// Assign Shift Modal
// -----------------------------------------------
$("#assignShiftBtn").click(function () {

    if ($(this).prop("disabled")) {
        showToast({ icon: "error", text: "Please complete all fields" });
        return;
    }

    $("#modalStartDate").val($("#startDate").val());
    $("#modalEndDate").val($("#endDate").val());
    $("#modalTemplateName").val($("#templateDropdown option:selected").text());

    $("#freqButtons .freq-btn").removeClass("active");
    $("#shiftDetailsPanel").hide();

    new bootstrap.Modal(document.getElementById("assignShiftModal")).show();
});

// frequency toggle
$(document).on("click", ".freq-btn", function () {
    $(this).toggleClass("active");
});

// -----------------------------------------------
// VIEW SHIFT DETAILS
// -----------------------------------------------
$("#showShiftDetailsBtn").click(function () {

    const templateId = $("#templateDropdown").val();

    if (!templateId) {
        showToast({ icon: "error", text: "Select a template first" });
        return;
    }

    $("#shiftDetailsPanel").toggle();

    if (!$("#shiftDetailsPanel").is(":visible")) return;

    $("#shiftDetailsContent").html("Loading...");

    const template = allTemplates.find(t => t.template_id == templateId);

    if (!template) {
        $("#shiftDetailsContent").html("<p class='text-muted'>Invalid template.</p>");
        return;
    }

    const shiftId = template.shift_id;
    const shift = allShiftData.find(s => s.shift_id == shiftId);

    if (!shift) {
        $("#shiftDetailsContent").html("<p class='text-muted'>No shift details found.</p>");
        return;
    }

    let html = `
        <div class="mb-3 p-2 border rounded">
            <div><strong>Shift:</strong> ${shift.shift_name}</div>
            <div><strong>Start Time:</strong> ${shift.start_time}</div>
            <div><strong>End Time:</strong> ${shift.end_time}</div>
    `;

    if (shift.break_details) {
        try {
            const breaks = JSON.parse(shift.break_details);
            if (breaks.length > 0) {
                html += `<div class="mt-2"><strong>Breaks:</strong></div>`;
                breaks.forEach((b, i) => {
                    let index = i + 1;
                    html += `
                        <div class="ms-3">
                            • Break ${index}: ${b[`Break${index}In`]} - ${b[`Break${index}Out`]} (${b[`Break${index}Description`]})
                        </div>`;
                });
            }
        } catch {}
    }

    html += `</div>`;
    $("#shiftDetailsContent").html(html);
});

// -----------------------------------------------
// SAVE SHIFT
// -----------------------------------------------
$("#saveShiftBtn").click(function () {
    const days = $("#freqButtons .freq-btn.active")
        .map(function () { return $(this).data("day"); }).get();

    if (days.length === 0)
        return showToast({ icon: "error", text: "Select at least one frequency day" });

    showToast({ icon: "success", text: "Saved Successfully" });
});

// -----------------------------------------------
// Add Holiday
// -----------------------------------------------
$("#addHolidayBtn").click(function () {

    if (!selectedDate)
        return showToast({ icon: "error", text: "Select a date first" });

    if (existingHolidayDates.includes(selectedDate))
        return showToast({ icon: "error", text: "Holiday already exists" });

    $("#holidayDate").val(selectedDate);
    $("#holidayName").val("");
    $("#holidayDescription").val("");
    $("#holidayType").val("");

    new bootstrap.Modal(document.getElementById("holidayModal")).show();
});

// -----------------------------------------------
// SAVE HOLIDAY
// -----------------------------------------------
$("#saveHolidayBtn").click(async function () {

    const name = $("#holidayName").val().trim();
    const desc = $("#holidayDescription").val().trim();
    const type = $("#holidayType").val();

    if (!name) return showToast({ icon: "error", text: "Holiday name required" });
    if (!desc) return showToast({ icon: "error", text: "Holiday description required" });
    if (!type) return showToast({ icon: "error", text: "Holiday type required" });

    const formData = {
        Holiday_date: selectedDate,
        Holiday_name: name,
        Holiday_description: desc,
        Holiday_type_id: type,
        Status_id: 1
    };

    const modal = bootstrap.Modal.getInstance(document.getElementById("holidayModal"));
    const success = await saveRecord("/HolidayMaster/Create", formData, "Add", modal, document.getElementById("holidayForm"));

    if (success) {
        showToast({ icon: "success", text: "Holiday Saved" });
        setTimeout(() => location.href = "/ShiftCalendar/Index", 900);
    }
});
</script>

