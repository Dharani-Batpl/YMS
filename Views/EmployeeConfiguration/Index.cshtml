@using Microsoft.AspNetCore.Mvc.Rendering
@{
    //  Read JSON payload for grid from ViewData
    var employeeConfiguration = ViewData["EmployeeConfiguration"] ?? "[]";
    // set layout
    Layout = "_Layout";
}

<head>
    <!--  Keep head empty as per request (no changes to assets/includes) -->
</head>

<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
</style>
<div class="main-container">
    <!--  Page title header -->
@*     <div id="pageTitle" class="col-12 text-center py-1 mb-3">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Employee Master</h6>
    </div> *@
    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Employee Master</h6>
    </div>
    <!--  Toolbar row with search + action buttons -->
    <div class="row align-items-center mb-3">
        <!--  Spacer on small devices -->
        <div class="w-100 d-md-none"></div>

        <!--  Right-aligned tools on md+ -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">
            <!--  Global search input -->
            <input type="search"
                   id="searchField"
                   class="form-control form-control-sm"
                   placeholder="Search..."
                   style="max-width: 280px; min-width: 150px;" />

            <!--  Action buttons group (Add/Edit/Delete/Download/Upload/Template) -->
            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">
                <!--  Add row -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <!--  Edit selected row -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <!--  Delete selected row -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <!--  Download CSV -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <!--  Upload CSV -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <!--  Download CSV template -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <form id="afForm" style="display:none" method="post">
        @Html.AntiForgeryToken()
        <input type="file" id="upload-file" style="display:none" accept=".xlsx,.xls" />

    </form>

    <!--  Tabulator grid mount point -->
    <div id="employeeConfigurationTable" class="tabulator-bootstrap5"></div>

    @* <div id="recordCount" class="text-end mt-2 fw-semibold text-secondary"></div> *@
     <div id="recordCount" class="footer-total-records"></div>

</div>

<!--  Add/Edit modal (wide inline version) -->
<div class="modal fade modal-request" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"
         style="max-width: 55% !important;">
        <div class="modal-content"
             style="max-height: 90vh; overflow-y: auto; border-radius: 12px;">

            <!-- Header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add Employee Master</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <form id="addEditForm">

                    <input type="hidden" id="Employee_id" name="Employee_id" />

                    <div class="row g-4">

                        <!-- Employee Code -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Employee Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" autocomplete="off" id="Employee_code" name="Employee_code" required>
                        </div>

                        <!-- First Name -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" autocomplete="off" id="First_name" name="First_name" required>
                        </div>

                        <!-- Middle Name -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Middle Name</label>
                            <input type="text" class="form-control" autocomplete="off" id="Middle_name" name="Middle_name">
                        </div>

                        <!-- Last Name -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" autocomplete="off" id="Last_name" name="Last_name" required>
                        </div>

                        <!-- Department -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Department <span class="text-danger">*</span></label>
                            <select class="form-select" id="Department_id" name="Department_id" required
                                asp-items="@(ViewBag.DepartmentList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Department</option>
                            </select>
                        </div>

                        <!-- Reporting To -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Reporting To <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" autocomplete="off" id="Reporting_to_name" name="Reporting_to_name" required>
                        </div>

                        <!-- Phone Number -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select class="form-select" id="Country_code" name="Country_code" required style="max-width:110px;">
                                    <option value="+1">+1 (US)</option>
                                    <option value="+52">+52 (MX)</option>
                                    <option value="+91">+91 (IND)</option>
                                </select>
                                <input type="text" class="form-control" autocomplete="off" id="Contact_number" name="Contact_number" maxlength="10" required>
                            </div>
                        </div>

                        <!-- Emergency contact -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Emergency Contact Number <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select class="form-select" id="Emergency_country_code" name="Emergency_country_code" required style="max-width:110px;">
                                    <option value="+1">+1 (US)</option>
                                    <option value="+52">+52 (MX)</option>
                                    <option value="+91">+91 (IND)</option>
                                </select>
                                <input type="text" class="form-control" autocomplete="off" id="Emergency_contact_number" name="Emergency_contact_number" maxlength="10" required>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label" for="Email">Email <span class="text-danger">*</span></label>

                            <input type="email" class="form-control" autocomplete="off" id="Email" name="Email" required>
                        </div>

                        <!-- Skill Type -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Skill Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="Skill_id" name="Skill_id" required
                                asp-items="@(ViewBag.SkillNameList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Skill</option>
                            </select>
                        </div>

                        <!-- Skill Level -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Skill Level <span class="text-danger">*</span></label>
                            <select class="form-select" id="Skill_level_id" name="Skill_level_id" required
                                asp-items="@(ViewBag.SkilllevelList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Skill Level</option>
                            </select>
                        </div>

                        <!-- Certificate Type -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Certificate Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="Certificate_type_id" name="Certificate_type_id" required
                                asp-items="@(ViewBag.CertificateTypeList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Certificate Type</option>
                            </select>
                        </div>

                        <!-- Certification Date -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Certificate Issue Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" autocomplete="off" id="Certification_date" name="Certification_date" required>
                        </div>

                        <!-- Expiry Date -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Certificate Expiry Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" autocomplete="off" id="Expiry_date" name="Expiry_date" required>
                        </div>

                        <!-- Blood Group -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Blood Group <span class="text-danger">*</span></label>
                            <select class="form-select" id="Blood_group" name="Blood_group" required>
                                <option disabled selected value="">Select Blood Group</option>
                                <option>A+</option><option>A-</option>
                                <option>B+</option><option>B-</option>
                                <option>O+</option><option>O-</option>
                                <option>AB+</option><option>AB-</option>
                            </select>
                        </div>

                        <!-- Employment -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Employment Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="Employee_type_id" name="Employee_type_id" required
                                asp-items="@(ViewBag.EmployeeTypeList as IEnumerable<SelectListItem>)">
                                <option disabled selected value="">Select Employment Type</option>
                            </select>
                        </div>

                        <!-- Status -->
                        <div class="col-md-6" style="width:320px;">
                            <label class="form-label">Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="Status_id" name="Status_id" required
                                asp-items="@(ViewBag.StatusList as IEnumerable<SelectListItem>)">
                                <option disabled selected value="">Select Status</option>
                            </select>
                        </div>                        
                      
                        <!-- Address -->
                        <div class="col-md-12" style="width:420px;">
                            <label class="form-label">Address <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" autocomplete="off" id="Address" name="Address" required>
                        </div>

                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="modal-footer d-flex justify-content-between align-items-center">
            <!-- APP USER CHECKBOX -->
                <div>
                    <input class="form-input" type="checkbox" id="IsAppUser" name="IsAppUser" style="margin-right: 8px;">

                    <label class="form-label" for="IsAppUser">App User?</label>
                </div>

            <div>
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-submit" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>
<script>

$(document).ready(function () {

    // -------------------------------
    // Date validation (Issue → Expiry)
    // -------------------------------
    $("#Certification_date").on("change", function () {
        $("#Expiry_date").attr("min", $(this).val());
    });

    // -------------------------------
    // Phone input: numbers only
    // -------------------------------
    $("#Contact_number, #Emergency_contact_number").on("input", function () {
        this.value = this.value.replace(/[^0-9]/g, "");
    });

    // -------------------------------
    // Phone ≠ Emergency Phone
    // -------------------------------
    $("#Contact_number, #Emergency_contact_number").on("input", function () {
        let contact = $("#Contact_number").val();
        let emergency = $("#Emergency_contact_number").val();

        if (contact && emergency && contact === emergency) {
            $("#Emergency_contact_number")[0]
                .setCustomValidity("Phone number and Emergency number cannot be the same");
        } else {
            $("#Emergency_contact_number")[0].setCustomValidity("");
        }
    });

    // -------------------------------
    // Email validation
    // -------------------------------
    $("#Email").on("input", function () {
        let email = $(this).val().trim();
        const pattern = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.com$/i;

        if (email && !pattern.test(email)) {
            this.setCustomValidity("Please enter a valid Email address (ex: abc@gmail.com)");
        } else {
            this.setCustomValidity("");
        }
    });

    // -------------------------------
    // Tabulator Init (unchanged)
    // -------------------------------
    const EmployeeConfigurationData = JSON.parse('@Html.Raw(employeeConfiguration)');
    let currentMode = "";
    let selectedRow = null;

    const dataTable = new Tabulator("#employeeConfigurationTable", {
        data: EmployeeConfigurationData,
        columns: [
            { title: "Employee Code", field: "Employee_code", headerHozAlign: "center" },
            { title: "First Name", field: "First_name", headerHozAlign: "center" },
            { title: "Last Name", field: "Last_name", headerHozAlign: "center" },
            { title: "Address", field: "Address", headerHozAlign: "center" },
            { title: "Department Name", field: "Department_name", headerHozAlign: "center" },
            { title: "Reporting To", field: "Reporting_to_name", headerHozAlign: "center" },
            { title: "Phone", field: "Contact_number", headerHozAlign: "center" },
            { title: "Emergency Phone", field: "Emergency_contact_number", headerHozAlign: "center" },
            { title: "Email", field: "Email", headerHozAlign: "center" }
        ],
        layout: "fitDataStretch",
        height: "80vh",
        selectable: 1,
        pagination: "local",
        paginationSize: 10,
        rowClick: function (e, row) {
            selectedRow = row.getData();
        }
    });

    // -------------------------------
    // Add Button
    // -------------------------------
    $("#add-btn").click(function () {
        currentMode = "Add";
        $("#addEditForm")[0].reset();
        $("#addEditModalLabel").text("Add Employee Master");
        $("#modalSubmitBtn").text("Add");
        $("#Employee_id").val(0);
        new bootstrap.Modal("#addEditModal").show();
    });

    // -------------------------------
    // Edit Button
    // -------------------------------
    $("#edit-btn").click(function () {
        const row = dataTable.getSelectedData()?.[0];

        if (!row) {
            return showAppAlert({ icon: "warning", title: "No Selection", text: "Select a row to edit." });
        }

        currentMode = "Edit";
      
        $("#Employee_code").prop("readonly", true);
        $("#IsAppUser").prop("disabled", true);

        $("#addEditModalLabel").text("Edit Employee Master");
        $("#modalSubmitBtn").text("Update");

        // -------------------------------
        // Fill fields including phone numbers
        // -------------------------------
        Object.keys(row).forEach(f => {
            let el = $("#" + f);
            if (!el.length) return;

            // Handle date fields
            if (el.attr("type") === "date" && row[f]) {
                let d = new Date(row[f]);
                el.val(d.toISOString().split("T")[0]);
                return;
            }

            // -------------------------------
            // PHONE NUMBER SPLIT
            // -------------------------------
            if (f === "Contact_number" && row[f]) {
                let parts = row[f].split("-");
                $("#Country_code").val(parts[0]);        // +1 / +91 / +52
                $("#Contact_number").val(parts[1] || ""); // 10-digit number
                return;
            }

            if (f === "Emergency_contact_number" && row[f]) {
                let parts = row[f].split("-");
                $("#Emergency_country_code").val(parts[0]);               // +1 / +91 / +52
                $("#Emergency_contact_number").val(parts[1] || "");       // 10-digit number
                return;
            }

            // Default set
            el.val(row[f]);
        });


        new bootstrap.Modal("#addEditModal").show();
    });

    // -------------------------------
    // Form Submit (Add / Update)
    // -------------------------------
    $("#addEditForm").on("submit", async function (e) {
        e.preventDefault();

        let formData = Object.fromEntries(new FormData(this).entries());
        formData.app_user = $("#IsAppUser").is(":checked");

        // Format phone numbers
        formData.Contact_number = `${formData.Country_code}-${formData.Contact_number}`;
        formData.Emergency_contact_number = `${formData.Emergency_country_code}-${formData.Emergency_contact_number}`;
        formData.certificate_name = $("#Certificate_type_id option:selected").text();

        const url = currentMode === "Add"
            ? "/EmployeeConfiguration/Create"
            : "/EmployeeConfiguration/Update";

        const success = await saveRecord(url, formData, currentMode,
            bootstrap.Modal.getInstance("#addEditModal"), this);

        if (success) {
            setTimeout(() => location.reload(), 800);
        }
    });
    
        // ================================================================
        //  Download template
        // ================================================================
        $("#download-template-btn").on("click", function () {

            const headers = [
                "Employee Code",
                "First Name",
                "Middle Name",
                "Last Name",
                "Department",
                "Reporting To",
                "Country code",
                "Phone Number",
                 "Emergency Country code",
                "Emergency Contact Number",
                "Email",
                "Skill Type",
                "Skill Level",
                "Certificate Type",
                "Certificate Issue Date",
                "Certificate Expiry Date",
                "Blood Group",
                "Employment Type",
                "Status",
                "Address",
                "Is App User (Y/N)"

            ];

            downloadTemplate(headers, "EmployeeMasterTemplate");
        });
     // ================================================================
    //  Upload button
    // ================================================================
    $("#upload-btn").on("click", function () {
        $("#upload-file").click();
    });
    // ================================================================
//  File input change event
// ================================================================
$("#upload-file").on("change", function (event) {

    const file = event.target.files?.[0];

    if (!file) {
        return showAppAlert({
            icon: 'warning',
            title: 'No File',
            text: 'Please select a file to upload.'
        });
    }

    const isExcel = /\.(xlsx|xls)$/i.test(file.name);
    if (!isExcel) {
        showAppAlert({
            icon: 'warning',
            title: 'Invalid File',
            text: 'Please select an Excel file (.xlsx or .xls).'
        });
        return;
    }

    uploadFile('/EmployeeConfiguration/Upload', file);
});


// ================================================================
//  Upload function
// ================================================================
async function uploadFile(url, file) {

    const formData = new FormData();
    formData.append("file", file);

    const csrf = $('#afForm input[name="__RequestVerificationToken"]').val();

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'RequestVerificationToken': csrf },
            body: formData
        });

        await handleUploadResponse(response);

    } catch (err) {
        showToast({ icon: "error", text: err.message });
    }
}


// ================================================================
//  Handle upload response
// ================================================================
async function handleUploadResponse(response) {

    const result = await response.json().catch(() => null);

    // SUCCESS
    if (response.ok) {

        showAppAlert({
            icon: result.status,
            title: result.title,
            text: result.message,
            timer: 2500,
            showConfirmButton: false
        });

        setTimeout(() => location.reload(), 800);
        $("#upload-file").val("");

        return;
    }

    // GENERIC API MESSAGE
    if (result && result.errors) {

        let msg = "";
        result.errors.forEach(e => {
            msg += `Error: ${e.error}\n\n`;
        });

        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: msg,
            timer: 4500,
            showConfirmButton: false
        });

        $("#upload-file").val("");
        return;
    }

    // GENERIC API MESSAGE
    if (result && result.message) {

        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: result.message,
            timer: 3500,
            showConfirmButton: false
        });

        $("#upload-file").val("");
        return;
    }

   // UNKNOWN ERROR
    showAppAlert({
        icon: "error",
        title: "Upload Failed",
        text: "Unexpected error.",
        timer: 3500,
        showConfirmButton: false
    });


    $("#upload-file").val("");
}
    // -------------------------------
    // Delete Button
    // -------------------------------
    $("#delete-btn").click(async function () {
        const row = dataTable.getSelectedData()?.[0];

        if (!row) {
            return showAppAlert({ icon: "warning", title: "No Selection", text: "Select a row to delete." });
        }

        const confirmDelete = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete?",
            text: "Are you sure you want to delete this record?"
        });

        if (!confirmDelete.isConfirmed) return;

        const success = await deleteRecord("/EmployeeConfiguration/Delete", {
            Employee_id: row.Employee_id
        });

        if (success) location.reload();
    });

});
</script>
