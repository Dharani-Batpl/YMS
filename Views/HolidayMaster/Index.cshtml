@using Microsoft.AspNetCore.Mvc.Rendering
@{
    //  Read JSON payload for grid from ViewData
    var holidayMasterData = ViewData["HolidayMasterData"] ?? "[]";
    // set layout
    Layout = "_Layout";
}

<head>
    <!--  Keep head empty as per request (no changes to assets/includes) -->
</head>


<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
</style>
<div class="main-container">


    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Holiday Master</h6>
    </div>

    <div class="row align-items-center mb-3">

        <!-- Spacer for small screens -->
        <div class="w-100 d-md-none"></div>

        <!-- ---- Top Button Section ---- -->
         <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

            <div class="input-icon-wrapper">
                <input type="search"
                       id="searchField"
                       class="form-control form-control-sm"
                       placeholder="Search..."
                       style="max-width: 280px; min-width: 150px;" />
                <span class="input-icon material-icons">search</span>
            </div>

            <!-- ---- Action Buttons ---- -->
            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">

                <!-- Add Button -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <!-- Edit Button -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <!-- Delete Button -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <!-- Download Button -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <!-- Upload Button -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <!-- Download Template Button -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <form id="afForm" style="display:none" method="post">
        @Html.AntiForgeryToken()
        <input type="file" id="upload-file" style="display:none" accept=".xls,.xlsx" />
    </form>

    <!-- ---- Data Grid Area ---- -->
    <div id="holidayMasterTable" class="tabulator-bootstrap5"></div>
    @* <div id="recordCount" class="text-end mt-2 fw-semibold text-secondary"></div> *@
     <div id="recordCount" class="footer-total-records"></div>
</div>

<!-- ---- Add/Edit/Delete Modal ---- -->
<div class="modal fade modal-request" id="addEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit Holiday</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                <form id="addEditForm" autocomplete="off">

                    <input type="hidden" id="Holiday_id" name="Holiday_id" />

                    <!-- Row 1 -->
                    <div class="row g-3 mt-1 mb-2">

                        <!-- Holiday Name -->
                        <div class="col-md-6">
                        <label class="form-label">Holiday Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control"
                               id="Holiday_name" name="Holiday_name"
                               style="width: 250px;"
                               required maxlength="150"
                               pattern="[A-Za-z0-9 ]+"
                               placeholder="Enter Holiday Name"
                               title="Only letters, numbers, and spaces allowed. Maximum 150 characters.">
                    </div>


                        <!-- Holiday Date -->
                        <div class="col-md-6">
                            <label class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control"
                                   id="Holiday_date"
                                   style="width: 250px;"
                                   name="Holiday_date"
                                   required>
                        </div>


                    </div>

                    <!-- Row 2 -->
                    <div class="row g-3 mt-1 mb-2">

                        <!-- Holiday Type -->
                        <div class="col-md-6">
                            <label class="form-label">Holiday Type <span class="text-danger">*</span></label>
                            <select class="form-select"
                                    id="Holiday_type_id"  style="width: 250px;" name="Holiday_type_id"
                                    required
                                    asp-items="@(ViewBag.HolidayTypeList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Holiday Type</option>
                            </select>
                        </div>

                        <!-- Description -->
                        <<div class="col-md-6">
                                <label class="form-label">Description</label>
                                <textarea class="form-control"
                                          id="Description"
                                          name="Description"
                                          rows="2"
                                          style="width: 250px; resize: vertical;"
                                          maxlength="100"
                                          placeholder="Optional description"></textarea>
                            </div>

                    </div>

                </form>

            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" id="modalSubmitBtn" form="addEditForm" class="btn btn-submit">Add</button>
            </div>

        </div>
    </div>
</div>
<script>
$(document).ready(function () {

    initTooltips();

    // Disable past dates
    const today = new Date().toISOString().split("T")[0];
    $("#Holiday_date").attr("min", today);

    const holidayMasterData = JSON.parse('@Html.Raw(holidayMasterData)');
    let selectedRow = null;
    let currentMode = "";

    // ----------------------------------------------------
    // Tabulator table
    // ----------------------------------------------------
    const dataTable = new Tabulator("#holidayMasterTable", {
        data: holidayMasterData,
        columns: [
            { title: "Holiday Name", field: "Holiday_name" },
            { title: "Holiday Date", field: "Holiday_date" },
            { title: "Holiday Type Name", field: "Holiday_type_name" },
            { title: "Description", field: "Description"},
            { title: "Created By", field: "Created_by" }
        ],
        layout: "fitColumns",
       layout: "fitColumns",
        height: "70vh",
        selectable: 1,

        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],

        resizableRows: false,
        resizableColumnGuide: false,
        columnDefaults: { resizable: false },
        movableColumns: false,

        locale: true,
        langs: {
	        "en": {
		        pagination: {
			        first: "<<",
			        first_title: "First",
			        last: ">>",
			        last_title: "Last",
			        prev: "<",
			        prev_title: "Prev",
			        next: ">",
			        next_title: "Next",
			        page_size: "Page Size"
		        }
	        }
        },

        rowClick: function (e, row) {
	        selectedRow = row.getData();
        }
        });


    // ----------------------------------------------------
    // Search (jQuery)
    // ----------------------------------------------------
    $("#searchField").on("input", function () {

        const term = $(this).val().toLowerCase();
        const visibleColumns = dataTable.getColumns().map(c => c.getField());

        dataTable.setFilter(d =>
            visibleColumns.some(f =>
                (d?.[f] ?? "")
                    .toString()
                    .toLowerCase()
                    .includes(term)
            )
        );
    });

    // ----------------------------------------------------
    // Record Count
    // ----------------------------------------------------
    dataTable.on("dataFiltered", (_, rows) =>
        updateRecordCount(dataTable, rows, "Holiday_id")
    );

    dataTable.on("dataLoaded", data =>
        updateRecordCount(dataTable, data, "Holiday_id")
    );

    dataTable.on("tableBuilt", () => {
        const hide = [
            "Shift_id", "Holiday_id", "Holiday_type_id",
            "Is_deleted", "Created_at", "Updated_by",
            "Updated_at", "Version", "AdditionalProperties"
        ];
        hide.forEach(f => dataTable.hideColumn(f));
    });

    // ----------------------------------------------------
    // Modal Setup
    // ----------------------------------------------------
    const addEditModal = new bootstrap.Modal($("#addEditModal")[0]);
    const form = $("#addEditForm");

    // Add
    $("#add-btn").on("click", function () {

        currentMode = "Add";
        form[0].reset();

        $("#addEditModalLabel").text("Add Holiday Master");
        $("#modalSubmitBtn").text("Add");
        $("#Holiday_id").val(0);

        addEditModal.show();
    });

    // Edit
    $("#edit-btn").on("click", function () {

        const row = dataTable.getSelectedData()?.[0];

        if (!row) {
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Please select a row to edit."
            });
        }

        currentMode = "Edit";

        $("#addEditModalLabel").text("Edit Holiday Master");
        $("#modalSubmitBtn").text("Update");

        // Fill fields
        $.each(row, function (field, value) {

            const $el = $("#" + field);
            if (!$el.length) return;

            if ($el.attr("type") === "date" && value) {
                let d = new Date(value);
                $el.val(
                    `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`
                );
            }
            else {
                $el.val(value ?? "");
            }
        });

        addEditModal.show();
    });

    // Delete
    $("#delete-btn").on("click", async function () {

        const row = dataTable.getSelectedData()?.[0];

        if (!row) {
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Please select a row to delete."
            });
        }

        const confirm = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete Confirmation",
            text: "Are you sure you want to delete this record?"
        });

        if (!confirm.isConfirmed) return;

        const success = await deleteRecord("/HolidayMaster/Delete", { Holiday_id: row.Holiday_id });

        if (success) {
            setTimeout(() => location.reload(), 900);
        }
    });

    // Save (add/edit)
    form.on("submit", async function (e) {

        e.preventDefault();

        const formData = Object.fromEntries(new FormData(this).entries());
        const url = currentMode === "Add" ? "/HolidayMaster/Create" : "/HolidayMaster/Update";

        const success = await saveRecord(url, formData, currentMode, addEditModal, this);

        if (success) setTimeout(() => location.reload(), 900);
    });
     

    // ----------------------------------------------------
    // Upload button
    // ----------------------------------------------------
    $("#upload-btn").on("click", () => $("#upload-file").click());

    $("#upload-file").on("change", function (event) {

        const file = event.target.files?.[0];

        if (!file) {
            return showAppAlert({
                icon: "warning",
                title: "No File",
                text: "Please select a file to upload."
            });
        }

        if (!/\.(xlsx|xls)$/i.test(file.name)) {
            return showAppAlert({
                icon: "warning",
                title: "Invalid File",
                text: "Please upload Excel file (.xlsx or .xls)."
            });
        }

        uploadFile("/HolidayMaster/Upload", file);
    });
    // ----------------------------------------------------
    // Download XLSX
    // ----------------------------------------------------
  $("#download-btn").on("click", function () {

    let allRows = dataTable.getData();

    if (!allRows || allRows.length === 0) {
        return showAppAlert({
            icon: "warning",
            title: "No Data",
            text: "No records found to download."
        });
    }

   
    const visibleCols = dataTable.getColumns()
        .filter(col => col.isVisible())
        .map(col => ({
            field: col.getField(),
            title: col.getDefinition().title
        }));


    const finalRows = allRows.map(row => {
        let obj = {};
        visibleCols.forEach(col => {
            obj[col.title] = row[col.field] ?? "";
        });
        return obj;
    });


    downloadXlsx(finalRows, "HolidayMasterData");
});



});


// -------------------------------------------------------------
// Download Template (global)
// -------------------------------------------------------------
$("#download-template-btn").on("click", function () {

    const headers = [
        "Holiday Name",
        "Holiday Description",
        "Holiday Type",
        "Holiday Date"
    ];

    downloadTemplate(headers, "HolidayMasterTemplate");
});

 
// -------------------------------------------------------------
// Upload function (global)
// -------------------------------------------------------------
async function uploadFile(url, file) {

    const formData = new FormData();
    formData.append("file", file);

    const csrf = $('#afForm input[name="__RequestVerificationToken"]').val();

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: { "RequestVerificationToken": csrf },
            body: formData
        });

        await handleUploadResponse(response);

    } catch (err) {
        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: err.message
        });
    }
}



// -------------------------------------------------------------
// Upload response handler
// -------------------------------------------------------------
async function handleUploadResponse(response) {
    const result = await response.json().catch(() => null);

    $("#upload-file").val("");

    if (!result) {
        return Swal.fire({
            icon: "error",
            title: "Upload Failed",
            text: "Unexpected error."
        });
    }

    let successCount = 0, failedCount = 0;
    const countMatch = result.message.match(/Success:\s*(\d+),\s*Failed:\s*(\d+)/i);
    if (countMatch) {
        successCount = parseInt(countMatch[1]);
        failedCount = parseInt(countMatch[2]);
    }

    let iconType = failedCount > 0 ? "error" : "success";

    let htmlMsg = result.message;
    if (failedCount > 0 && result.downloadCsv) {
        htmlMsg += `<br/><a href='${result.downloadCsv}' target='_blank'>Click here to download CSV</a>`;
    }

    Swal.fire({
        icon: iconType,
        title: failedCount === 0 ? "Upload Completed" : "Upload Completed with some failures",
        html: htmlMsg,
        showConfirmButton: true
    }).then(() => {
        location.reload(); // 🔥 Refresh table after upload
    });
}

</script>
