@using Microsoft.AspNetCore.Mvc.Rendering
@{
    //  Read JSON payload for grid from ViewData
    var holidayMasterData = ViewData["HolidayMasterData"] ?? "[]";
    // set layout
    Layout = "_Layout";
}

<head>
    <!--  Keep head empty as per request (no changes to assets/includes) -->
</head>


<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
</style>
<div class="main-container">

    <!-- ---- Title Bar ---- -->
@*     <div id="pageTitle" class="col-12 text-center py-1 mb-3 page-title">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Holiday Master</h6>
    </div>
 *@
    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Holiday Master</h6>
    </div>

    <div class="row align-items-center mb-3">

        <!-- Spacer for small screens -->
        <div class="w-100 d-md-none"></div>

        <!-- ---- Top Button Section ---- -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

            <!-- Search Field -->
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;" />

            <!-- ---- Action Buttons ---- -->
            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">

                <!-- Add Button -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <!-- Edit Button -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <!-- Delete Button -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <!-- Download Button -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <!-- Upload Button -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <!-- Download Template Button -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <form id="afForm" style="display:none" method="post">
        @Html.AntiForgeryToken()
        <input type="file" id="upload-file" style="display:none" accept=".csv,text/csv" />
    </form>

    <!-- ---- Data Grid Area ---- -->
    <div id="holidayMasterTable" class="tabulator-bootstrap5"></div>
    @* <div id="recordCount" class="text-end mt-2 fw-semibold text-secondary"></div> *@
     <div id="recordCount" class="footer-total-records"></div>
</div>

<!-- ---- Add/Edit/Delete Modal ---- -->
<div class="modal fade" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <!-- ---- Modal Header ---- -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit Holiday</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>

            <!-- ---- Modal Body ---- -->
            <div class="modal-body">
                <form id="addEditForm">

                    <!-- Hidden ID Field -->
                    <input type="number" id="Holiday_id" name="Holiday_id" value="0" hidden />

                    <div class="row g-3">

                        <!-- Holiday Name -->
                        <div class="col-md-6">
                            <label for="Holiday_name" class="form-label">Holiday Name  <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text" class="form-control" id="Holiday_name" name="Holiday_name"
                                   required
                                   pattern="[A-Za-z0-9 ]+"
                                   title="Only letters, numbers, and spaces are allowed. No special characters.">
                        </div>


                        <!-- Holiday Date -->
                        <div class="col-md-6">
                            <label for="Holiday_date" class="form-label">Date  <span class="text-danger"><strong>*</strong></span></label>
                            <input type="date" class="form-control" id="Holiday_date" name="Holiday_date" required>
                        </div>

                        <!-- Holiday Type Dropdown -->
                        <div class="col-md-6">
                            <label for="Holiday_type_id" class="form-label">Holiday Type  <span class="text-danger"><strong>*</strong></span></label>
                            <select class="form-select" id="Holiday_type_id" name="Holiday_type_id"
                                    asp-items="@(ViewBag.HolidayTypeList as IEnumerable<SelectListItem>)" required>
                                <option value="" selected disabled>Select Holiday Type</option>
                            </select>
                        </div>

                        <!-- Description -->
                        <div class="col-md-6">
                            <label for="Description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="Description" name="Description">
                        </div>

                        <!-- Status Dropdown -->
                        <div class="col-md-6">
                            <label for="Status_id" class="form-label">Status  <span class="text-danger"><strong>*</strong></span></label>
                            <select class="form-select" id="Status_id" name="Status_id"
                                    asp-items="@(ViewBag.StatusList as IEnumerable<SelectListItem>)" required>
                                <option value="" selected disabled>Select Status</option>
                            </select>
                        </div>

                    </div>
                </form>
            </div>

            <!-- ---- Modal Footer ---- -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary-professional" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary-professional" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>

<script>


    document.addEventListener("DOMContentLoaded", () => {
        // ==========================
        // 🔹 Initialize reusable components
        // ==========================
        initTooltips(); // Bootstrap tooltips


        const holidayMasterData = JSON.parse('@Html.Raw(holidayMasterData)');
        let selectedRow = null;
        let currentMode = "";

        // ==========================
        // 🔹 Generate Tabulator columns dynamically
        // ==========================
       function generateTabulatorColumns(data) {
            if (!data || data.length === 0) return [];

            const fields = Object.keys(data[0]);

            // 🏷️ Custom aliases (you can edit these)
            const aliases = {
                Status_name: "Status",

            };

            const formatTitle = (str) => {
                let result = str.replace(/[_\-]/g, ' ');
                result = result.replace(/([a-z])([A-Z])/g, '$1 $2');
                return result.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            };

            return fields.map(field => ({
                title: aliases[field] || formatTitle(field),
                field: field,
                headerHozAlign: "center",
                hozAlign: "center",
                tooltip: true,
                resizable: true
            }));
        }

        // ==========================
        // 🔹 Initialize Tabulator
        // ==========================
        // const dataTable = initializeTabulator("#holidayMasterTable", holidayMasterData, generateTabulatorColumns(holidayMasterData),
        //     (data) => selectedRow = data[0] || null
        // );
        const dataTable = new Tabulator("#holidayMasterTable", {
	            data: holidayMasterData,
	        
                 columns: [
                    { title: "Holiday Name", field: "Holiday_name", width: 220 },
                    { title: "Holiday Date", field: "Holiday_date", width: 220 },
                    { title: "Holiday Type Name", field: "Holiday_type_name", width: 220 },
                    { title: "Description", field: "Description", width: 220 },
                    { title: "Status", field: "Status_name", width: 220 , formatter: function (cell) {
                        let val = cell.getValue();

                        return val === true || val === "true"
                            ? "<span>In-Active</span>"
                            : "<span>Active</span>";
                    }},
                    { title: "Created By", field: "Created_by", width: 150},
                ],
	            layout: "fitDataStretch",
	            height: "80vh",
	            selectable: 1,
	            pagination: "local",
	            resizableRows:false,
	            resizableRowGuide:false,
	            resizableColumnGuide:false,
	            columnDefaults:{
		            resizable:false,
	            },           
	            movableColumns: false,
	            paginationSize: 10,
	            paginationSizeSelector: [5, 10, 20, 50, 100],
	             locale: true,
	            langs: {
		            "en": {
	            pagination: {
		            first: "<<",
		            first_title: "First",
		            last: ">>", 
		            last_title: "Last", 
		            prev: "<", 
		            prev_title: "Prev",
		            next: ">", 
		            next_title: "Next", 
		            page_size: "Page Size" 
		             }
		            }
	             },

	            rowClick: function (e, row) {
	              selectedRow = row.getData();
	            }
	            });


        // Command: Live search (visible columns only) for parent table
        document.getElementById("searchField").addEventListener("input", function () {
            var searchTerm = this.value.toLowerCase();

            // Command: Collect visible fields
            var visibleColumns = dataTable.getColumns()
                                      .filter(col => col.isVisible())
                                      .map(col => col.getField());

            // Command: Apply per-row predicate filter
            dataTable.setFilter(function (data) {
                return visibleColumns.some(field => {
                    var value = data[field];
                    return value != null && value.toString().toLowerCase().includes(searchTerm);
                });
            });
        });
    //        // Update record count after filtering
    // dataTable.on("dataFiltered", function(filters, rows){
    //     document.getElementById("recordCount").innerText = "Total Records: " + rows.length;
    // });


    // // Initial load
    // dataTable.on("dataLoaded", function(data) {
    //     document.getElementById("recordCount").innerText = "Total Records: " + data.length;
    // });

       // Record count for filtered data
     dataTable.on("dataFiltered", function(filters, rows) {
           updateRecordCount(dataTable, rows, "Holiday_id");  // Pass the field name >>replace with your table primary id column
     });

     // Record count for loaded data
     dataTable.on("dataLoaded", function(data) {
           updateRecordCount(dataTable, data, "Holiday_id");  // Pass the field name >>replace with your table primary id column
     });

    dataTable.on("tableBuilt", function(){
        const hideFields = [
               "Shift_id",
               "Holiday_id",
               "Holiday_type_id",
              "Status_id",
              "Is_deleted",
              "Created_at",
              "Updated_by",
              "Updated_at",
              "Version",
              "AdditionalProperties"
        ];

        hideFields.forEach(field => dataTable.hideColumn(field));
    });

           const addEditModalEl = document.getElementById('addEditModal');
        const addEditModal = new bootstrap.Modal(addEditModalEl);
        const form = document.getElementById("addEditForm");

        // ==========================
        // 🔹 Add Button
        // ==========================
        document.getElementById("add-btn").addEventListener("click", () => {
            currentMode = "Add";
            form.reset();
            document.getElementById("addEditModalLabel").textContent = "Add Holiday Master";
            document.getElementById("modalSubmitBtn").textContent = "Add";
            document.getElementById("Holiday_id").value=0;
            addEditModal.show();
        });

        // ==========================
        // 🔹 Edit Button
        // ==========================
           document.getElementById("edit-btn").addEventListener("click", () => {
        const selectedRow = dataTable.getSelectedData()?.[0];
        if (!selectedRow) {
            return showAppAlert({ icon: 'warning', title: 'No Selection', text: 'Please select a row to edit.' });
        }

        currentMode = "Edit";
        document.getElementById("addEditModalLabel").textContent = "Edit Holiday Master";
        document.getElementById("modalSubmitBtn").textContent = "Update";

        // Populate modal form fields dynamically
        Object.keys(selectedRow).forEach(field => {
            const EmployeeMasterField = document.getElementById(field);
            if (!EmployeeMasterField) return;

            if (EmployeeMasterField.type === "date" && selectedRow[field]) {
                const date = new Date(selectedRow[field]);
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                EmployeeMasterField.value = `${yyyy}-${mm}-${dd}`;
            } else {
                // For text, number, email, etc.
                EmployeeMasterField.value = selectedRow[field] ?? "";
            }
        });

        addEditModal.show();
    });

        // ==========================
        // 🔹 Delete Button
        // ==========================

        document.getElementById("delete-btn").addEventListener("click", async () => {
            const selectedRow = dataTable.getSelectedData()?.[0];
            if (!selectedRow) {
                return showAppAlert({ icon: "warning", title: "No Selection", text: "Please select a row to delete." });
            }

            const holidayId = selectedRow.Holiday_id;

            const confirm = await showAppAlert({
                type: "confirm",
                icon: "question",
                title: "Delete Confirmation",
                text: "Are you sure you want to delete this record?"
            });

            if (!confirm.isConfirmed) return;

            const success = await deleteRecord("/HolidayMaster/Delete", { Holiday_id: holidayId }); // method defaults to PUT
            if (success) {
                // redirect or refresh your table
                setTimeout(() => { window.location.href = "/HolidayMaster/Index"; }, 900);
                // or: dataTable.replaceData();
            }
        });

        // ==========================
        // 🔹 Form Submit (Add/Edit)
        // ==========================
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = Object.fromEntries(new FormData(form).entries());

            const fetchUrl = currentMode === "Add" ? "/HolidayMaster/Create" : "/HolidayMaster/Update";

            const success = await saveRecord(fetchUrl, formData, currentMode, addEditModal, form);
            if (success) {
                setTimeout(() => {
                    window.location.href = "/HolidayMaster/Index";
                }, 900);
            }
        });


        // ==========================
        // 🔹 Download Template
        // ==========================
        // document.getElementById("download-template-btn").addEventListener("click", () =>
        //     downloadCsvTemplate(dataTable, "HolidayMasterTemplate")
        // );
               document.getElementById("download-btn").addEventListener("click", function () {

       let rowCount = dataTable.getDataCount ? dataTable.getDataCount() : dataTable.getData().length;

     if (rowCount === 1) {
         let firstRowData = dataTable.getData()[0];
         let firstRowFieldValue = firstRowData ? firstRowData["Holiday_id"] : null;
         if (firstRowFieldValue === null || firstRowFieldValue === 0 || firstRowFieldValue === "") {
             rowCount = 0;
         }
     }
     if (rowCount === 0) {
         showAppAlert({
             icon: 'warning',
             title: 'No Data',
             text: 'No records found to download.'
         });
         return; // Stop further execution
     }

        downloadCsv(dataTable, "HolidayMasterTemplate.csv");
    });

                // Helper: get anti-forgery token value from hidden form
      function getRequestVerificationToken() {
        const tokenInput = document.querySelector('#afForm input[name="__RequestVerificationToken"]');
        return tokenInput ? tokenInput.value : null;
      }

    //   Click -> open chooser
    //   document.getElementById("upload-btn").addEventListener("click", () => {
    //     document.getElementById("upload-file").click();
    //   });

    //       Event listener to handle file selection
    // document.getElementById("upload-file").addEventListener("change", function (event) {
    //     const fileInput = event.target;
    //     if (!fileInput.files || fileInput.files.length === 0) {
    //         return showAppAlert({ icon: 'warning', title: 'No File', text: 'Please select a file to upload.' });
    //     }
    //     const file = fileInput.files[0];

    //     Client-side CSV guards
    //     const extOk = /\.csv$/i.test(file.name);
    //     const type = (file.type || '').toLowerCase();
    //     const typeOk = type.includes('csv') || type === 'application/vnd.ms-excel'; some browsers
    //     if (!extOk && !typeOk) {
    //         showAppAlert({ icon: 'warning', title: 'Invalid File', text: 'Please select a .csv file.' });
    //         fileInput.value = ''; Clear the file input
    //         return;
    //     }

    //     Proceed with uploading the file
    //     const url = '/HolidayMaster/Upload';  Ensure this matches the controller route
    //     uploadFile(url, file);
    // });

    // Call this function after submitting the form
    // async function uploadFile(url, file) {
    //     const formData = new FormData();
    //     formData.append("file", file);

    //     Get the CSRF token from the page
    //     const csrfToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

    //     try {
    //         const response = await fetch(url, {
    //             method: 'POST',
    //             headers: {
    //                 'RequestVerificationToken': csrfToken Add CSRF token in the header
    //             },
    //             body: formData  Attach the file to FormData
    //         });

    //        await handleUploadResponse(response);  Handle response

    //        console.log(response);

    //     } catch (error) {
    //         alert('An error occurred while uploading the file.');
    //     }
    // }

    //    async function handleUploadResponse(response) {
    //     if (response.ok) {
    //         const result = await response.json();
    //         showAppAlert({ icon: 'success', title: result.title, text: result.message });

    //         If invalid records exist, trigger the download of the CSV file
    //         if (result.invalidRecords) {
    //             const invalidRecordsFileData = result.invalidRecords;
    //             downloadInvalidRecords(invalidRecordsFileData); Trigger the download
    //         }
    //     } else {
    //         const error = await response.json();
    //         showAppAlert({ icon: 'error', title: error.title, text: error.message });
    //     }
    // }

    // function downloadInvalidRecords(fileData) {
    //     Decode the base64 CSV data and create a Blob
    //     const csvData = atob(fileData); Decode base64 string to CSV
    //     const blob = new Blob([csvData], { type: 'text/csv' });  Create a Blob of CSV data
    //     const link = document.createElement('a');
    //     link.href = URL.createObjectURL(blob);  Create a URL for the Blob
    //     link.download = 'invalid_records.csv';  Set the file name
    //     link.click();  Trigger the download
    // }

    });
</script>