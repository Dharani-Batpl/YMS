@using Microsoft.AspNetCore.Mvc.Rendering
@{
    //  Read JSON payload for grid from ViewData
    var holidayMasterData = ViewData["HolidayMasterData"] ?? "[]";
    // set layout
    Layout = "_Layout";
}

<head>
    <!--  Keep head empty as per request (no changes to assets/includes) -->
</head>


<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
</style>
<div class="main-container">


    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Holiday Master</h6>
    </div>

    <div class="row align-items-center mb-3">

        <!-- Spacer for small screens -->
        <div class="w-100 d-md-none"></div>

        <!-- ---- Top Button Section ---- -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

            <!-- Search Field -->
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;" />

            <!-- ---- Action Buttons ---- -->
            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">

                <!-- Add Button -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <!-- Edit Button -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <!-- Delete Button -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <!-- Download Button -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <!-- Upload Button -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <!-- Download Template Button -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <form id="afForm" style="display:none" method="post">
        @Html.AntiForgeryToken()
        <input type="file" id="upload-file" style="display:none" accept=".xls,.xlsx" />
    </form>

    <!-- ---- Data Grid Area ---- -->
    <div id="holidayMasterTable" class="tabulator-bootstrap5"></div>
    @* <div id="recordCount" class="text-end mt-2 fw-semibold text-secondary"></div> *@
     <div id="recordCount" class="footer-total-records"></div>
</div>

<!-- ---- Add/Edit/Delete Modal ---- -->
<div class="modal fade modal-request" id="addEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit Holiday</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                <form id="addEditForm" autocomplete="off">

                    <input type="hidden" id="Holiday_id" name="Holiday_id" />

                    <!-- Row 1 -->
                    <div class="row g-3 mt-1 mb-2">

                        <!-- Holiday Name -->
                        <div class="col-md-6">
                            <label class="form-label">Holiday Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control"
                                   id="Holiday_name" name="Holiday_name"
                                     style="width: 250px;"
                                   required maxlength="25"
                                   pattern="[A-Za-z0-9 ]+"
                                   title="Only letters, numbers, and spaces allowed">
                        </div>

                        <!-- Holiday Date -->
                        <div class="col-md-6">
                            <label class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control"
                                   id="Holiday_date" style="width: 250px;" name="Holiday_date" required>
                        </div>

                    </div>

                    <!-- Row 2 -->
                    <div class="row g-3 mt-1 mb-2">

                        <!-- Holiday Type -->
                        <div class="col-md-6">
                            <label class="form-label">Holiday Type <span class="text-danger">*</span></label>
                            <select class="form-select"
                                    id="Holiday_type_id"  style="width: 250px;" name="Holiday_type_id"
                                    required
                                    asp-items="@(ViewBag.HolidayTypeList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Holiday Type</option>
                            </select>
                        </div>

                        <!-- Description -->
                        <div class="col-md-6">
                            <label class="form-label">Description</label>
                            <textarea class="form-control"
                                  id="Description"
                                  name="Description"
                                  rows="2"
                                  style="width: 250px; resize: vertical;"
                                  maxlength="100"></textarea>
                        </div>

                    </div>

                </form>

            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" id="modalSubmitBtn" form="addEditForm" class="btn btn-submit">Add</button>
            </div>

        </div>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {

    initTooltips(); // Bootstrap tooltips

    // Disable past dates
    const dateField = document.getElementById("Holiday_date");
    const today = new Date().toISOString().split("T")[0];
    dateField.setAttribute("min", today);

    const holidayMasterData = JSON.parse('@Html.Raw(holidayMasterData)');
    let selectedRow = null;
    let currentMode = "";

    // ----------------------------------------------------
    //  Tabulator table
    // ----------------------------------------------------
    const dataTable = new Tabulator("#holidayMasterTable", {
        data: holidayMasterData,
        columns: [
            { title: "Holiday Name", field: "Holiday_name", width: 220 },
            { title: "Holiday Date", field: "Holiday_date", width: 220 },
            { title: "Holiday Type Name", field: "Holiday_type_name", width: 220 },
            { title: "Description", field: "Description", width: 220 },
            { title: "Created By", field: "Created_by", width: 150 },
        ],
        layout: "fitDataStretch",
        height: "80vh",
        selectable: 1,
        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],
        resizableRows: false,
        movableColumns: false,
        rowClick: function (e, row) {
            selectedRow = row.getData();
        }
    });

    // ----------------------------------------------------
    // Search
    // ----------------------------------------------------
    document.getElementById("searchField").addEventListener("input", function () {
        const term = this.value.toLowerCase();
        const visibleColumns = dataTable.getColumns()
            .filter(col => col.isVisible())
            .map(col => col.getField());

        dataTable.setFilter(function (data) {
            return visibleColumns.some(field => {
                const v = data[field];
                return v != null && v.toString().toLowerCase().includes(term);
            });
        });
    });

    // ----------------------------------------------------
    // Record Count
    // ----------------------------------------------------
    dataTable.on("dataFiltered", (filters, rows) => {
        updateRecordCount(dataTable, rows, "Holiday_id");
    });

    dataTable.on("dataLoaded", (data) => {
        updateRecordCount(dataTable, data, "Holiday_id");
    });

    dataTable.on("tableBuilt", () => {
        const hide = [
            "Shift_id", "Holiday_id", "Holiday_type_id",
            "Is_deleted", "Created_at", "Updated_by",
            "Updated_at", "Version", "AdditionalProperties"
        ];
        hide.forEach(f => dataTable.hideColumn(f));
    });

    // ----------------------------------------------------
    // Modal
    // ----------------------------------------------------
    const addEditModalEl = document.getElementById("addEditModal");
    const addEditModal = new bootstrap.Modal(addEditModalEl);
    const form = document.getElementById("addEditForm");

    // Add
    document.getElementById("add-btn").addEventListener("click", () => {
        currentMode = "Add";
        form.reset();
        document.getElementById("addEditModalLabel").textContent = "Add Holiday Master";
        document.getElementById("modalSubmitBtn").textContent = "Add";
        document.getElementById("Holiday_id").value = 0;
        addEditModal.show();
    });

    // Edit
    document.getElementById("edit-btn").addEventListener("click", () => {
        const row = dataTable.getSelectedData()?.[0];
        if (!row) {
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Please select a row to edit."
            });
        }

        currentMode = "Edit";
        document.getElementById("addEditModalLabel").textContent = "Edit Holiday Master";
        document.getElementById("modalSubmitBtn").textContent = "Update";

        Object.keys(row).forEach(field => {
            const el = document.getElementById(field);
            if (!el) return;

            if (el.type === "date" && row[field]) {
                const d = new Date(row[field]);
                el.value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
            } else {
                el.value = row[field] ?? "";
            }
        });

        addEditModal.show();
    });

    // Delete
    document.getElementById("delete-btn").addEventListener("click", async () => {
        const row = dataTable.getSelectedData()?.[0];
        if (!row) {
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Please select a row to delete."
            });
        }

        const confirm = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete Confirmation",
            text: "Are you sure you want to delete this record?"
        });

        if (!confirm.isConfirmed) return;

        const success = await deleteRecord("/HolidayMaster/Delete", { Holiday_id: row.Holiday_id });

        if (success) {
            setTimeout(() => location.reload(), 900);
        }
    });

    // Save (Add/Edit)
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(form).entries());

        const url = currentMode === "Add" ? "/HolidayMaster/Create" : "/HolidayMaster/Update";

        const success = await saveRecord(url, formData, currentMode, addEditModal, form);

        if (success) {
            setTimeout(() => location.reload(), 900);
        }
    });

    // ----------------------------------------------------
    // Download CSV (actual data)
    // ----------------------------------------------------
    document.getElementById("download-btn").addEventListener("click", () => {

        let rowCount = dataTable.getData().length;

        if (rowCount === 1) {
            const rowVal = dataTable.getData()[0]?.Holiday_id;
            if (!rowVal) rowCount = 0;
        }

        if (rowCount === 0) {
            return showAppAlert({
                icon: "warning",
                title: "No Data",
                text: "No records found to download."
            });
        }

        downloadCsv(dataTable, "HolidayMaster.csv");
    });
 // ================================================================
//  Upload button click
// ================================================================
$("#upload-btn").on("click", function () {
    $("#upload-file").click();
});

// ================================================================
//  File selection handler
// ================================================================
$("#upload-file").on("change", function (event) {
    const file = event.target.files?.[0];

    if (!file) {
        return showAppAlert({
            icon: 'warning',
            title: 'No File',
            text: 'Please select a file to upload.'
        });
    }

    const isExcel = /\.(xlsx|xls)$/i.test(file.name);
    if (!isExcel) {
        showAppAlert({
            icon: 'warning',
            title: 'Invalid File',
            text: 'Please upload Excel file (.xlsx or .xls).'
        });
        return;
    }

    uploadFile('/HolidayMaster/Upload', file);
});

}); 
// -------------------------------------------------------------
// Download Template (this MUST be outside DOMContentLoaded)
// -------------------------------------------------------------
$("#download-template-btn").on("click", function () {
    const headers = [
        "Holiday Name",
        "Holiday Description",
        "Holiday Type",
        "Holiday Date"
    ];

    downloadTemplate(headers, "HolidayMasterTemplate");
});
// ================================================================
//  Upload function (global, so onclick can find it)
// ================================================================
async function uploadFile(url, file) {

    const formData = new FormData();
    formData.append("file", file);

    const csrf = $('#afForm input[name="__RequestVerificationToken"]').val();

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'RequestVerificationToken': csrf },
            body: formData
        });

        await handleUploadResponse(response);

    } catch (err) {
        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: err.message
        });
    }
}

// ================================================================
//  Handle upload response
// ================================================================
async function handleUploadResponse(response) {

    const result = await response.json().catch(() => null);

    if (response.ok) {
        showAppAlert({
            icon: "success",
            title: result.title || "Upload Successful",
            text: result.message || "Excel uploaded successfully.",
            timer: 2000,
            showConfirmButton: false
        });

        setTimeout(() => location.reload(), 900);
        $("#upload-file").val("");
        return;
    }

    if (result?.errors) {
        let msg = "";
        result.errors.forEach(e => msg += `${e.error}\n`);

        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: msg
        });

        $("#upload-file").val("");
        return;
    }

    showAppAlert({
        icon: "error",
        title: "Upload Failed",
        text: result?.message || "Unexpected error occurred."
    });

    $("#upload-file").val("");
}


</script>
