@using Microsoft.AspNetCore.Mvc.Rendering
@{
    //  Read JSON payload for grid from ViewData
    var vehicleModelData = ViewData["VehicleModelData"] ?? "[]";
    Layout = "_Layout";
}

<head>
    <!--  Keep head empty as per request (no changes to assets/includes) -->
</head>

<div class="container">
    <!--  Page title header -->
@*     <div id="pageTitle" class="col-12 text-center py-1 mb-3">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Vehicle Variant Master</h6>
    </div>
 *@
    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide"> Vehicle Variant Master</h6>
    </div>


    <!--  Toolbar row with search + action buttons -->
    <div class="row align-items-center mb-3">
        <!--  Spacer on small devices -->
        <div class="w-100 d-md-none"></div>

        <!--  Right-aligned tools on md+ -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">
            <!--  Global search input -->
            <input type="search"
                   id="searchField"
                   class="form-control form-control-sm"
                   placeholder="Search..."
                   style="max-width: 280px; min-width: 150px;" />

            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">
                <!--  Add row -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <!--  Edit selected row -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <!--  Delete selected row -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <!--  Download CSV -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <!--  Upload CSV -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3"
                        title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <!--  Download CSV template -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" 
                        title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Anti-forgery token source (hidden) -->
    <form id="afForm" style="display:none" method="post">
          @Html.AntiForgeryToken()
    <input type="file" id="upload-file" style="display:none" accept=".csv,text/csv" />
    </form>

    <!--  Tabulator grid mount point -->
    <div id="vehicleModelTable" class="tabulator-bootstrap5"></div>

    <div id="recordCount" class="text-end mt-2 fw-semibold text-secondary"></div>
</div>

<!--  Add/Edit modal (single form reused for both modes) -->
<div class="modal fade" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <!--  Modal header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit User</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>

            <div class="modal-body">
                <!-- Form to Add/Edit Vehicle Model -->
                <form id="addEditForm">
                    <!-- Hidden input to hold the unique Model ID (used during editing) -->
                    <input type="hidden" id="Variant_id" name="Variant_id" />
                    <!-- Responsive row layout using Bootstrap grid -->
                    <div class="row g-3">
                        <!-- ========================= Model Code ========================= -->
                        <div class="col-md-4">
                            <label for="Variant_code" class="form-label">Variant Code <span class="text-danger"><strong>*</strong></span></label>
                            <!-- Unique identifier or short code for the vehicle model -->
                            <input type="text" class="form-control" id="Variant_code" name="Variant_code" required>
                        </div>
                        <!-- ========================= Model Name ========================= -->
                        <div class="col-md-4">
                            <label for="Variant_name" class="form-label">Variant Name <span class="text-danger"><strong>*</strong></span></label>
                            <!-- Full name of the vehicle model -->
                            <input type="text" class="form-control" id="Variant_name" name="Variant_name" required>
                        </div>
                        <!-- ========================= Brand Name Dropdown ========================= -->
                        <div class="col-md-4">
                            <label for="Brand_id" class="form-label">Brand Name <span class="text-danger"><strong>*</strong></span></label>
                            <!-- Dropdown list of available brands -->
                            <select class="form-select" id="Brand_id" name="Brand_id" required
                                    asp-items="@(ViewBag.BrandNameList as IEnumerable<SelectListItem>)">
                                <option value="" selected disabled>Select Brand Name</option>
                            </select>
                        </div>

                        @* <!-- ========================= Vehicle Type Dropdown ========================= -->
                        <div class="col-md-4">
                            <label for="Vehicle_type_id" class="form-label">Vehicle Type</label>
                            <!-- Dropdown list for vehicle type (e.g., SUV, Sedan, Truck) -->
                            <select class="form-control" id="Vehicle_type_id" name="Vehicle_type_id"
                                    asp-items="@(ViewBag.VehicleTypeList as IEnumerable<SelectListItem>)">
                                <option value="" selected disabled>Select Vehicle Type</option>
                            </select>
                        </div> *@

                        <div class="col-md-4">
                            <label for="vehicle_type_id" class="form-label">Vehicle Type <span class="text-danger"><strong>*</strong></span></label>
                            <select class="form-select" id="vehicle_type_id" name="vehicle_type_id" required>
                                <option value="" selected disabled>Select Vehicle Type</option>
                            </select>
                        </div>

                        <!-- ========================= Model Year Dropdown ========================= -->
                        <div class="col-md-4">
                            <label for="Model_year" class="form-label">Model Year <span class="text-danger"><strong>*</strong></span></label>
                            <!-- Dropdown for selecting the production year of the model -->
                            <select class="form-select" id="Model_year" name="Model_year" required
                                    asp-items="@ViewBag.ModelYearList">
                                <option value="" selected disabled>Select Model Year</option>
                            </select>
                        </div>

                        <!-- ========================= WMI Code ========================= -->
                        <!-- Optional: Uncomment this block if WMI code should come from dropdown instead of manual input -->
                        @*
                        <div class="col-md-6">
                            <label for="Wmi_code" class="form-label">WMI Code</label>
                            <select class="form-control" id="Wmi_code" name="Wmi_code"
                                    asp-items="@(ViewBag.WMICodeList as IEnumerable<SelectListItem>)">
                                <option value="" selected disabled>Select WMI Code</option>
                            </select>
                        </div>
                        *@

                        <!-- Manual Input for WMI Code -->
                        <div class="col-md-4">
                            <label for="Wmi_code" class="form-label">WMI Code <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text" class="form-control" id="Wmi_code" name="Wmi_code" maxlength="3" required>
                            <small class="form-text text-muted">
                                Allowed: A-Z, 0-9 • 3 characters
                            </small>
                        </div>

                        <!-- ========================= Vehicle Attributes ========================= -->
                        <div class="col-md-4">
                            <label for="Attr_4_8" class="form-label">Vehicle Attributes <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text" class="form-control" id="Attr_4_8" name="Attr_4_8" maxlength="3" required>
                            <small class="form-text text-muted">
                                Allowed: A-Z, 0-9 • 3 characters
                            </small>
                        </div>

                        <!-- ========================= Check Digit ========================= -->
                        <div class="col-md-4">
                            <label for="Check_digit" class="form-label">Check Digit <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text" class="form-control" id="Check_digit" name="Check_digit" maxlength="1" required>
                            <small class="form-text text-muted">
                                Single character: A-Z or 0-9
                            </small>
                        </div>

                        <!-- ========================= Plant Code ========================= -->
                        <div class="col-md-4">
                            <label for="Plant_code" class="form-label">Plant Code <span class="text-danger"><strong>*</strong></span></label>
                            <input type="text" class="form-control" id="Plant_code" name="Plant_code" maxlength="3" required>
                            <small class="form-text text-muted">
                                Allowed: A-Z, 0-9 • 3 characters
                            </small>
                        </div>

                        <!-- ========================= VIN Prefix ========================= -->
                        @* <div class="col-md-4">
                            <label for="Vin_prefix" class="form-label">VIN Prefix</label>
                            <input type="text" class="form-control" id="Vin_prefix" name="Vin_prefix">
                        </div> *@

                        <!-- ========================= Next Sequence Count ========================= -->
                        <div class="col-md-4">
                            <label for="Next_sequence_cnt" class="form-label">Next Sequences Count <span class="text-danger"><strong>*</strong></span></label>
                            <input type="number" class="form-control" id="Next_sequence_cnt" name="Next_sequence_cnt" maxlength="6" pattern="\d{0,6}" required>
                            <small class="form-text text-muted">
                                6 digits, auto-padded with leading zeros
                            </small>
                        </div>

                        <!-- =========================  ========================= -->
                        @* <div class="col-md-4">
                            <label for="Seq_pad_length_cnt" class="form-label">Sequence Pad Length</label>
                            <input type="number" class="form-control" id="Seq_pad_length_cnt" name="Seq_pad_length_cnt">
                        </div> *@

                        <!-- ========================= Status Dropdown ========================= -->
                        <div class="col-md-4">
                            <label for="Status_id" class="form-label">Status <span class="text-danger"><strong>*</strong></span></label>
                            <!-- Dropdown for selecting model status (e.g., Active, Inactive) -->
                            <select class="form-select" id="Status_id" name="Status_id" required
                                    asp-items="@(ViewBag.StatusList as IEnumerable<SelectListItem>)">
                                <option value="" selected disabled>Select Status</option>
                            </select>
                        </div>

                        <!-- ========================= Description Field ========================= -->
                        <div class="col-md-4">
                            <label for="Description" class="form-label">Description</label>
                            <!-- Optional text field for describing the model -->
                            <input type="text" class="form-control" id="Description" name="Description">
                        </div>
                    </div> <!-- End of row -->
                </form> <!-- End of form -->
            </div>
            <!-- End

            <!--  Modal footer with actions -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary-professional" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary-professional" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>

<script>

    document.addEventListener("DOMContentLoaded", () => {
        // ==========================
        // 🔹 Initialize reusable components
        // ==========================
        initTooltips(); // Bootstrap tooltips

        const vehicleModelData = JSON.parse('@Html.Raw(vehicleModelData)');
        let selectedRow = null;
        let currentMode = "";

        // ==========================
        // 🔹 Generate Tabulator columns dynamically
        // ==========================
        function generateTabulatorColumns(data) {
            if (!data || data.length === 0) return [];

            const fields = Object.keys(data[0]);

            // 🏷️ Custom aliases (you can edit these)
            const aliases = {
                Wmi_code: "WMI Code",
                Vin_prefix: "VIN ID",
                Attr_4_8: "Attributes",
                Next_sequence_cnt: "Next Sequence Count",
                Status_name:"Status"
            };

            const formatTitle = (str) => {
                let result = str.replace(/[_\-]/g, ' ');
                result = result.replace(/([a-z])([A-Z])/g, '$1 $2');
                return result.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            };

            return fields.map(field => ({
                title: aliases[field] || formatTitle(field),
                field: field,
                headerHozAlign: "center",
                hozAlign: "center",
                tooltip: true,
                resizable: true
            }));
        }

        // ==========================
        // 🔹 Initialize Tabulator
        // ==========================
        const dataTable = initializeTabulator("#vehicleModelTable", vehicleModelData, generateTabulatorColumns(vehicleModelData),
            (data) => selectedRow = data[0] || null
        );

        // Command: Live search (visible columns only) for parent table
        document.getElementById("searchField").addEventListener("input", function () {
            var searchTerm = this.value.toLowerCase();

            // Command: Collect visible fields
            var visibleColumns = dataTable.getColumns()
                                      .filter(col => col.isVisible())
                                      .map(col => col.getField());

            // Command: Apply per-row predicate filter
            dataTable.setFilter(function (data) {
                return visibleColumns.some(field => {
                    var value = data[field];
                    return value != null && value.toString().toLowerCase().includes(searchTerm);
                });
            });
        });

                  // Record count for filtered data
             dataTable.on("dataFiltered", function(filters, rows) {
                   updateRecordCount(dataTable, rows, "Variant_id");  // Pass the field name >>replace with your table primary id column
             });

             // Record count for loaded data
             dataTable.on("dataLoaded", function(data) {
                   updateRecordCount(dataTable, data, "Variant_id");  // Pass the field name >>replace with your table primary id column
             });


            dataTable.on("tableBuilt", function(){
        const hideFields = [
                "Vehicle_type_id",
                "Brand_id",
                "Status_id",
                "Is_deleted",
                "Created_at",
                "Updated_by",
                "Updated_at",
                "Version",
                "Variant_id",
                "Seq_pad_length_cnt",
                "AdditionalProperties"
        ];

        hideFields.forEach(field => dataTable.hideColumn(field));
    });

        const addEditModalEl = document.getElementById('addEditModal');
        const addEditModal = new bootstrap.Modal(addEditModalEl);
        const form = document.getElementById("addEditForm");

        // ==========================
        // 🔹 Add Button
        // ==========================
        document.getElementById("add-btn").addEventListener("click", () => {
            currentMode = "Add";
            form.reset();
            document.getElementById("addEditModalLabel").textContent = "Add Vehicle Variant Master";
            document.getElementById("modalSubmitBtn").textContent = "Add";
            document.getElementById("Variant_id").value = 0;
            addEditModal.show();
        });

        // ==========================
        // 🔹 Edit Button
        // ==========================
        document.getElementById("edit-btn").addEventListener("click", () => {
        const selectedRow = dataTable.getSelectedData()?.[0];
        if (!selectedRow) {
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Please select a row to edit."
            });
        }

        currentMode = "Edit";
        document.getElementById("addEditModalLabel").textContent = "Edit Vehicle Variant Master";
        document.getElementById("modalSubmitBtn").textContent = "Update";

        // Fill simple fields directly
        Object.keys(selectedRow).forEach(field => {
            const el = document.getElementById(field);
            if (el) {
                if (el.type === "datetime-local" && selectedRow[field]) {
                    el.value = new Date(selectedRow[field]).toISOString().slice(0, 16);
                } else {
                    el.value = selectedRow[field] ?? "";
                }
            }
        });

        // ✅ Handle dependent dropdown: Vehicle Type
        const brandId = selectedRow.Brand_id;

        if (brandId) {
            fetch(`/VehicleModel/GetVehicleType?brandId=${brandId}`)
                .then(res => {
                    if (!res.ok) throw new Error("Error loading vehicle types");
                    return res.json();
                })
                .then(data => {
                    // Populate and preselect based on selectedRow.Vehicle_type_id or name
                    populateDropdown(
                        "vehicle_type_id",
                        data.variantList,
                        "Select Vehicle Type",
                        selectedRow.Vehicle_type_id || selectedRow.Vehicle_type_name
                    );
                })
                .catch(err => console.error("Error fetching vehicle types:", err));
        }

        addEditModal.show();
    });


        // ==========================
        // 🔹 Delete Button
        // ==========================

        document.getElementById("delete-btn").addEventListener("click", async () => {
            const selectedRow = dataTable.getSelectedData()?.[0];
            if (!selectedRow) {
                return showAppAlert({ icon: "warning", title: "No Selection", text: "Please select a row to delete." });
            }

            const VariantId = selectedRow.Variant_id;

            const confirm = await showAppAlert({
                type: "confirm",
                icon: "question",
                title: "Delete Confirmation",
                text: "Are you sure you want to delete this record?"
            });

            if (!confirm.isConfirmed) return;

            const success = await deleteRecord("/VehicleModel/Delete", { variant_id: VariantId }); // method defaults to PUT
            if (success) {
                // redirect or refresh your table
                setTimeout(() => { window.location.href = "/VehicleModel/Index"; }, 900);
                // or: dataTable.replaceData();
            }
        });

        // ==========================
        // 🔹 Form Submit (Add/Edit)
        // ==========================
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = Object.fromEntries(new FormData(form).entries());
            var selectedModelYear = document.getElementById('Model_year');
            formData.model_year_code = selectedModelYear.options[selectedModelYear.selectedIndex].text;

            const fetchUrl = currentMode === "Add" ? "/VehicleModel/Create" : "/VehicleModel/Update";

            const success = await saveRecord(fetchUrl, formData, currentMode, addEditModal, form);
            if (success) {
                setTimeout(() => {
                    window.location.href = "/VehicleModel/Index";
                }, 900);
            }
        });




       document.getElementById("download-btn").addEventListener("click", function () {

       let rowCount = dataTable.getDataCount ? dataTable.getDataCount() : dataTable.getData().length;

     if (rowCount === 1) {
         let firstRowData = dataTable.getData()[0];
         let firstRowFieldValue = firstRowData ? firstRowData["variant_id"] : null;
         if (firstRowFieldValue === null || firstRowFieldValue === 0 || firstRowFieldValue === "") {
             rowCount = 0;
         }
     }
     if (rowCount === 0) {
         showAppAlert({
             icon: 'warning',
             title: 'No Data',
             text: 'No records found to download.'
         });
         return; // Stop further execution
     }

        downloadCsv(dataTable, "VehicleVariant.csv");
    });

        

    //     // ==========================
    //     // 🔹 Download Template
    //     // ==========================
    //     document.getElementById("download-template-btn").addEventListener("click", () =>
    //         downloadCsvTemplate(dataTable, "VehicleModelTemplate")
    //     );

        document.getElementById('Brand_id').addEventListener('change', function () {
            const brandId = this.value;
            console.log("Selected brand:", brandId);

            fetch(`/VehicleModel/GetVehicleType?brandId=${brandId}`)
                .then(res => {
                    if (!res.ok) throw new Error("Network error while loading vehicle types");
                    return res.json();
                })
                .then(data => {
                    console.log("Vehicle types:", data);
                    populateDropdown('vehicle_type_id', data.variantList, 'Select Vehicle Type');
                })
                .catch(err => console.error("Error fetching vehicle types:", err));
        });

        function populateDropdown(dropdownId, items, defaultText, selectedValue = null) {
        const dropdown = document.getElementById(dropdownId);
        dropdown.innerHTML = ''; // clear existing options

        const defaultOption = document.createElement('option');
        defaultOption.text = defaultText;
        defaultOption.value = '';
        defaultOption.disabled = true;
        dropdown.appendChild(defaultOption);

        // Add dropdown options from API
        if (items && items.length > 0) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;   // Adjust according to your API structure
                option.text = item.name;  // Adjust according to your API structure
                dropdown.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.text = 'No vehicle types found';
            option.disabled = true;
            dropdown.appendChild(option);
        }

        // ✅ Only preselect value in Edit mode
        if (typeof currentMode !== "undefined" && currentMode === "Edit") {
            if (selectedValue) {
                // Try to select by ID first
                dropdown.value = selectedValue;

                // If ID doesn't match, fallback to matching text (name)
                if (!dropdown.value) {
                    const match = Array.from(dropdown.options).find(opt =>
                        opt.text.trim().toLowerCase() === String(selectedValue).trim().toLowerCase()
                    );
                    if (match) match.selected = true;
                }
            } else {
                defaultOption.selected = true;
            }
        } else {
            defaultOption.selected = true;
        }
    }

    //   function getRequestVerificationToken() {
    //     const tokenInput = document.querySelector('#afForm input[name="__RequestVerificationToken"]');
    //     return tokenInput ? tokenInput.value : null;
    //   }

    //   // Click -> open chooser
    //   document.getElementById("upload-btn").addEventListener("click", () => {
    //     document.getElementById("upload-file").click();
    //   });

    //       // Event listener to handle file selection
    // document.getElementById("upload-file").addEventListener("change", function (event) {
    //     const fileInput = event.target;
    //     if (!fileInput.files || fileInput.files.length === 0) {
    //         return showAppAlert({ icon: 'warning', title: 'No File', text: 'Please select a file to upload.' });
    //     }
    //     const file = fileInput.files[0];

    //     // Client-side CSV guards
    //     const extOk = /\.csv$/i.test(file.name);
    //     const type = (file.type || '').toLowerCase();
    //     const typeOk = type.includes('csv') || type === 'application/vnd.ms-excel'; // some browsers
    //     if (!extOk && !typeOk) {
    //         showAppAlert({ icon: 'warning', title: 'Invalid File', text: 'Please select a .csv file.' });
    //         fileInput.value = ''; // Clear the file input
    //         return;
    //     }

    //     // Proceed with uploading the file
    //     const url = '/VehicleModel/Upload';  // Ensure this matches the controller route
    //     uploadFile(url, file);
    // });

    // // Call this function after submitting the form
    // async function uploadFile(url, file) {
    //     const formData = new FormData();
    //     formData.append("file", file);

    //     // Get the CSRF token from the page
    //     const csrfToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

    //     try {
    //         const response = await fetch(url, {
    //             method: 'POST',
    //             headers: {
    //                 'RequestVerificationToken': csrfToken // Add CSRF token in the header
    //             },
    //             body: formData  // Attach the file to FormData
    //         });

    //        await handleUploadResponse(response);  // Handle response

    //        console.log(response);

    //     } catch (error) {
    //         showAppAlert('An error occurred while uploading the file.');
    //     }
    // }

    //    async function handleUploadResponse(response) {
    //       if (response.ok) {
    //         const result = await response.json();
    //         showAppAlert({ icon: 'success', title: result.title, text: result.message });

    //         if (result.invalidRecords) downloadInvalidRecords(result.invalidRecords);

    //         if (result.status === "success") {
    //           setTimeout(() => { window.location.href = "/VehicleModel/Index"; }, 900);
    //         }
    //       } else {
    //         let title = "Upload Failed", text = "An unexpected error occurred.";
    //         try {
    //           const err = await response.json();
    //           title = err.title || title;
    //           text = err.message || text;
    //           if (err.status === "error") {
    //                 setTimeout(() => { window.location.href = "/VehicleModel/Index"; }, 1500);
    //           }
    //         } catch (_) { /* ignore JSON parse errors */ }
    //         showAppAlert({ icon: 'error', title, text });
    //       }
    //     }

    // function downloadInvalidRecords(fileData) {
    //     // Decode the base64 CSV data and create a Blob
    //     const csvData = atob(fileData); // Decode base64 string to CSV
    //     const blob = new Blob([csvData], { type: 'text/csv' });  // Create a Blob of CSV data
    //     const link = document.createElement('a');
    //     link.href = URL.createObjectURL(blob);  // Create a URL for the Blob
    //     link.download = 'invalid_records.csv';  // Set the file name
    //     link.click();  // Trigger the download
    // }
    });

</script>

