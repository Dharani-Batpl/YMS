@{
    //  Read JSON payload for grid from ViewData
    var brandMasterData = ViewData["BrandMasterData"] ?? "[]";

    // set layout
    Layout = "_Layout";
}
<head>
    <!--  Keep head empty as per request (no changes to assets/includes) -->
</head>
<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }    
</style>

<div class="main-container">

    <!--  Page title header -->
    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Brand Master</h6>
    </div>
    <!--  Toolbar row with search + action buttons -->
    <div class="row align-items-center mb-3">

        <!-- Spacer on xs devices -->
        <div class="w-100 d-md-none"></div>

        <!-- Search bar and action buttons -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

            <div class="input-icon-wrapper">
                <input type="search"
                       id="searchField"
                       class="form-control form-control-sm"
                       placeholder="Search..."
                       style="max-width: 280px; min-width: 150px;" />
                <span class="input-icon material-icons">search</span>
            </div>

            <!--  Action buttons group (Add/Edit/Delete/Download/Upload/Template) -->
            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">
                <!--  Add row -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>
                <!--  Edit selected row -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>
                <!--  Delete selected row -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>
                <!--  Download CSV -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>
                <!--  Upload CSV -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>
                <!--  Download CSV template -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>


    </div>

    <div id="brandMastertable" class="tabulator-bootstrap5"></div>
    <div id="recordCount" class="footer-total-records"></div>    
</div>

<!--  Add/Edit modal (single form reused for both modes) -->
<div class="modal fade modal-request" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <!--  Modal header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit Brand Master</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <!--  Modal body with form fields -->
            <div class="modal-body">
                <form id="addEditForm" autocomplete="off">
                    <input type="hidden" id="Brand_id" name="Brand_id" />

                    <div class="row g-3">
                        <div>
                            <label for="Brand_code" class="form-label">Brand Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Brand_code" name="Brand_code" required
                                   pattern="[A-Za-z0-9 ]+"
                                   placeholder="Enter Brand Code"
                                   title="Only letters, numbers, and spaces are allowed. No special characters.">
                        </div>
                        <div>
                            <label for="Brand_name" class="form-label">Brand Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Brand_name" name="Brand_name" required
                                   placeholder="Enter Brand Name"
                                   pattern="[A-Za-z0-9 ]+"
                                   title="Only letters, numbers, and spaces are allowed. No special characters.">
                        </div>                        

                        <div>
                            <label for="Manufacturer_name" class="form-label">Manufacturer <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Manufacturer_name" name="Manufacturer_name" required
                                   placeholder="Enter Manufacturer"
                                   pattern="[A-Za-z0-9 ]+"
                                   title="Only letters, numbers, and spaces are allowed. No special characters.">
                        </div>

                        <div>
                            <label for="Country_id" class="form-label">Country <span class="text-danger">*</span></label>
                            <select class="form-select" id="Country_id" name="Country_id" required>
                                <option value="">Select Country</option>
                                @foreach (var p in (IEnumerable<SelectListItem>)ViewBag.CountryList ?? Enumerable.Empty<SelectListItem>())
                                {
                                    <option value="@p.Value">@p.Text</option>
                                }
                            </select>
                        </div>
                        <div>
                            <label for="Status_id" class="form-label">Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="Status_id" name="Status_id" required>
                                <option value="">Select Status</option>
                                @foreach (var p in (IEnumerable<SelectListItem>)ViewBag.StatusList ?? Enumerable.Empty<SelectListItem>())
                                {
                                    <option value="@p.Value">@p.Text</option>
                                }
                            </select>
                        </div>

                        <div>
                            <label for="Description" class="form-label">Description</label>
                            <textarea class="form-control" id="Description" name="Description" rows="7"
                                      placeholder="Enter Brand Description"
                                      title="Only letters, numbers, and spaces are allowed. No special characters."></textarea>
                        </div>
                    </div>
                </form>
            </div>


            <!--  Modal footer with actions -->
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-submit" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>
<!------- Hidden file input for CSV upload ------->
<form id="afForm" style="display:none" method="post">
    @Html.AntiForgeryToken()
    <input type="file" id="upload-file" style="display:none" accept=".xlsx,.xls" />

</form>

<script>

    document.addEventListener("DOMContentLoaded", () => {
        // ==========================
        // 🔹 Initialize reusable components
        // ==========================
        initTooltips(); // Bootstrap tooltips
        const brandMasterData = JSON.parse('@Html.Raw(brandMasterData)');        
        let currentMode = "";

    // ==========================
    // 🔹 Initialize Tabulator
    // ==========================
    const dataTable = new Tabulator("#brandMastertable", {
        data: brandMasterData,
            columns: [
                { title: "Brand Code", field: "Brand_code", width: 220,headerFormatterParams: { cssClass: "tabulator-header-blue" } },
                { title: "Brand Name", field: "Brand_name", width: 220 },                 
                { title: "Manufacturer", field: "Manufacturer_name", width: 220 },                    
                { title: "Country", field: "Country_name", width: 220 },
                { title: "Description", field: "Description", width: 150},                                        
                { title: "Status", field: "Status_name", width: 150,
                    formatter: function (cell) {
                        let val = cell.getValue();
                        if (val === "Active" || val === 1 || val === true) {
                            return `<span class="active-badge">Active</span>`;
                        }
                        return `<span class="inactive-badge">In-Active</span>`;
                    }
                }                    
            ],
        layout: "fitDataStretch",
        height: "80vh",
        selectable: 1,
        pagination: "local",
        resizableRows:false,
        resizableRowGuide:false,
        resizableColumnGuide:false,
        columnDefaults:{
	        resizable:false,
        },           
        movableColumns: false,
        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],
            locale: true,
        langs: {
	        "en": {
        pagination: {
	        first: "<<",
	        first_title: "First",
	        last: ">>", 
	        last_title: "Last", 
	        prev: "<", 
	        prev_title: "Prev",
	        next: ">", 
	        next_title: "Next", 
	        page_size: "Page Size" 
	            }
	        }
            },

        rowClick: function (e, row) {
            selectedRow = row.getData();
        }
    });

    // Command: Live search (visible columns only) for parent table
    document.getElementById("searchField").addEventListener("input", function () {
        var searchTerm = this.value.toLowerCase();

        // Command: Collect visible fields
        var visibleColumns = dataTable.getColumns()
                                    .filter(col => col.isVisible())
                                    .map(col => col.getField());

        // Command: Apply per-row predicate filter
        dataTable.setFilter(function (data) {
            return visibleColumns.some(field => {
                var value = data[field];
                return value != null && value.toString().toLowerCase().includes(searchTerm);
            });
        });
    });
              
    // Record count for filtered data
    dataTable.on("dataFiltered", function(filters, rows) {
            updateRecordCount(dataTable, rows, "Brand_id");  // Pass the field name >>replace with your table primary id column
    });

    // Record count for loaded data
    dataTable.on("dataLoaded", function(data) {
            updateRecordCount(dataTable, data, "Brand_id");  // Pass the field name >>replace with your table primary id column
    });

    dataTable.on("tableBuilt", function(){
        const hideFields = [
            "Brand_id",
            "Status_id",
            "Is_deleted",
            "Created_by",
            "Created_at",
            "Updated_by",
            "Updated_at",
            "Version",
            "AdditionalProperties",
            "Country_id"
        ];

    hideFields.forEach(field => dataTable.hideColumn(field));
});

    const addEditModalEl = document.getElementById('addEditModal');
    const addEditModal = new bootstrap.Modal(addEditModalEl);
    const form = document.getElementById("addEditForm");

    // ==========================
    // 🔹 Add Button
    // ==========================
    document.getElementById("add-btn").addEventListener("click", () => {
        currentMode = "Add";
        form.reset();
        document.getElementById("addEditModalLabel").textContent = " Add Brand ";
        document.getElementById("modalSubmitBtn").textContent = "Add";
        document.getElementById("Brand_id").value=0;
        addEditModal.show();
    });

    // ==========================
    // 🔹 Edit Button
    // ==========================
    document.getElementById("edit-btn").addEventListener("click", () => {
        const selectedRow = dataTable.getSelectedData()?.[0];
        if (!selectedRow) {
            return showAppAlert({ icon: 'warning', title: 'No Selection', text: 'Please select a row to edit.' });
        }

        currentMode = "Edit";
        document.getElementById("addEditModalLabel").textContent = "Edit Brand";
        document.getElementById("modalSubmitBtn").textContent = "Update";

        // Populate modal form fields dynamically
        Object.keys(selectedRow).forEach(field => {
            const BrandMasterField = document.getElementById(field);
            if (BrandMasterField) {
                if (BrandMasterField.type === "datetime-local" && selectedRow[field]) {
                    BrandMasterField.value = new Date(selectedRow[field]).toISOString().slice(0,16);
                } else {
                    BrandMasterField.value = selectedRow[field] ?? "";
                }
            }
        });

        $("#Brand_code").prop("readonly", true);

        addEditModal.show();
    });

    // ==========================
    // 🔹 Delete Button
    // ==========================

    document.getElementById("delete-btn").addEventListener("click", async () => {
        const selectedRow = dataTable.getSelectedData()?.[0];
        if (!selectedRow) {
            return showAppAlert({ icon: "warning", title: "No Selection", text: "Please select a row to delete." });
        }

        const Brandid = selectedRow.Brand_id;

        const confirm = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete Confirmation",
            text: "Are you sure you want to delete this record?"
        });

        if (!confirm.isConfirmed) return;

        const success = await deleteRecord("/BrandMaster/Delete", { Brand_id: Brandid }); // method defaults to PUT
        if (success) {
            // redirect or refresh your table
            setTimeout(() => { window.location.href = "/BrandMaster/Index"; }, 900);
            // or: dataTable.replaceData();
        }
    });

    // ==========================
    // 🔹 Form Submit (Add/Edit)
    // ==========================
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(form).entries());
        console.log(formData);

        const fetchUrl = currentMode === "Add" ? "/BrandMaster/Create" : "/BrandMaster/Update";

        const success = await saveRecord(fetchUrl, formData, currentMode, addEditModal, form);
        if (success) {
            setTimeout(() => {
                window.location.href = "/BrandMaster/Index";
            }, 900);
        }
    });

    // ==========================
    // 🔹 Download 
    // ==========================
    document.getElementById("download-btn").addEventListener("click", function () {
        let rowCount = dataTable.getDataCount ? dataTable.getDataCount() : dataTable.getData().length;

        if (rowCount === 1) {
            let firstRowData = dataTable.getData()[0];
            let firstRowFieldValue = firstRowData ? firstRowData["Brand_id"] : null;
            if (firstRowFieldValue === null || firstRowFieldValue === 0 || firstRowFieldValue === "") {
                rowCount = 0;
            }
        }
        if (rowCount === 0) {
            showAppAlert({
                icon: 'warning',
                title: 'No Data',
                text: 'No records found to download.'
            });
            return; // Stop further execution
        }
        downloadExcel(dataTable, "BrandMaster.xlsx");
    });

    // ==========================
    // 🔹 Download Template
    // ==========================
    $("#download-template-btn").on("click", function () {
        const headers = [
            "Brand Code",
            "Brand Name",
            "Manufacturer",
            "Country",            
            "Description"
        ];

        downloadTemplate(headers, "BrandMaster");
    });

    // ================================================================
    //  Upload button
    // ================================================================
    $("#upload-btn").on("click", function () {
            $("#upload-file").click();
    });

    // ================================================================
    //  File input change event
    // ================================================================
    $("#upload-file").on("change", function (event) {

        const file = event.target.files?.[0];

        if (!file) {
            return showAppAlert({
                icon: 'warning',
                title: 'No File',
                text: 'Please select a file to upload.'
            });
        }

        const isExcel = /\.(xlsx|xls)$/i.test(file.name);
        if (!isExcel) {
            showAppAlert({
                icon: 'warning',
                title: 'Invalid File',
                text: 'Please select an Excel file (.xlsx or .xls).'
            });
            return;
        }
        const url = "@Url.Action("Upload", "BrandMaster")";
        uploadFile(url, file);
    });

    // ================================================================
    //  Upload function
    // ================================================================
    async function uploadFile(url, file) {

        const formData = new FormData();
        formData.append("file", file);

        const csrf = $('#afForm input[name="__RequestVerificationToken"]').val();

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'RequestVerificationToken': csrf },
                body: formData
            });

            await handleUploadResponse(response);

        } catch (err) {
            showToast({ icon: "error", text: err.message });
        }
    }


    // ================================================================
    //  Handle upload response
    // ================================================================
    async function handleUploadResponse(response) {

        const result = await response.json().catch(() => null);

        // SUCCESS
        if (response.ok) {

            showAppAlert({
                icon: result.status,
                title: result.title,
                text: result.message,
                timer: 2500,
                showConfirmButton: false
            });

            setTimeout(() => location.reload(), 800);
            $("#upload-file").val("");

            return;
        }

        // GENERIC API MESSAGE
        if (result && result.errors) {

            let msg = "";
            result.errors.forEach(e => {
                msg += `Error: ${e.error}\n\n`;
            });

            showAppAlert({
                icon: "error",
                title: "Upload Failed",
                text: msg,
                timer: 4500,
                showConfirmButton: false
            });

            $("#upload-file").val("");
            return;
        }

        // GENERIC API MESSAGE
        if (result && result.message) {

            showAppAlert({
                icon: "error",
                title: "Upload Failed",
                text: result.message,
                timer: 3500,
                showConfirmButton: false
            });

            $("#upload-file").val("");
            return;
        }

       // UNKNOWN ERROR
        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: "Unexpected error.",
            timer: 3500,
            showConfirmButton: false
        });

        $("#upload-file").val("");
    }

    });
</script>


