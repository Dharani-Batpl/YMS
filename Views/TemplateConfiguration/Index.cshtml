<!-- Get View Data -->
@{
    var templateConfiguration = ViewData["TemplateConfiguration"] ?? "[]";
    Layout = "_Layout";
}

<head>

 <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


</head>

<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
  
    

</style>

<div class="main-container">

     <!------- Page Title Section ------->
    <div class="col-12 text-center py-1 mb-3" style="background:#242424;color:white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Shift Template Configuration</h6>
    </div>

     <!------- Toolbar: Search + Actions ------->
    <div class="row align-items-center mb-3">

         <!-- Spacer on xs devices -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

             <!-- Search input -->
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;"autocomplete="off" />

            <!-- Action buttons group -->
            <div class="btn-group flex-wrap">

                 <!-- Add -->
                <button id="add-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">add</span>
                </button>

                 <!-- Edit -->
                <button id="edit-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">edit</span>
                </button>
                            
                  <!-- Download -->
                <button id="download-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">download</span>
                </button>

                  <!-- Upload -->
                <button id="upload-btn" class="btn btn-primary-professional btn-sm px-3" title="Upload">
                    <span class="material-icons">upload</span>
                </button>                

                 <!-- Download Template -->
                <button id="download-template-btn" class="btn btn-primary-professional btn-sm px-3" title="Template">
                    <span class="material-icons">assignment_returned</span>
                </button>

            </div>
        </div>
    </div>

      <!------- Data grid + record count ------->
    <div id="templateTable" class="tabulator-bootstrap5"></div>
    <div id="recordCount" class="footer-total-records"></div>

</div>

<!-- Add/Edit Modal -->
<div class="modal fade modal-request" id="addEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

             <!-- Header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit Template</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter:invert(1);"></button>
            </div>

             <!-- Body -->
            <div class="modal-body">

                <form id="addEditForm">

                    <input type="hidden" id="Template_id" name="Template_id" />

                    <div class="row g-3">
                         <!-- Template name -->
                        <div>
                            <label class="form-label">Template Name</label>
                            <span class="text-danger">*</span>
                            <input type="text" id="Template_name" name="Template_name"
                                   class="form-control" required maxlength="50" autocomplete="off" >
                        </div>
                         <!-- Description -->
                        <div>
                            <label class="form-label">Template Description</label>
                            <input type="text" id="Description" name="Description"
                                   class="form-control" maxlength="150" autocomplete="off" >
                        </div>
                         <!-- Select Shift -->
                        <div>
                            <label class="form-label">Shift</label>
                            <span class="text-danger">*</span>
                            <select class="form-select select2-multi"
                            id="Shift_id"
                            name="Shift_id"
                            multiple="multiple"
                            required
                            style="width:100%;"
                            asp-items="@(ViewBag.ShiftList as IEnumerable<SelectListItem>)">
                    </select>


                        </div>
                         <!-- Effective from -->
                        <div>
                            <label class="form-label">Effective From</label>
                            <span class="text-danger">*</span>
                            <input type="date" id="Effective_from" name="Effective_from"
                                   class="form-control" required min="">
                            <span id="effectiveFromError" class="text-danger" style="display:none;"></span>
                        </div>
                        <!-- Status -->
                        <div>
                            <label class="form-label">Status</label>
                            <span class="text-danger">*</span>
                            <select class="form-select" id="Status_id" name="Status_id" required>
                                <option value="0">Active</option>
                                <option value="1">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
              <!-- Footer -->
            <div class="modal-footer">
            
                <!-- Buttons -->
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-submit" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>

        </div>
    </div>
</div>
 <!------- Hidden file input for CSV upload ------->
<form id="afForm" method="post" style="display:none">
    @Html.AntiForgeryToken()
    <input type="file" id="upload-file" hidden accept=".xlsx,.xls" />
</form>

 <!-- Scrips -->
 <script>
$(document).ready(function () {

    // ================================================================
    //  Init tooltip + load initial data
    // ================================================================
    initTooltips();

    const templateConfiguration = JSON.parse('@Html.Raw(templateConfiguration)');
    console.log(templateConfiguration);

    let selectedRow = null;

    

    // ================================================================
    //  Tabulator table setup
    // ================================================================
    const templateTable = new Tabulator("#templateTable", {

        data: templateConfiguration,

        columns: [
            {
                title: "Template Name",
                field: "Template_name",
                minWidth: 220,
                headerHozAlign: "center"
            },
            {
                title: "Assigned Shift(s)",
                field: "Assigned_shifts",
                minWidth: 180,
                headerHozAlign: "center"
            },
            {
                title: "Status",
                field: "Is_deleted",
                width: 130,
                headerHozAlign: "center",
                formatter: function (cell) {
                    return cell.getValue()
                        ? "<span class='badge bg-danger'>Inactive</span>"
                        : "<span class='badge bg-success'>Active</span>";
                }
            },
            {
                title: "Effective From",
                field: "Effective_from",
                minWidth: 160,
                headerHozAlign: "center"
            },
            {
                title: "Created By",
                field: "Created_by",
                headerHozAlign: "center",
                minWidth: 150
            },

            { title: "Shift1", field: "Assigned_shift1", visible: false },
            { title: "Shift2", field: "Assigned_shift2", visible: false },
            { title: "Shift3", field: "Assigned_shift3", visible: false },
            { title: "Shift4", field: "Assigned_shift4", visible: false },
            { title: "Shift5", field: "Assigned_shift5", visible: false }

        ],

        layout: "fitColumns",
        height: "70vh",
        selectable: 1,

        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],

        resizableRows: false,
        resizableColumnGuide: false,
        columnDefaults: { resizable: false },
        movableColumns: false,

        locale: true,
        langs: {
            "en": {
                pagination: {
                    first: "<<",
                    first_title: "First",
                    last: ">>",
                    last_title: "Last",
                    prev: "<",
                    prev_title: "Prev",
                    next: ">",
                    next_title: "Next",
                    page_size: "Page Size"
                }
            }
        },

        rowClick: function (e, row) {
            selectedRow = row.getData();
        }
    });


    // ================================================================
    //  Search functionality
    // ================================================================
     $("#searchField").on("input", function () {

        const q = $(this).val().toLowerCase();

        const visibleCols = templateTable
            .getColumns()
            .map(c => c.getField())
            .filter(f => f && f !== "Is_deleted");   

        templateTable.setFilter(d =>
            visibleCols.some(f =>
                (d?.[f] ?? "")
                    .toString()
                    .toLowerCase()
                    .includes(q)
            )
        );
    });


    // ================================================================
    //  Record count (total + filtered)
    // ================================================================
    templateTable.on("dataLoaded", (data) => {
        $("#recordCount").text("Total Records: " + data.length);
    });

    templateTable.on("dataFiltered", (_, rows) => {
        $("#recordCount").text("Total Records: " + rows.length);
    });


    // ================================================================
    //  Hide unnecessary columns
    // ================================================================
    templateTable.on("tableBuilt", () => {

        const hideFields = [
            "template_id",
            "Status_id",
            "Plant_id",
            "Version",
            "Created_at",
            "Updated_at",
            "Updated_by",
            "Shiftdetails",
            "AdditionalProperties"
        ];

        hideFields.forEach(f => templateTable.hideColumn(f));
    });


    // ================================================================
    //  Modal setup
    // ================================================================
    const addEditModal = new bootstrap.Modal($("#addEditModal")[0]);
    let currentMode = "Add";


    // ================================================================
    //  Add button click
    // ================================================================
    $("#add-btn").on("click", function () {

        currentMode = "Add";

        $("#addEditModalLabel").text("Add Shift Template");
        $("#modalSubmitBtn").text("Add");

        $("#addEditForm")[0].reset();

        $("#Template_name").prop("readonly", false);
        $("#Status_id").val("0");
        $("#Status_id").prop("disabled", true);

        addEditModal.show();
    });


    // ================================================================
    //  Edit button click
    // ================================================================
    $("#edit-btn").on("click", function () {

        const sel = templateTable.getSelectedData()?.[0];

        if (!sel) {
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Select a row to edit."
            });
        }

        currentMode = "Edit";

        $("#addEditModalLabel").text("Edit Shift Template");
        $("#modalSubmitBtn").text("Update");

        $("#Template_name").prop("readonly", true);

        // Populate fields
        $("#Template_id").val(sel.Template_id || "");
        $("#Template_name").val(sel.Template_name || "");
        $("#Description").val(sel.Template_description || "");
        let assigned = [
        sel.Assigned_shift1,
        sel.Assigned_shift2,
        sel.Assigned_shift3,
        sel.Assigned_shift4,
        sel.Assigned_shift5
    ].filter(x => x !== null && x !== undefined && x !== 0);
    console.log("Assigned shifts array:", assigned);
    $("#Shift_id").val(assigned).trigger("change");

        $("#Status_id").prop("disabled", false);

        // Handle status
        $("#Status_id").val(
            sel.Is_deleted == 1 || sel.Is_deleted === true || sel.Is_deleted === "true"
                ? "1"
                : "0"
        );

        // Handle effective date
        let effDate = "";

        if (sel.Effective_from) {

            // ISO format
            if (sel.Effective_from.includes("T")) {
                const d = new Date(sel.Effective_from);
                effDate = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
                    .toISOString().split("T")[0];
            }

            // /Date()
            else if (sel.Effective_from.includes("/Date(")) {
                const ms = parseInt(sel.Effective_from.replace(/\D/g, ""), 10);
                const d = new Date(ms);
                effDate = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
                    .toISOString().split("T")[0];
            }

            // Normal date string
            else {
                const d = new Date(sel.Effective_from);
                if (!isNaN(d)) {
                    effDate = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
                        .toISOString().split("T")[0];
                }
            }
        }

        $("#Effective_from").val(effDate);

        addEditModal.show();
    });


    // ================================================================
    //  Submit form (add + edit)
    // ================================================================
    $("#addEditForm").on("submit", async function (e) {

        e.preventDefault();

        const formData = Object.fromEntries(new FormData(this).entries());

        let shiftList = $("#Shift_id").val() || [];

         shiftList = shiftList.map(Number);

         const assignedShifts = {
            assigned_shift1: shiftList[0] || null,
            assigned_shift2: shiftList[1] || null,
            assigned_shift3: shiftList[2] || null,
            assigned_shift4: shiftList[3] || null,
            assigned_shift5: shiftList[4] || null
        };

        const payload = {
            template_id: currentMode === "Edit" ? Number(formData.Template_id) : 0,
        template_name: formData.Template_name,
        template_description: formData.Description || "",
        effective_from: formData.Effective_from,
        is_deleted: currentMode === "Edit" ? $("#Status_id").val() === "1" : false,

        
        ...assignedShifts
        };

        if (currentMode === "Edit") {
            payload.is_deleted = $("#Status_id").val() === "1";
        }

        const url =
            currentMode === "Add"
                ? "/TemplateConfiguration/Create"
                : "/TemplateConfiguration/Update";

        const ok = await saveRecord(url, payload, currentMode, addEditModal, this);

        if (ok) location.reload();
    });


    // ================================================================
    //  Download CSV
    // ================================================================
   $("#download-btn").on("click", function () {

    let rows = templateTable.getData();

    if (!rows || rows.length === 0) {
        showAppAlert({
            icon: 'warning',
            title: 'No Data',
            text: 'No records found to download.'
        });
        return;
    }

    // 🔥 Create clean export copy
    let exportRows = rows.map(r => ({
        "Template Name": r.Template_name,
        "Assigned Shift(s)": r.Assigned_shifts,
        "Status": r.Is_deleted ? "Inactive" : "Active",
        "Effective From": r.Effective_from,
        "Created By": r.Created_by
    }));

    // 🔥 Convert object → CSV
    let headers = Object.keys(exportRows[0]);

    let csv = [
        headers.join(","),
        ...exportRows.map(r => headers.map(h => `"${r[h] || ""}"`).join(","))
    ].join("\n");

    // 🔥 Download
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "TemplateMaster.csv";
    a.click();

    URL.revokeObjectURL(url);
});



    // ================================================================
    //  Minimum date restriction
    // ================================================================
    const today = new Date().toISOString().split("T")[0];
    $("#Effective_from").attr("min", today);

});


// ================================================================
//  Download template
// ================================================================
$("#download-template-btn").on("click", function () {

    const headers = [
        "Template Name",
        "Template Description",
        "Shift Name 1",
        "Shift Name 2",
        "Shift Name 3",
        "Shift Name 4",
        "Shift Name 5",
        "Effective from"
    ];

    downloadTemplate(headers, "TemplateConfigurationMasterTemplate");
});


// ================================================================
//  Upload button
// ================================================================
$("#upload-btn").on("click", function () {
    $("#upload-file").click();
});


// ================================================================
//  File input change event
// ================================================================
$("#upload-file").on("change", function (event) {

    const file = event.target.files?.[0];

    if (!file) {
        return showAppAlert({
            icon: 'warning',
            title: 'No File',
            text: 'Please select a file to upload.'
        });
    }

    const isExcel = /\.(xlsx|xls)$/i.test(file.name);
    if (!isExcel) {
        showAppAlert({
            icon: 'warning',
            title: 'Invalid File',
            text: 'Please select an Excel file (.xlsx or .xls).'
        });
        return;
    }

    uploadFile('/TemplateConfiguration/Upload', file);
});


// ================================================================
//  Upload function
// ================================================================
async function uploadFile(url, file) {

    const formData = new FormData();
    formData.append("file", file);

    const csrf = $('#afForm input[name="__RequestVerificationToken"]').val();

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'RequestVerificationToken': csrf },
            body: formData
        });

        await handleUploadResponse(response);

    } catch (err) {
        showToast({ icon: "error", text: err.message });
    }
}


// ================================================================
//  Handle upload response
// ================================================================
async function handleUploadResponse(response) {

    const result = await response.json().catch(() => null);

    // SUCCESS
    if (response.ok) {

        showAppAlert({
            icon: result.status,
            title: result.title,
            text: result.message,
            timer: 2500,
            showConfirmButton: false
        });

        setTimeout(() => location.reload(), 800);
        $("#upload-file").val("");

        return;
    }

    // GENERIC API MESSAGE
    if (result && result.errors) {

        let msg = "";
        result.errors.forEach(e => {
            msg += `Error: ${e.error}\n\n`;
        });

        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: msg,
            timer: 4500,
            showConfirmButton: false
        });

        $("#upload-file").val("");
        return;
    }

    // GENERIC API MESSAGE
    if (result && result.message) {

        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: result.message,
            timer: 3500,
            showConfirmButton: false
        });

        $("#upload-file").val("");
        return;
    }

   // UNKNOWN ERROR
    showAppAlert({
        icon: "error",
        title: "Upload Failed",
        text: "Unexpected error.",
        timer: 3500,
        showConfirmButton: false
    });

    $("#upload-file").val("");
}
  $("#Shift_id").select2({
        placeholder: "Select Shift",
        allowClear: true,
        width: "100%",
         dropdownParent: $("#addEditModal") 
    });

    $("#Shift_id").on("select2:select", function (e) {
    let selected = $(this).select2("data");

    if (selected.length > 5) {
        // Remove the extra selected item
        $(this).find(`option[value='${e.params.data.id}']`).prop("selected", false);
        $(this).trigger("change");

        // Show error alert
        showAppAlert({
            icon: "warning",
            title: "Maximum Limit Reached",
            text: "You can select only up to 5 shifts."
        });
    }
});
</script>
