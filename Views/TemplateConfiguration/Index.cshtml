@{
    var templateConfiguration = ViewData["TemplateConfiguration"] ?? "[]";
    Layout = "_Layout";
}

<head>
    <!-- Keep head empty -->
</head>

<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }


</style>

<div class="main-container">

    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Shift Template Configuration</h6>
    </div>

    <div class="row align-items-center mb-3">
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..."
                   style="max-width: 280px; min-width: 150px;" />
            <div class="btn-group flex-wrap">
                <button id="add-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">add</span>
                </button>
                <button id="edit-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">edit</span>
                </button>
                <button id="delete-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">delete</span>
                </button>
                <button id="download-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">download</span>
                </button>
            </div>
        </div>
    </div>

    <div id="templateTable" class="tabulator-bootstrap5"></div>

    <div id="recordCount" class="footer-total-records"></div>

</div>

<!-- Add/Edit Modal -->
<div class="modal fade modal-request" id="addEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit Template</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>

            <div class="modal-body">
                <form id="addEditForm">
                    <input type="hidden" id="Template_id" name="Template_id" />

                    <div class="row g-3">
                        <div>
                            <label class="form-label">Plant</label>
                            <span class="text-danger">*</span>
                            <select class="form-select" id="Plant_id" name="Plant_id"
                                    asp-items="@(ViewBag.PlantList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Plant</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Template Name</label>
                            <span class="text-danger">*</span>
                            <input type="text" id="Template_name" name="Template_name"
                                   class="form-control" required />
                        </div>

                        <div>
                            <label class="form-label">Template Start Date</label>
                            <span class="text-danger">*</span>
                            <input type="date" id="Temp_start_time" name="Temp_start_time"
                                   class="form-control" required />
                            <span id="Temp_start_timeError" class="text-danger" style="display:none;"></span>
                        </div>

                        <div>
                            <label class="form-label">Template End Date</label>
                            <span class="text-danger">*</span>
                            <input type="date" id="Temp_end_time" name="Temp_end_time"
                                   class="form-control" required />
                            <span id="Temp_end_timeError" class="text-danger" style="display:none;"></span>
                        </div>

                        <div>
                            <label class="form-label">Status</label>
                            <span class="text-danger">*</span>
                            <select id="Status_id" name="Status_id" class="form-select"
                                    asp-items="@(ViewBag.StatusList as IEnumerable<SelectListItem>)">
                                <option value="" disabled selected>Select Status</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Description</label>
                            <input type="text" id="Description" name="Description"
                                   class="form-control" />
                        </div>
                    </div>

                </form>
            </div>

             <div class="modal-footer">

                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-submit" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {

    initTooltips();

    const templateConfiguration = JSON.parse('@Html.Raw(templateConfiguration)');

    // Initialize Template Table
    let selectedRow = null;

    const templateTable = new Tabulator("#templateTable", {
        data: templateConfiguration,
        columns: generateTabulatorColumns(templateConfiguration),
        layout: "fitDataStretch",
        height: "80vh",

        selectable: 1,

        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],

        resizableRows: false,
        resizableRowGuide: false,
        resizableColumnGuide: false,

        columnDefaults: {
            resizable: false,
        },

        movableColumns: false,

        locale: true,
        langs: {
            "en": {
                pagination: {
                    first: "<<",
                    first_title: "First",
                    last: ">>",
                    last_title: "Last",
                    prev: "<",
                    prev_title: "Prev",
                    next: ">",
                    next_title: "Next",
                    page_size: "Page Size"
                }
            }
        },

        rowClick: function (e, row) {
            templateTable.deselectRow();
            row.select();
            selectedRow = row.getData();
        },

    });


    // Search
    document.getElementById("searchField")?.addEventListener("input", function () {
        const q = this.value.toLowerCase();
        const visible = templateTable.getColumns().map(c => c.getField());
        templateTable.setFilter(d =>
            visible.some(f => (d?.[f] ?? "").toString().toLowerCase().includes(q))
        );
    });

    // Record count
    templateTable.on("dataFiltered", (_, rows) => {
        document.getElementById("recordCount").innerText = "Total Records: " + rows.length;
    });

    templateTable.on("dataLoaded", (data) => {
        document.getElementById("recordCount").innerText = "Total Records: " + data.length;
    });

    // Hide unwanted columns
    templateTable.on("tableBuilt", () => {
        const hideFields = [
            "Template_id", "Status_id", "Plant_id", "Is_deleted",
            "Version", "Created_at", "Updated_by", "Updated_at",
            "Shiftdetails", "AdditionalProperties"
        ];
        hideFields.forEach(f => templateTable.hideColumn(f));

        const columnRenameMap = {
            "Temp_start_time": "Template Start Date",
            "Temp_end_time": "Template End Date"
        };

        Object.keys(columnRenameMap).forEach(f => {
            const col = templateTable.getColumn(f);
            if (col) col.updateDefinition({ title: columnRenameMap[f] });
        });
    });

    // Modal
    const addEditModal = new bootstrap.Modal(document.getElementById("addEditModal"));

    let currentMode = "Add";

    // Prevent typing manually in date inputs
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.addEventListener('keydown', e => e.preventDefault());
    });

    // Add
    document.getElementById("add-btn").addEventListener("click", () => {
        currentMode = "Add";
        document.getElementById("addEditModalLabel").textContent = "Add Shift Template";
        document.getElementById("modalSubmitBtn").textContent = "Add";
        document.getElementById("addEditForm").reset();
        addEditModal.show();
    });

    // Edit
    document.getElementById("edit-btn").addEventListener("click", () => {
        const sel = templateTable.getSelectedData()?.[0];

        if (!sel)
            return showAppAlert({ icon: "warning", title: "No Selection", text: "Select a row to edit." });

        currentMode = "Edit";
        document.getElementById("addEditModalLabel").textContent = "Edit Shift Template";
        document.getElementById("modalSubmitBtn").textContent = "Update";

        document.getElementById("Template_id").value = sel.Template_id;
        document.getElementById("Template_name").value = sel.Template_name ?? "";
        document.getElementById("Description").value = sel.Description ?? "";
        document.getElementById("Status_id").value = sel.Status_id ?? "";
        document.getElementById("Plant_id").value = sel.Plant_id ?? "";
        document.getElementById("Temp_start_time").value = formatDate(sel.Temp_start_time);
        document.getElementById("Temp_end_time").value = formatDate(sel.Temp_end_time);

        addEditModal.show();
    });

    function formatDate(dt) {
        if (!dt) return "";
        const d = new Date(dt);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }

    // Delete
    document.getElementById("delete-btn").addEventListener("click", async () => {
        const sel = templateTable.getSelectedData()?.[0];

        if (!sel)
            return showAppAlert({ icon: "warning", title: "No Selection", text: "Select a row to delete." });

        const confirm = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete Confirmation",
            text: "Are you sure?"
        });

        if (!confirm.isConfirmed) return;

        const ok = await deleteRecord("/TemplateConfiguration/Delete", { Template_id: sel.Template_id });
        if (ok) location.reload();
    });

    // Validate date range
    function validateDateRange() {
        const s = document.getElementById("Temp_start_time").value;
        const e = document.getElementById("Temp_end_time").value;
        const sErr = document.getElementById("Temp_start_timeError");
        const eErr = document.getElementById("Temp_end_timeError");

        sErr.style.display = "none";
        eErr.style.display = "none";

        if (!s) { sErr.textContent = "Start date required"; sErr.style.display = "inline"; return false; }
        if (!e) { eErr.textContent = "End date required"; eErr.style.display = "inline"; return false; }

        if (new Date(s) >= new Date(e)) {
            sErr.textContent = "Start date must be before end date";
            eErr.textContent = "End date must be after start date";
            sErr.style.display = "inline";
            eErr.style.display = "inline";
            return false;
        }
        return true;
    }

    // Submit
    document.getElementById("addEditForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!validateDateRange()) return;

        const formData = Object.fromEntries(new FormData(e.target).entries());

        const payload = {
            Template_id: currentMode === "Edit" ? Number(formData.Template_id) : 0,
            Template_name: formData.Template_name,
            Temp_start_time: formData.Temp_start_time,
            Temp_end_time: formData.Temp_end_time,
            Description: formData.Description,
            Status_id: Number(formData.Status_id || 0),
            Plant_id: Number(formData.Plant_id || 0)
        };

        const url = currentMode === "Add" ? "/TemplateConfiguration/Create" : "/TemplateConfiguration/Update";
        const ok = await saveRecord(url, payload, currentMode, addEditModal, e.target);

        if (ok) location.reload();
    });

    // Download CSV (Template only)
    document.getElementById("download-btn").addEventListener("click", () => {
        const data = templateTable.getData();
        if (!data.length)
            return showAppAlert({ icon: "info", title: "No Data", text: "Nothing to export." });

        const headers = ["Template_name", "Temp_start_time", "Temp_end_time", "Plant_name", "Description", "Status_name"];
        const csvRows = [];

        csvRows.push(headers.join(","));

        data.forEach(d => {
            csvRows.push(headers.map(h => `"${(d[h] ?? "").toString().replace(/"/g,'""')}"`).join(","));
        });

        const blob = new Blob([csvRows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "TemplateConfiguration.csv";
        link.click();
    });

});
</script>
