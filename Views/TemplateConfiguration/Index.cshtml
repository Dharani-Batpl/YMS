@{
    var templateConfiguration = ViewData["TemplateConfiguration"] ?? "[]";
    Layout = "_Layout";
}

<head>
    <!-- Keep head empty -->
</head>

<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }


</style>

<div class="main-container">

    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Shift Template Configuration</h6>
    </div>

    <div class="row align-items-center mb-3">
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..."
                   style="max-width: 280px; min-width: 150px;" />
            <div class="btn-group flex-wrap">
                <button id="add-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">add</span>
                </button>
                <button id="edit-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">edit</span>
                </button>
                <button id="delete-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">delete</span>
                </button>
                <button id="download-btn" class="btn btn-primary-professional btn-sm px-3">
                    <span class="material-icons">download</span>
                </button>
            </div>
        </div>
    </div>

    <div id="templateTable" class="tabulator-bootstrap5"></div>

    <div id="recordCount" class="footer-total-records"></div>

</div>

        <!-- Add/Edit Modal -->
        <div class="modal fade modal-request" id="addEditModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">

                    <div class="modal-header">
                        <h6 class="modal-title" id="addEditModalLabel">Add/Edit Template</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
                    </div>

                   <div class="modal-body">
            <form id="addEditForm">

                <input type="hidden" id="Template_id" name="Template_id" />

                <div class="row g-3">

                    <!-- Template Name -->
                    <div>
                        <label class="form-label">Template Name</label>
                        <span class="text-danger">*</span>
                        <input type="text" id="Template_name" name="Template_name"
                               class="form-control" required maxlength="50">
                    </div>

                    <!-- Template Description -->
                    <div>
                        <label class="form-label">Template Description</label>
                        <input type="text" id="Description" name="Description"
                               class="form-control" maxlength="150">
                    </div>

                    <!-- Shift Dropdown -->
                    <div>
                        <label class="form-label">Shift</label>
                        <span class="text-danger">*</span>
                        <select class="form-select" id="Shift_id" name="Shift_id"
                                asp-items="@(ViewBag.ShiftList as IEnumerable<SelectListItem>)">
                            <option disabled selected value="">Select Shift</option>
                        </select>
                    </div>

                    <!-- Effective From -->
                    <div>
                        <label class="form-label">Effective From</label>
                        <span class="text-danger">*</span>
                        <input type="date" id="Effective_from" name="Effective_from"
                               class="form-control" required min="">
                        <span id="effectiveFromError" class="text-danger" style="display:none;"></span>
                    </div>

                </div>
            </form>
        </div>


             <div class="modal-footer">

                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-submit" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {

    initTooltips();

    const templateConfiguration = JSON.parse('@Html.Raw(templateConfiguration)');
    console.log(templateConfiguration);

    // Initialize Template Table
    let selectedRow = null;

    const templateTable = new Tabulator("#templateTable", {
        data: templateConfiguration,
        columns: [
    { title: "Template Name", field: "template_name", minWidth: 220, headerHozAlign: "center" },

    {
        title: "Shift Name",
        field: "shift_name",
        minWidth: 180,
        headerHozAlign: "center"
    },

    {
        title: "Status",
        field: "is_deleted",
        hozAlign: "center",
        width: 130,
        headerHozAlign: "center",
        formatter: function (cell) {
            return cell.getValue()
                ? "<span class='badge bg-danger'>Inactive</span>"
                : "<span class='badge bg-success'>Active</span>";
        }
    },

    {
        title: "Effective From",
        field: "effective_from",
        hozAlign: "center",
        minWidth: 160,
        headerHozAlign: "center"
    },

    {
        title: "Created By",
        field: "created_by",
        hozAlign: "center",
        minWidth: 150,
        headerHozAlign: "center"
    }
],


       layout: "fitColumns",
        height: "70vh",
        selectable: 1,
        pagination: "local",
        resizableRows:false,
        resizableRowGuide:false,
        resizableColumnGuide:false,
        resizableColumnGuide:false,
        columnDefaults:{ resizable:false },
        movableColumns: false,
        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],
        locale: true,
        langs: {
            "en": {
                pagination: {
                    first: "<<",
                    first_title: "First",
                    last: ">>", 
                    last_title: "Last", 
                    prev: "<", 
                    prev_title: "Prev",
                    next: ">", 
                    next_title: "Next", 
                    page_size: "Page Size" 
                }
            }
        },
        rowClick: function (e, row) {
            selectedRow = row.getData();
        }
    });

    // ✅ Search
    $("#searchField").on("input", function () {
        const q = $(this).val().toLowerCase();
        const visibleCols = templateTable.getColumns().map(col => col.getField());

        templateTable.setFilter(d =>
            visibleCols.some(f => (d?.[f] ?? "").toString().toLowerCase().includes(q))
        );
    });

    // ✅ Record Count
    templateTable.on("dataLoaded", (data) => {
        $("#recordCount").text("Total Records: " + data.length);
    });

    templateTable.on("dataFiltered", (_, rows) => {
        $("#recordCount").text("Total Records: " + rows.length);
    });

    // ✅ Hide unwanted columns
    templateTable.on("tableBuilt", () => {
        const hideFields = [
            "template_id", "Status_id", "Plant_id", "Version",
            "Created_at", "Updated_at", "Updated_by", "Shiftdetails", "AdditionalProperties"
        ];
        hideFields.forEach(f => templateTable.hideColumn(f));
    });

    // ✅ Modal
    const addEditModal = new bootstrap.Modal($("#addEditModal")[0]);
    let currentMode = "Add";

    // ✅ Add Mode
    $("#add-btn").on("click", function () {
        currentMode = "Add";
        $("#addEditModalLabel").text("Add Shift Template");
        $("#modalSubmitBtn").text("Add");
        $("#addEditForm")[0].reset();
         $("#Template_name").prop("disabled", false);
        addEditModal.show();
    });

    // ✅ Edit Mode
        $("#edit-btn").on("click", function () {
            const sel = templateTable.getSelectedData()?.[0];

            if (!sel)
                return showAppAlert({
                    icon: "warning",
                    title: "No Selection",
                    text: "Select a row to edit."
                });

            currentMode = "Edit";
            $("#addEditModalLabel").text("Edit Shift Template");
            $("#modalSubmitBtn").text("Update");
             $("#Template_name").prop("disabled", true);
            $("#Template_id").val(sel.template_id || "");
            $("#Template_name").val(sel.template_name || "");
            $("#Description").val(sel.template_description || "");
            $("#Shift_id").val(sel.shift_id || "");

           
            let effDate = "";

            if (sel.effective_from) {
                if (sel.effective_from.includes("T")) {
                    // Convert ISO date safely
                    const d = new Date(sel.effective_from);
                    effDate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000))
                                 .toISOString()
                                 .split("T")[0];
                } 
                else if (sel.effective_from.includes("/Date(")) {
                    // For .NET-style /Date(1731369600000)/
                    const ms = parseInt(sel.effective_from.replace(/\D/g, ""), 10);
                    const d = new Date(ms);
                    effDate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000))
                                 .toISOString()
                                 .split("T")[0];
                } 
                else {
                    // Handle normal date string
                    const d = new Date(sel.effective_from);
                    if (!isNaN(d)) {
                        effDate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000))
                                     .toISOString()
                                     .split("T")[0];
                    }
                }
            }

            $("#Effective_from").val(effDate);


            addEditModal.show();
        });


    // ✅ Delete
    $("#delete-btn").on("click", async function () {
        const sel = templateTable.getSelectedData()?.[0];

        if (!sel)
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Select a row to delete."
            });

        const confirm = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete Confirmation",
            text: "Are you sure?"
        });

        if (!confirm.isConfirmed) return;

        const ok = await deleteRecord("/TemplateConfiguration/Delete", { template_id: sel.template_id });
        if (ok) location.reload();
    });

    // ✅ Submit (Add / Edit)
    $("#addEditForm").on("submit", async function (e) {
        e.preventDefault();

        const formData = Object.fromEntries(new FormData(this).entries());

        const payload = {
            template_id: currentMode === "Edit" ? Number(formData.Template_id) : 0,
            template_name: formData.Template_name,
              template_description: formData.Description || "",
            shift_id: Number(formData.Shift_id),
            effective_from: formData.Effective_from
          
        };


        

        const url = currentMode === "Add"
            ? "/TemplateConfiguration/Create"
            : "/TemplateConfiguration/Update";

        const ok = await saveRecord(url, payload, currentMode, addEditModal, this);

        if (ok) location.reload();
    });

    // ✅ Set minimum date for future selection
    const today = new Date().toISOString().split("T")[0];
    $("#Effective_from").attr("min", today);
    $("#download-btn").on("click", function () {
            let rowCount = templateTable.getDataCount ? templateTable.getDataCount() : templateTable.getData().length;
            if (rowCount === 1) {
              const firstRow = templateTable.getData()[0];
              if (!firstRow["Template_id"]) rowCount = 0;
            }

            if (rowCount === 0) {
              showAppAlert({ icon: 'warning', title: 'No Data', text: 'No records found to download.' });
              return;
            }
            downloadCsv(templateTable, "TemplateMaster.csv");
          });

});
</script>
