@model YardManagementApplication.Models.laneModel

@{
    ViewBag.Title = "Plot Lanes & Slots";
    Layout = "_Layout";
}

<head>
    <link href="~/css/site.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<style>
    #map {
        width: 100%;
        height: 70vh;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        position: relative;
    }

    .btn-prof {
        background-color: #b31225 !important;
        border-color: #b31225 !important;
        color: #fff !important;
    }

        .btn-prof:hover {
            background-color: #d3364a !important;
            border-color: #d3364a !important;
            color: #fff !important;
        }

    .config-panel {
        position: relative;
        left: 65px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        margin-bottom: 10px;
        z-index: 999;
        width: 100%;
        max-width: 350px;
    }

        .config-panel h6 {
            font-weight: bold;
        }

    input.form-control-sm, select.form-select-sm {
        font-size: 0.875rem;
    }

    .btn-prof, #generateSlotsBtn, #resetBtn, #saveBtn, .config-panel a.btn {
        background-color: #b31225 !important;
        border-color: #b31225 !important;
        color: #fff !important;
        width: 100%;
        margin-top: 4px;
    }

        .btn-prof:hover, #generateSlotsBtn:hover, #resetBtn:hover, #saveBtn:hover, .config-panel a.btn:hover {
            background-color: #d3364a !important;
            border-color: #d3364a !important;
            color: #fff !important;
        }

    .map-buttons {
        display: flex;
        gap: 6px;
        margin-top: 10px;
        flex-wrap: wrap;
    }

        .map-buttons button, .map-buttons a.btn {
            flex: 1;
        }

    .leaflet-control-zoom {
        left: 40px;
        right: auto;
        top: 10px;
    }
</style>

<div class="container-fluid mt-3">
    <div class="col-12 text-center py-2 mb-3" style="background:#242424; color:white;">
        <h6 class="mb-0 fw-bold text-uppercase">Lane & Slot Configuration</h6>
    </div>

    <div class="row">
        <div class="col-lg-3 col-md-4 col-sm-12">
            <div class="config-panel">
                <h6>Yard: <span id="yardNameLabel">Loading...</span></h6>

                <div class="mb-2">
                    <label class="form-label">Lane Type</label>
                    <select id="laneType" class="form-select form-select-sm">
                        <option value="Runway">Runway</option>
                        <option value="Parking">Parking Lane</option>
                    </select>
                </div>

                <div class="mb-2">
                    <label class="form-label">Lane Mode</label>
                    <select id="laneMode" class="form-select form-select-sm">
                        <option value="click">Click Points on Map</option>
                        <option value="manual">Manual Entry</option>
                    </select>
                </div>

                <div id="manualInputs" class="d-none">
                    <div class="mb-2">
                        <label class="form-label">Start Point (lat,lng)</label>
                        <input type="text" id="startPoint" class="form-control form-control-sm" placeholder="lat,lng" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">End Point (lat,lng)</label>
                        <input type="text" id="endPoint" class="form-control form-control-sm" placeholder="lat,lng" />
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label">Runway Breadth (m)</label>
                    <input type="number" id="runwayBreadth" class="form-control form-control-sm" value="10" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Parking Lane Breadth (m)</label>
                    <input type="number" id="parkingBreadth" class="form-control form-control-sm" value="5" />
                </div>

                <div class="bottom-buttons">
                    <button id="addLaneBtn" class="btn btn-prof">Add Lane</button>
                </div>

                <hr />

                <h6>Slot Configuration</h6>
                <div class="mb-2">
                    <label class="form-label">Slot Length (m)</label>
                    <input type="number" id="slotLength" class="form-control form-control-sm" value="5" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Slot Breadth (m)</label>
                    <input type="number" id="slotBreadth" class="form-control form-control-sm" value="3" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Gap Between Slots (m)</label>
                    <input type="number" id="slotGap" class="form-control form-control-sm" value="1" />
                </div>
                <button id="generateSlotsBtn" class="btn btn-prof w-100">Generate Slots</button>
            </div>
        </div>

        <div class="col-lg-9 col-md-8 col-sm-12">
            <div id="map"></div>

            <div class="map-buttons mt-2">
                <button id="resetBtn" class="btn btn-prof">Reset</button>
                <button id="saveBtn" class="btn btn-prof">Save</button>
                <a href="@Url.Action("Plot", "Yard")" class="btn btn-prof">Back</a>
            </div>
        </div>
    </div>
</div>

<script>
        
    (function(){
        // ---------------- Parse Yard Coordinates ----------------
        const yardCoordsJson = JSON.parse('@Html.Raw(ViewBag.YardCoordinates ?? "[]")');
        const yardId = @Model.Yard_id;
        const yardName = "@Model.Yard_name";

        if (!yardCoordsJson || yardCoordsJson.length === 0) {
            Swal.fire("Error", "No yard coordinates found!", "error");
            window.location.href = '/Yard/Index';
            return;
        }

        // Display Yard name
        document.getElementById("yardNameLabel").textContent = yardName;

        // Initialize map
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22 }).addTo(map);

        // Draw Yard Polygon
        const yardLatLngs = yardCoordsJson.map(p => [p[1], p[0]]);
        const yardPolygon = L.polygon(yardLatLngs, { color: '#b31225', fillColor: '#b31225', fillOpacity: 0.15, weight: 2 }).addTo(map);
        map.fitBounds(yardPolygon.getBounds(), { padding: [40, 40] });

        // ---------------- Layers ----------------
        const laneLayer = L.layerGroup().addTo(map);
        const slotLayer = L.layerGroup().addTo(map);
        let clickPoints = [];
        let lanesCreated = false;
        let lanes = [];

        const laneModeSelect = document.getElementById("laneMode");
        const manualDiv = document.getElementById("manualInputs");

        laneModeSelect.addEventListener("change", ()=>{
            manualDiv.classList.toggle("d-none", laneModeSelect.value!=='manual');
            clickPoints = [];
        });

        // ---------------- Helper Functions ----------------
        const yardTurfPolygon = turf.polygon([yardCoordsJson.concat([yardCoordsJson[0]])]);

        function pointInsideYard(latlng){
            return turf.booleanPointInPolygon(turf.point([latlng.lng, latlng.lat]), yardTurfPolygon);
        }

        function parseCoords(str){
            const parts = str.split(',').map(s => Number(s.trim()));
            return (parts.length === 2 && !parts.some(isNaN)) ? parts : null;
        }

        // ---------------- Lane Creation ----------------
        function createAlternateLanes(startLatLng, endLatLng, runwayBreadth, parkingBreadth){
            laneLayer.clearLayers();
            slotLayer.clearLayers();
            lanes = [];

            let currentStart = [startLatLng[1], startLatLng[0]];
            let currentEnd = [endLatLng[1], endLatLng[0]];
            let runwayCounter = 1, parkingCounter = 1;

            while(true){
                const isRunway = (runwayCounter + parkingCounter) % 2 === 1;
                const laneBreadth = isRunway ? runwayBreadth : parkingBreadth;

                const line = turf.lineString([currentStart, currentEnd]);
                const left = turf.lineOffset(line, laneBreadth/2, { units:'meters' });
                const right = turf.lineOffset(line, -laneBreadth/2, { units:'meters' });

                const coords = [left.geometry.coordinates[0], left.geometry.coordinates[1], right.geometry.coordinates[1], right.geometry.coordinates[0], left.geometry.coordinates[0]];
                const lanePoly = turf.polygon([coords]);

                if(!turf.booleanWithin(lanePoly, yardTurfPolygon)) break;

                const drawCoords = lanePoly.geometry.coordinates[0].map(c => [c[1], c[0]]);
                const laneId = isRunway ? `Runway ${runwayCounter}` : `Parking ${parkingCounter}`;

                L.polygon(drawCoords, {
                    color: isRunway ? '#007bff' : '#2a9d8f',
                    fillColor: isRunway ? '#007bff' : '#2a9d8f',
                    fillOpacity: 0.5
                }).addTo(laneLayer).on('click', ()=>{ Swal.fire("Lane Info", `Lane: ${laneId}`, "info"); });

                lanes.push({ Id: laneId, Type: isRunway ? 'Runway' : 'Parking', Coordinates: drawCoords, TotalSlots: 0, OccupiedSlots: 0, LaneCode: isRunway ? `RL${runwayCounter}` : `PL${parkingCounter}` });

                const bearing = turf.bearing(turf.point(currentStart), turf.point(currentEnd));
                const gap = 1;
                currentStart = turf.destination(turf.point(currentStart), laneBreadth+gap, bearing+90, { units:'meters' }).geometry.coordinates;
                currentEnd = turf.destination(turf.point(currentEnd), laneBreadth+gap, bearing+90, { units:'meters' }).geometry.coordinates;

                isRunway ? runwayCounter++ : parkingCounter++;
            }

            lanesCreated = true;
            Swal.fire("Lanes Added", `${lanes.length} lanes created`, "success");
        }

        // ---------------- Slot Functions ----------------
        function createSlotPolygon(start,end,breadth){
            const bearing = turf.bearing(turf.point(start), turf.point(end));
            const half = breadth/2;
            const p1 = turf.destination(turf.point(start), half, bearing-90,{units:'meters'}).geometry.coordinates;
            const p2 = turf.destination(turf.point(start), half, bearing+90,{units:'meters'}).geometry.coordinates;
            const p3 = turf.destination(turf.point(end), half, bearing+90,{units:'meters'}).geometry.coordinates;
            const p4 = turf.destination(turf.point(end), half, bearing-90,{units:'meters'}).geometry.coordinates;
            return turf.polygon([[p1,p2,p3,p4,p1]]);
        }

        function createSlots(length, breadth, gap){
            slotLayer.clearLayers();
            window.slotPolygons = {};

            lanes.filter(l => l.Type==='Parking').forEach((lane, idx)=>{
                const laneCoords = lane.Coordinates.map(c => [c[1], c[0]]);
                const lanePoly = turf.polygon([laneCoords.concat([laneCoords[0]])]);
                let currentPoint = [laneCoords[0][0], laneCoords[0][1]];
                let slotCounter = 0;
                const bearing = turf.bearing(turf.point(laneCoords[0]), turf.point(laneCoords[1]));

                while(true){
                    const slotEnd = turf.destination(turf.point(currentPoint), length, bearing, { units:'meters' }).geometry.coordinates;
                    const slotPoly = createSlotPolygon(currentPoint, slotEnd, breadth);
                    const clipped = turf.intersect(slotPoly, lanePoly);
                    if(!clipped) break;

                    const drawCoords = clipped.geometry.coordinates[0].map(c => [c[1], c[0]]);
                    const slotCode = `${lane.LaneCode}SL${slotCounter+1}`;
                    const centroid = turf.centroid(clipped).geometry.coordinates;

                    const slotPolyMarker = L.polygon(drawCoords, { color:'#ffc107', fillColor:'#ffc107', fillOpacity:0.6 }).addTo(slotLayer);

                    window.slotPolygons[slotCode] = { marker: slotPolyMarker, booked:false, lat: centroid[1], lng: centroid[0], laneCode: lane.LaneCode, laneId: idx+1 };
                    slotPolyMarker.bindPopup(() => getSlotPopupHTML(slotCode));

                    currentPoint = turf.destination(turf.point(currentPoint), length+gap, bearing, { units:'meters' }).geometry.coordinates;
                    slotCounter++;
                }

                lane.TotalSlots = slotCounter;
                lane.OccupiedSlots = 0;
            });
        }

        function getSlotPopupHTML(slotCode){
            const slot = window.slotPolygons[slotCode];
            return `<b>Lane Code:</b> ${slot.laneCode}<br/><b>Slot Code:</b> ${slotCode}<br/><b>Center:</b> ${slot.lat.toFixed(6)}, ${slot.lng.toFixed(6)}`;
        }

        // ---------------- Event Listeners ----------------
        document.getElementById("generateSlotsBtn").addEventListener("click", ()=>{
            if(!lanesCreated){ Swal.fire("Error","Create lanes first","error"); return; }
            const length = parseFloat(document.getElementById("slotLength").value);
            const breadth = parseFloat(document.getElementById("slotBreadth").value);
            const gap = parseFloat(document.getElementById("slotGap").value);
            if(isNaN(length) || isNaN(breadth) || length<=0 || breadth<=0){ Swal.fire("Error","Invalid slot dimensions","error"); return; }
            createSlots(length,breadth,gap);
        });

        map.on('click', e=>{
            if(laneModeSelect.value!=='click' || lanesCreated) return;
            if(!pointInsideYard(e.latlng)){ Swal.fire("Error","Point must be inside yard","error"); return; }
            clickPoints.push([e.latlng.lat, e.latlng.lng]);
            L.marker([e.latlng.lat, e.latlng.lng]).addTo(laneLayer);
            if(clickPoints.length === 2){
                createAlternateLanes(clickPoints[0], clickPoints[1], parseFloat(document.getElementById("runwayBreadth").value), parseFloat(document.getElementById("parkingBreadth").value));
                clickPoints = [];
            }
        });

        document.getElementById("addLaneBtn").addEventListener("click", ()=>{
            if(lanesCreated){ Swal.fire("Info","Lanes already created. Click reset to start again.","info"); return; }
            if(laneModeSelect.value==='manual'){
                const start = parseCoords(document.getElementById("startPoint").value);
                const end = parseCoords(document.getElementById("endPoint").value);
                if(!start || !end){ Swal.fire("Error","Invalid manual coordinates","error"); return; }
                if(!pointInsideYard({lat:start[0], lng:start[1]}) || !pointInsideYard({lat:end[0], lng:end[1]})){ Swal.fire("Error","Points must be inside yard","error"); return; }
                createAlternateLanes(start,end,parseFloat(document.getElementById("runwayBreadth").value),parseFloat(document.getElementById("parkingBreadth").value));
            } else { Swal.fire("Info","Click on the yard to select start and end points for lanes","info"); }
        });

        document.getElementById("resetBtn").addEventListener("click", ()=>{
            laneLayer.clearLayers();
            slotLayer.clearLayers();
            clickPoints = [];
            lanesCreated = false;
            lanes = [];
        });

            document.getElementById("saveBtn").addEventListener("click", async ()=>{
        if(!lanesCreated){ Swal.fire("Error","Create lanes first","error"); return; }

        try {
            const lanesToSave = lanes.map(l => ({
                Yard_id: yardId,
                Yard_name: yardName,
                Lane_type: l.Type,
                Lane_name: l.Id,
                Lane_code: l.LaneCode,
                Total_slots: l.TotalSlots,
                Occupied_slots: l.OccupiedSlots,
                Status_id: 1,
                Status_name: 'Active'
            }));

            // ✅ Save lanes first
            const laneRes = await fetch('/Lane/SaveAutoLanes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lanesToSave)
            });

            const laneData = await laneRes.json();
            if (!laneData.success) throw new Error(laneData.message);

            console.log("Lanes saved:", laneData.message);

            // ✅ Now prepare slots
            const slotsToSave = Object.keys(window.slotPolygons).map(slotCode => {
                const s = window.slotPolygons[slotCode];
                const laneObj = lanes.find(l => l.LaneCode === s.laneCode);
                const slotNumber = slotCode.replace(/\D/g, '');
                return {
                    Slot_code: slotCode,
                    Slot_name: `${laneObj.Type} ${laneObj.Id.replace(/\D/g, '')} Slot ${slotNumber}`,
                    Lane_id: s.laneId,  // temporary for now
                    Lane_name: laneObj.Id,
                    Slot_type: laneObj.Type,
                    Coordinates: JSON.stringify({ lat: s.lat, lng: s.lng }),
                    Is_occupied: 0,
                    Created_by:"System",
                    Description: "Slot created",
                    Status_id: 1,
                    Status_name: 'Active',
                    Capacity_cnt:1
                };
            });

            console.log("Slots to save:", slotsToSave);

            // ✅ Save slots
            const slotRes = await fetch('/Slot/SaveSlots', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(slotsToSave)
            });

            console.log("Sending slot data:", JSON.stringify(slotsToSave, null, 2));


            const slotData = await slotRes.json();
            if (!slotData.success) throw new Error(slotData.message);

            Swal.fire("Saved", "Lanes and slots saved successfully", "success")
               .then(() => window.location.href = '/Lane/Index');

        } catch (err) {
            Swal.fire("Error", err.message || "Failed to save lanes or slots", "error");
        }
    });


    })();
</script>


