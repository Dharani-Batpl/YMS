@model IEnumerable<YardManagementApplication.Models.laneModel>

@{
    ViewBag.Title = "Lane Configuration";
    Layout = "_Layout";
}

<head>
    <link href="~/css/site.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<style>
    .btn-primary-professional {
        background-color: #b31225;
        border-color: #b31225;
        color: #fff;
        transition: all 0.2s ease-in-out;
    }

        .btn-primary-professional:hover {
            background-color: #d3364a !important;
            border-color: #d3364a !important;
        }

    .toolbar-container {
        display: flex;
        justify-content: flex-end;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

        .toolbar-container .btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.4rem 0.7rem;
        }

    #laneTable {
        margin-top: 10px;
    }
</style>

<div class="container">
    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Lane Configuration</h6>
    </div>

    <div class="row align-items-center mb-3">
        <div class="col-md-6">
            <select id="viewSwitch" class="form-select form-select-sm" style="max-width:200px;">
                <option value="lanes" selected>Lanes</option>
                <option value="slots">Slots</option>
            </select>
        </div>

        <div class="col-md-6 d-flex justify-content-md-end align-items-center gap-2 flex-wrap">
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;" />
            <div class="btn-group flex-wrap" role="group">
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>
            </div>
        </div>
    </div>

    <div id="laneTable" class="tabulator-bootstrap5"></div>
</div>

<!-- Add/Edit Lane Modal (Box Layout) -->
<div class="modal fade" id="addEditLaneModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-sm">
            <div class="modal-header">
                <h6 class="modal-title fw-bold" id="addEditLaneModalLabel">Edit Lane</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="laneForm">
                <!-- Hidden API fields -->
                <input type="hidden" id="FormYard_id" />
                <input type="hidden" id="FormYard_name" />
                <input type="hidden" id="FormLane_code" />
                <input type="hidden" id="FormVersion" value="1" />

                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Row 1: Lane ID full width -->
                        <div class="col-12">
                            <label class="form-label">Lane ID</label>
                            <input type="text" id="FormLane_id" class="form-control" disabled />
                        </div>

                        <!-- Row 2: Lane Type | Total Slots -->
                        <div class="col-md-6">
                            <label class="form-label">Lane Type</label>
                            <input type="text" id="FormLane_type" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Slots</label>
                            <input type="number" id="FormTotal_slots" class="form-control" min="0" required />
                        </div>

                        <!-- Row 3: Occupied Slots | Status -->
                        <div class="col-md-6">
                            <label class="form-label">Occupied Slots</label>
                            <input type="number" id="FormOccupied_slots" class="form-control" min="0" required />
                        </div>
                        <div class="col-md-6">
                            <label for="Status_id" class="form-label">Status Name</label>
                            <select class="form-control" id="Status_id" name="StatusId" required
                                    asp-items="@(ViewBag.LaneStatusList as IEnumerable<SelectListItem>)">
                                <option value="" selected disabled>-- Select Status --</option>
                            </select>
                        </div>

                        <!-- Row 4: Description full width -->
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <input type="text" id="FormDescription" class="form-control" />
                        </div>
                    </div>
                </div>

                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="modalSubmitBtn" class="btn btn-primary-professional btn-sm">Save Lane</button>
                </div>
            </form>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const laneData = @Html.Raw(ViewData["LaneData"]);
        let selectedRow = null;

        // const table = new Tabulator("#laneTable", {
        //     data: laneData,
        //     layout: "fitColumns",
        //     placeholder: "No lane records available",
        //     selectable: 1,
        //     pagination: "local",
        //     paginationSize: 10,
        //     paginationSizeSelector: [10, 20, 50],
        //     paginationButtonCount: 5,
        //     columns: [
        //         { title: "Lane ID", field: "Lane_id", width: 120, hozAlign: "center" },
        //         { title: "Yard Name", field: "Yard_name" },
        //         { title: "Lane Type", field: "Lane_type" },
        //         { title: "Total Slots", field: "Total_slots" },
        //         { title: "Occupied Slots", field: "Occupied_slots" },
        //         { title: "Status", field: "Status_name" }
        //     ]
        // });

           const table = new Tabulator("#laneTable", {
        data: laneData,
        layout: "fitColumns",
        placeholder: "No lane records available",
        selectable: 1,
        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [10, 20, 50],
        paginationButtonCount: 5,
        columns: [
            { title: "Lane ID", field: "Lane_id", width: 120, hozAlign: "center" },
            { title: "Yard Name", field: "Yard_name" },
            { title: "Lane Type", field: "Lane_type" },
            { title: "Total Slots", field: "Total_slots" },
            { title: "Occupied Slots", field: "Occupied_slots" },
            { title: "Status", field: "Status_name" }
        ],
        locale: true,
langs: {
     "default": {
         "pagination": {
             "first": "<<",
             "first_title": "First Page",
             "last": ">>",
             "last_title": "Last Page",
             "prev": "<",
             "prev_title": "Prev Page",
             "next": ">",
             "next_title": "Next Page",
         }
     }
}
    }); 

        table.on("rowSelected", row => selectedRow = row.getData());
        table.on("rowDeselected", () => selectedRow = null);

        // -----------------------------
        // Search filter
        // -----------------------------
        document.getElementById("searchField").addEventListener("input", e => {
            const val = e.target.value.toLowerCase();
            table.setFilter(row => Object.values(row).some(v => String(v).toLowerCase().includes(val)));
        });

       
        // Edit button handler
    document.getElementById("edit-btn").addEventListener("click", () => {
        if (!selectedRow) return Swal.fire("Error", "Select a lane first!", "error");

        // Fill the form fields with selected lane data
        document.getElementById("FormLane_id").value = selectedRow.Lane_id;
        document.getElementById("FormLane_type").value = selectedRow.Lane_type;
        document.getElementById("FormTotal_slots").value = selectedRow.Total_slots;
        document.getElementById("FormOccupied_slots").value = selectedRow.Occupied_slots;
        document.getElementById("Status_id").value = selectedRow.Status_id;
        document.getElementById("FormDescription").value = selectedRow.Description ?? "";

        // Fill hidden fields required for API
        document.getElementById("FormYard_id").value = selectedRow.Yard_id;
        document.getElementById("FormYard_name").value = selectedRow.Yard_name;
        document.getElementById("FormLane_code").value = selectedRow.Lane_code ?? "";
        document.getElementById("FormVersion").value = selectedRow.Version ?? 1;

        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('addEditLaneModal'));
        editModal.show();
    });


    // -----------------------------
    // Modal form submit
    // -----------------------------
        document.getElementById("laneForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const updatedLane = {
            Lane_id: parseInt(document.getElementById("FormLane_id").value),
            Yard_id: parseInt(document.getElementById("FormYard_id").value),
            Yard_name: document.getElementById("FormYard_name").value,
            Lane_code: document.getElementById("FormLane_code").value,
            Lane_type: document.getElementById("FormLane_type").value,
            Total_slots: parseInt(document.getElementById("FormTotal_slots").value),
            Occupied_slots: parseInt(document.getElementById("FormOccupied_slots").value),
            Status_id: parseInt(document.getElementById("Status_id").value),
            Status_name: document.getElementById("Status_id").selectedOptions[0].text,
            Description: document.getElementById("FormDescription").value,
            Version: parseInt(document.getElementById("FormVersion").value)
        };

        try {
            const response = await fetch('/Lane/Update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedLane)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }

            Swal.fire("Success", "Lane updated successfully!", "success").then(() => location.reload());
        } catch (err) {
            Swal.fire("Error", "Update failed: " + err.message, "error");
        }
    });



        // -----------------------------
        // Delete button
        // -----------------------------
        document.getElementById("delete-btn").addEventListener("click", async () => {
            if (!selectedRow) return Swal.fire("Error", "Select a lane first!", "error");

            const result = await Swal.fire({
                title: 'Delete Confirmation',
                text: `Do you want to delete lane "${selectedRow.Lane_id}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Delete',
                confirmButtonColor: '#b31225'
            });

            if (result.isConfirmed) {
                try {
                    await fetch('/Lane/Delete', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ Lane_id: selectedRow.Lane_id })
                    });

                    Swal.fire("Deleted!", "Lane deleted successfully.", "success");
                    location.reload();
                } catch (err) {
                    Swal.fire("Error", "Delete failed: " + err.message, "error");
                }
            }
        });

        // -----------------------------
        // Download button
        // -----------------------------
        document.getElementById("download-btn").addEventListener("click", () => {
            table.download("csv", "LaneData.csv");
        });

        // -----------------------------
        // View switch (lane/slot)
        // -----------------------------
        document.getElementById("viewSwitch").addEventListener("change", e => {
            const viewMode = e.target.value;
            if (viewMode === "slots") window.location.href = "/Slot/Index";
            else window.location.href = "/Lane/Index";
        });

        // -----------------------------
        // Initialize Bootstrap tooltips
        // -----------------------------
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
    });
</script>
