@model IEnumerable<YardManagementApplication.SlotModel>

@{
    ViewBag.Title = "Slot Configuration";
    Layout = "_Layout";
}

<head>
    <link href="~/css/site.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<style>
    .btn-primary-professional {
        background-color: #b31225;
        border-color: #b31225;
        color: #fff;
        transition: all 0.2s ease-in-out;
    }

        .btn-primary-professional:hover {
            background-color: #d3364a !important;
            border-color: #d3364a !important;
        }

    .toolbar-container {
        display: flex;
        justify-content: flex-end;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

        .toolbar-container .btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.4rem 0.7rem;
        }

    #slotTable {
        margin-top: 10px;
    }
    .main-container {
            margin-left: 5px;
            margin-right: 5px;
        }
</style>

<div class="main-container">
    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Slot Configuration</h6>
    </div>

    <div class="row align-items-center mb-3">
        <div class="col-md-6">
            <select id="viewSwitch" class="form-select form-select-sm" style="max-width:200px;">
                <option value="lanes">Lanes</option>
                <option value="slots" selected>Slots</option>
            </select>
        </div>

        <div class="col-md-6 d-flex justify-content-md-end align-items-center gap-2 flex-wrap">
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;" />
            <div class="btn-group flex-wrap" role="group">
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>
            </div>
        </div>
    </div>

    <div id="slotTable" class="tabulator-bootstrap5"></div>
</div>

<!-- Add/Edit Slot Modal -->
<div class="modal fade" id="addEditSlotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-sm">
            <div class="modal-header">
                <h6 class="modal-title fw-bold" id="addEditSlotModalLabel">Edit Slot</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="slotForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Row 1: Slot ID full width -->
                        <div class="col-12">
                            <label class="form-label">Slot ID</label>
                            <input type="text" id="FormSlot_id" class="form-control" disabled />
                        </div>

                        <!-- Row 2: Slot Type | Is Occupied -->
                        <div class="col-md-6">
                            <label class="form-label">Slot Type</label>
                            <input type="text" id="FormSlot_type" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Occupied</label>
                            <select id="FormIs_occupied" class="form-select" required>
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>

                        <!-- Row 3: Status | Description -->
                        <div class="col-md-6">
                            <label for="Status_id" class="form-label">Status Name</label>
                            <select class="form-control" id="Status_id" name="StatusId" required
                                    asp-items="@(ViewBag.SlotStatusList as IEnumerable<SelectListItem>)">
                                <option value="" selected disabled>-- Select Status --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Description</label>
                            <input type="text" id="FormDescription" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="modalSubmitBtn" class="btn btn-primary-professional btn-sm">Save Slot</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    (() => {
        const slotData = @Html.Raw(ViewData["SlotData"]);
        let selectedRow = null;

        // const table = new Tabulator("#slotTable", {
        //     data: slotData,
        //     layout: "fitColumns",
        //     placeholder: "No slot records available",
        //     selectable: 1,
        //     pagination: "local",
        //     paginationSize: 10,
        //     paginationSizeSelector: [10, 20, 50],
        //     paginationButtonCount: 5,
        //     columns: [
        //         { title: "Slot ID", field: "Slot_id", hozAlign: "center" },
        //         { title: "Lane Name", field: "Lane_name" },
        //         { title: "Slot Code", field: "Slot_code" },
        //         { title: "Slot Name", field: "Slot_name" },
        //         { title: "Type", field: "Slot_type" },
        //         { title: "Coordinates", field: "Coordinates" },
        //         { title: "Occupied", field: "Is_occupied" },
        //         { title: "Status", field: "Status_name" }
        //     ]
        // });

            const table = new Tabulator("#slotTable", {
            data: slotData,
            layout: "fitColumns",
            placeholder: "No slot records available",
            selectable: 1,
            pagination: "local",
            paginationSize: 10,
            paginationSizeSelector: [10, 20, 50],
            paginationButtonCount: 5,
            columns: [
                { title: "Slot ID", field: "Slot_id", hozAlign: "center" },
                { title: "Lane Name", field: "Lane_name" },
                { title: "Slot Code", field: "Slot_code" },
                { title: "Slot Name", field: "Slot_name" },
                { title: "Type", field: "Slot_type" },
                { title: "Coordinates", field: "Coordinates" },
                { title: "Occupied", field: "Is_occupied" },
                { title: "Status", field: "Status_name" }
            ],

            locale: true,
    langs: {
         "default": {
             "pagination": {
                 "first": "<<",
                 "first_title": "First Page",
                 "last": ">>",
                 "last_title": "Last Page",
                 "prev": "<",
                 "prev_title": "Prev Page",
                 "next": ">",
                 "next_title": "Next Page",
             }
         }
    }
        });

            table.on("rowSelected", row => selectedRow = row.getData());
        table.on("rowDeselected", () => selectedRow = null);

        // Search filter
        document.getElementById("searchField").addEventListener("input", e => {
            const val = e.target.value.toLowerCase();
            table.setFilter(row => Object.values(row).some(v => String(v).toLowerCase().includes(val)));
        });

        // Edit button
        document.getElementById("edit-btn").addEventListener("click", () => {
            if (!selectedRow) return Swal.fire("Error", "Select a slot first!", "error");

            // Fill the modal fields
            document.getElementById("FormSlot_id").value = selectedRow.Slot_id;
            document.getElementById("FormSlot_type").value = selectedRow.Slot_type;
            document.getElementById("FormIs_occupied").value = selectedRow.Is_occupied;
            document.getElementById("Status_id").value = selectedRow.Status_id;
            document.getElementById("FormDescription").value = selectedRow.Description || "";

            // Show modal
            const editModal = new bootstrap.Modal(document.getElementById('addEditSlotModal'));
            editModal.show();
        });

        // Modal form submit
           // Modal form submit
    document.getElementById("slotForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!selectedRow) return Swal.fire("Error", "No slot selected!", "error");

        // Build full update object matching SlotUpdateModel expected by controller
        const updatedSlot = {
            Slot_id: selectedRow.Slot_id,
            Lane_id: selectedRow.Lane_id,
            Lane_name: selectedRow.Lane_name,
            Slot_code: selectedRow.Slot_code,
            Slot_name: selectedRow.Slot_name,
            Slot_type: document.getElementById("FormSlot_type").value,
            Is_occupied: parseInt(document.getElementById("FormIs_occupied").value),
            Status_id: parseInt(document.getElementById("Status_id").value),
            Status_name: selectedRow.Status_name,
            Description: document.getElementById("FormDescription").value,
            Coordinates: selectedRow.Coordinates,
            Capacity_cnt: selectedRow.Capacity_cnt,
            Version: selectedRow.Version
        };

        try {
            const response = await fetch('/Slot/Update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedSlot)
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message || "Unknown error");
            }

            Swal.fire("Success", "Slot updated successfully!", "success").then(() => location.reload());
        } catch (err) {
            Swal.fire("Error", "Update failed: " + err.message, "error");
        }
    });


        // Delete button
        document.getElementById("delete-btn").addEventListener("click", async () => {
            if (!selectedRow) return Swal.fire("Error", "Select a slot first!", "error");

            const result = await Swal.fire({
                title: 'Delete Confirmation',
                text: `Do you want to delete slot "${selectedRow.Slot_id}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Delete',
                confirmButtonColor: '#b31225'
            });

            if (result.isConfirmed) {
                try {
                    await fetch('/Slot/Delete', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ Slot_id: selectedRow.Slot_id })
                    });

                    Swal.fire("Deleted!", "Slot deleted successfully.", "success");
                    location.reload();
                } catch (err) {
                    Swal.fire("Error", "Delete failed: " + err.message, "error");
                }
            }
        });

        // Download button
        document.getElementById("download-btn").addEventListener("click", () => {
            table.download("csv", "SlotData.csv");
        });

        // View switch
        document.getElementById("viewSwitch").addEventListener("change", e => {
            const viewMode = e.target.value;
            if (viewMode === "lanes") window.location.href = "/Lane/Index";
            else window.location.href = "/Slot/Index";
        });

        // Tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
    })();
</script>
