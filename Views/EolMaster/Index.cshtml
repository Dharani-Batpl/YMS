<!-- Get View Data -->
@{
    var eolMasterData = ViewData["EolMasterData"] ?? "[]";
    Layout = "_Layout"; 
}

<head></head>

<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
</style>

<div class="main-container">

    <!------- Page Title Section ------->

    <div class="col-12 text-center py-1 mb-3" style="background: #242424; color: white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">EOL Master</h6>
    </div>

    <!------- Toolbar: Search + Actions ------->
    <div class="row align-items-center mb-3">

        <!-- Spacer on xs devices -->
        <div class="w-100 d-md-none"></div>

        <!-- Toolbar container -->
        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

            <!-- Search input -->
            <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;" />

            <!-- Action buttons group -->
            <div class="btn-group flex-wrap" role="group" aria-label="Icon button group" style="flex-wrap: wrap;">

                <!-- Add -->
                <button id="add-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Add" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Add">
                    <span class="material-icons" aria-hidden="true">add</span>
                </button>

                <!-- Edit -->
                <button id="edit-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Edit" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Edit">
                    <span class="material-icons" aria-hidden="true">edit</span>
                </button>

                <!-- Delete -->
                <button id="delete-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Delete">
                    <span class="material-icons" aria-hidden="true">delete</span>
                </button>

                <!-- Download -->
                <button id="download-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download">
                    <span class="material-icons" aria-hidden="true">download</span>
                </button>

                <!-- Upload -->
                <button id="upload-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Upload" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Upload">
                    <span class="material-icons" aria-hidden="true">upload</span>
                </button>

                <!-- Download Template -->
                <button id="download-template-btn" type="button" class="btn btn-primary-professional btn-sm px-3" title="Download Template" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Download Template">
                    <span class="material-icons" aria-hidden="true">assignment_returned</span>
                </button>
            </div>
        </div>
    </div>

    <!------- Data grid + record count ------->
    <div id="eolTable" class="tabulator-bootstrap5"></div>

    <div id="eolTable-footer"></div>

    <div id="recordCount" class="footer-total-records"></div>
</div>

<!------- Add/Edit Modal ------->

<div class="modal fade modal-request" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            
            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="addEditModalLabel">Request Part: <span id="modalPartTitle">EOL Master</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <form id="addEditForm" novalidate>
                    <input type="hidden" id="Eol_production_id" name="Id" />

                    <div class="row g-3">
                        <!-- Brand -->
                        <div class="col-12">
                            <label class="form-label" for="Brand_id">Brand <span class="text-danger">*</span></label>
                            <select class="form-select" id="Brand_id" name="Brand_id" asp-items="@(ViewBag.BrandList as IEnumerable<SelectListItem>)" required>
                                <option value="" selected disabled>Select Brand</option>
                            </select>
                        </div>

                        <!-- Vehicle Type -->
                        <div class="col-12">
                            <label class="form-label" for="Vehicle_type_id">Vehicle Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="Vehicle_type_id" name="Vehicle_type_id" required>
                                <option value="" selected disabled>Select Type</option>
                            </select>
                        </div>

                        <!-- Variant -->
                        <div class="col-12">
                            <label class="form-label" for="Variant_id">Variant <span class="text-danger">*</span></label>
                            <select class="form-select" id="Variant_id" name="Variant_id" required>
                                <option value="" selected disabled>Select Variant</option>
                            </select>
                        </div>

                        <!-- VIN -->
                        <div class="col-12">
                            <label class="form-label" for="Vin">VIN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Vin" name="Vin" minlength="17" maxlength="17" required pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z0-9]{17}$" inputmode="latin-prose" title="VIN must be exactly 17 characters and contain both letters and numbers." autocomplete="off" >
                        </div>

                        <!-- Production Order -->
                        <div class="col-12">
                            <label class="form-label" for="Production_order_id">Production Order ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Production_order_id" name="production_order_id" maxlength="50" required pattern="^[A-Za-z0-9 ]+$" inputmode="text" title="Only letters,space and numbers are allowed." autocomplete="off" >
                        </div>

                        <!-- Color -->
                        <div class="col-12">
                            <label class="form-label" for="Color_id">Color <span class="text-danger">*</span></label>
                            <select class="form-select" id="Color_id" name="Color_id" asp-items="@(ViewBag.ColorList as IEnumerable<SelectListItem>)" required>
                                <option value="" selected disabled>Select Color</option>
                            </select>
                        </div>

                        <!-- EOL Quality Inspector -->
                        <div class="col-12">
                            <label class="form-label" for="Eol_quality_inspector_id">EOL Quality Inspector ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Eol_quality_inspector_id" name="Eol_quality_inspector_id" maxlength="50" required pattern="^[A-Za-z0-9 ]+$" inputmode="text" autocomplete="off" >
                        </div>

                        <!-- Batch/Lot -->
                        <div class="col-12">
                            <label class="form-label" for="Batch_lot_number">Batch/Lot Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Batch_lot_number" name="batch_lot_number" maxlength="50" required pattern="^[A-Za-z0-9 ]+$" inputmode="text" autocomplete="off" >
                        </div>

                        <!-- Line ID -->
                        <div class="col-12">
                            <label class="form-label" for="Line_id">Line ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Line_id" name="Line_id" maxlength="50" required pattern="^[A-Za-z0-9 ]+$" inputmode="text" autocomplete="off" >
                        </div>

                        <!-- Shop ID -->
                        <div class="col-12">
                            <label class="form-label" for="Shop_id">Shop ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Shop_id" name="Shop_id" maxlength="50" required pattern="^[A-Za-z0-9 ]+$" inputmode="text" autocomplete="off" >
                        </div>

                        <!-- Completion Timestamp -->
                        <div class="col-12">
                            <label class="form-label" for="Completion_at">Completion Timestamp <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="Completion_at" name="completion_at" required>
                        </div>

                        <!-- Quality Status -->
                        <div class="col-12">
                            <label class="form-label" for="Quality_status_id">Quality Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="Quality_status_id" name="Quality_status_id" asp-items="@(ViewBag.QualityStatusList as IEnumerable<SelectListItem>)" required>
                                <option value="" selected disabled>Select Status</option>
                            </select>
                        </div>

                        <!-- Certificate -->
                        <div class="col-12">
                            <label class="form-label" for="Certificate_id">Certificate ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Certificate_id" name="Certificate_id" maxlength="50" required pattern="^[A-Za-z0-9 ]+$" inputmode="text" autocomplete="off" >
                        </div>

                    </div>

                </form>
            </div>

            <!-- Footer -->
            <div class="modal-footer">

                 <!-- Buttons -->
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-submit" id="modalSubmitBtn" form="addEditForm">Add</button>
            </div>
        </div>
    </div>
</div>
<!------- Hidden file input for CSV upload ------->
<form id="afForm" style="display:none" method="post">
    @Html.AntiForgeryToken()
    <input type="file" id="upload-file" style="display:none" accept=".xlsx,.xls,.csv" />

</form>
 <!-- Scrips -->
<script>
$(document).ready(function () {

    // ================================================================
    //  Utility: Check if value is blank or spaces only
    // ================================================================
    function isBlankOrSpaces(v) {
        return !v || $.trim(v).length === 0;
    }

    // ================================================================
    //  Normalize and validate input fields
    // ================================================================
    function normalizeAndValidateField($el) {
        if (!$el.is('input[type="text"], textarea')) return true;

        // Replace multiple spaces → single space & trim ends
        const trimmed = $el.val().replace(/\s+/g, ' ').trim();
        $el.val(trimmed);

        // Reset HTML5 validation
        $el[0].setCustomValidity("");

        // Required field check
        if ($el.is('[required]') && isBlankOrSpaces($el.val())) {
            $el[0].setCustomValidity("This field cannot be empty or only spaces.");
            return false;
        }

        return true;
    }

    // ================================================================
    //  Form input auto-validation
    // ================================================================
    const $form = $("#addEditForm");

    $form.on("input", 'input[type="text"], textarea', function () {
        this.setCustomValidity("");
    });

    $form.on("blur", 'input[type="text"], textarea', function () {
        normalizeAndValidateField($(this));
    });

    // Global validator for form submit
    window.validateNoSpaceOnlyInputs = function (formEl) {
        let ok = true;
        $(formEl).find('input[type="text"], textarea').each(function () {
            if (!normalizeAndValidateField($(this))) {
                this.reportValidity();
                this.focus();
                ok = false;
                return false;
            }
        });
        return ok;
    };

    // ================================================================
    //  Dropdown Helpers
    // ================================================================
    function populateDropdown(selector, items, defaultText) {
        const $dropdown = $(selector);
        $dropdown.empty();

        $('<option>', {
            text: defaultText,
            value: '',
            disabled: true,
            selected: true
        }).appendTo($dropdown);

        if (items && items.length > 0) {
            $.each(items, function (_, item) {
                $('<option>', {
                    value: item.id,
                    text: item.name
                }).appendTo($dropdown);
            });
        }
    }

    // Ensure dropdown has a given option (for edit mode)
    function ensureOption($select, value, label) {
        const val = String(value ?? "");
        if (!val) return;

        if ($select.find(`option[value="${CSS.escape(val)}"]`).length === 0) {
            $('<option>', {
                value: val,
                text: label ?? val
            }).appendTo($select);
        }
    }

    // ==============================
    // AJAX: Fetch dependent dropdowns
    // ==============================
    async function fetchVehicleTypes(brandId) {
        try {
            const data = await $.getJSON(`/EolMaster/GetVehicleType`, { brandId });
            return data.vehicletypeList ?? [];
        } catch {
            return [];
        }
    }

    async function fetchVariants(vehicleTypeId) {
        try {
            const data = await $.getJSON(`/EolMaster/GetVariant`, { vehicleTypeId });
            return data.variantList ?? [];
        } catch {
            return [];
        }
    }

    function resetSelect($select, placeholder) {
        $select.empty().append($('<option>', {
            value: '',
            text: placeholder,
            disabled: true,
            selected: true
        }));
    }

    // ================================================================
    //  Bind dropdowns when editing an existing row
    // ================================================================
    window.bindDropdownsFromRow = async function (row) {
        const $brandSel = $('#Brand_id');
        const $typeSel = $('#Vehicle_type_id');
        const $variantSel = $('#Variant_id');
        const $colorSel = $('#Color_id');

        const brandId = row.Brand_id;
        const brandName = row.Brand_name;
        const vehicleTypeId = row.Vehicle_type_id;
        const vehicleTypeNm = row.Vehicle_type_name || row.Vehicle_type;
        const variantId = row.Variant_id;
        const variantName = row.Variant_name || row.Variant;
        const colorId = row.Color_id;

        // Brand
        ensureOption($brandSel, brandId, brandName);
        $brandSel.val(String(brandId ?? ""));

        // Vehicle Type
        resetSelect($typeSel, "Loading types…");
        const types = brandId ? await fetchVehicleTypes(brandId) : [];
        populateDropdown('#Vehicle_type_id', types, "Select Type");
        if (vehicleTypeId) ensureOption($typeSel, vehicleTypeId, vehicleTypeNm);
        $typeSel.val(String(vehicleTypeId ?? ""));

        // Variant
        resetSelect($variantSel, "Loading variants…");
        const variants = vehicleTypeId ? await fetchVariants(vehicleTypeId) : [];
        populateDropdown('#Variant_id', variants, "Select Variant");
        if (variantId) ensureOption($variantSel, variantId, variantName);
        $variantSel.val(String(variantId ?? ""));

        // Color
        if (colorId != null) $colorSel.val(String(colorId));
    };

    // ================================================================
    //  On Change → Cascade Dropdowns
    // ================================================================
    $('#Brand_id').on('change', function () {
        const brandId = $(this).val();
        $.getJSON(`/EolMaster/GetVehicleType`, { brandId })
            .done(function (data) {
                populateDropdown('#Vehicle_type_id', data.vehicletypeList, 'Select Type');
                populateDropdown('#Variant_id', [], 'Select Variant');
            });
    });

    $('#Vehicle_type_id').on('change', function () {
        const vehicleTypeId = $(this).val();
        $.getJSON(`/EolMaster/GetVariant`, { vehicleTypeId })
            .done(function (data) {
                populateDropdown('#Variant_id', data.variantList, 'Select Variant');
            });
    });

    // ================================================================
    //  TABULATOR TABLE SETUP
    // ================================================================
    const eolMasterData = JSON.parse('@Html.Raw(eolMasterData)');
    let selectedRow = null;
    let currentMode = "";

    const dataTable = new Tabulator("#eolTable", {
        data: eolMasterData,
        columns: generateTabulatorColumns(eolMasterData),
        layout: "fitDataStretch",
        height: "80vh",
        selectable: 1,
        pagination: "local",

        // Disable resizing & dragging
        resizableRows: false,
        resizableRowGuide: false,
        resizableColumnGuide: false,
        columnDefaults: { resizable: false },
        movableColumns: false,

        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],

        locale: true,
        langs: {
            "en": {
                pagination: {
                    first: "<<",
                    first_title: "First",
                    last: ">>",
                    last_title: "Last",
                    prev: "<",
                    prev_title: "Prev",
                    next: ">",
                    next_title: "Next",
                    page_size: "Page Size"
                }
            }
        },

        // Track selected row
        rowClick: function (e, row) {
            selectedRow = row.getData();
        }
    });

    // ================================================================
    //  Search Filter
    // ================================================================
    $("#searchField").on("keyup", function () {
        const value = $(this).val().toLowerCase();

        if (value === "") {
            dataTable.clearFilter();
            return;
        }

        dataTable.setFilter(function (data) {
            return Object.values(data)
                .join(" ")
                .toLowerCase()
                .includes(value);
        });
    });

    // ================================================================
    //  Table Events (hide columns, rename headers)
    // ================================================================
    dataTable.on("dataLoaded", function (data) {
        updateRecordCount(dataTable, data, "Eol_production_id");
    });

    dataTable.on("tableBuilt", function () {

        // Fields to hide
        const hideFields = [
            "Eol_production_id",
            "Shift_id",
            "Eol_quality_inspector_name",
            "Color_id",
            "Shift_name",
            "Quality_status",
            "Transit_status",
            "Quality_status_id",
            "Brand_id",
            "Vehicle_type_id",
            "Variant_id",
            "Updated_by",
            "Is_deleted",
            "Created_at",
            "Updated_at",
            "Version",
            "AdditionalProperties"
        ];

        // Rename mapping
        const columnRenameMap = {
            "Vin": "VIN",
            "Line_id": "Line ID",
            "Eol_quality_inspector_id": "EOL Quality Inspector ID",
            "Production_order_id": "Production Order ID",
            "Certificate_id": "Certificate ID",
            "Shop_id": "Shop ID"
        };

        // Hide columns
        hideFields.forEach(field => {
            if (dataTable.getColumn(field)) {
                dataTable.hideColumn(field);
            }
        });

        // Rename columns
        Object.entries(columnRenameMap).forEach(([field, newTitle]) => {
            const col = dataTable.getColumn(field);
            if (col) col.updateDefinition({ title: newTitle });
        });
    });

    // ================================================================
    //  MODAL SETUP
    // ================================================================
    const $addEditModalEl = $('#addEditModal');
    const addEditModal = new bootstrap.Modal($addEditModalEl[0]);

    // ================================================================
    //  ADD RECORD
    // ================================================================
    $('#add-btn').on('click', function () {
        currentMode = "Add";
        $form[0].reset();

        resetSelect($('#Vehicle_type_id'), "Select Type");
        resetSelect($('#Variant_id'), "Select Variant");

        $('#addEditModalLabel').text("Add EOL Master");
        $('#modalSubmitBtn').text("Add");
        $('#Eol_production_id').val(0);

        $('#Brand_id, #Vehicle_type_id, #Variant_id, #Vin').prop('disabled', false);

        addEditModal.show();
    });

    // ================================================================
    //  EDIT RECORD
    // ================================================================
    $('#edit-btn').on('click', async function () {

        const row = dataTable.getSelectedData()?.[0];
        if (!row) {
            return showAppAlert({
                icon: 'warning',
                title: 'No Selection',
                text: 'Please select a row to edit.'
            });
        }

        currentMode = "Edit";
        $('#addEditModalLabel').text("Edit EOL Master");
        $('#modalSubmitBtn').text("Update");

        // Populate form
        $.each(row, function (field, value) {
            const $el = $('#' + field);
            if ($el.length === 0) return;

            if ($el.attr('type') === "datetime-local" && value) {
                const dt = new Date(value);
                const iso = dt.toISOString().slice(0, 16);
                $el.val(iso);
            } else {
                $el.val(value ?? "");
            }
        });

        await bindDropdownsFromRow(row);

        $('#Brand_id, #Vehicle_type_id, #Variant_id, #Vin').prop('disabled', true);

        addEditModal.show();
    });

    // ================================================================
    //  DELETE RECORD
    // ================================================================
    $("#delete-btn").on("click", async function () {

        const row = dataTable.getSelectedData()?.[0];
        if (!row) {
            return showAppAlert({
                icon: "warning",
                title: "No Selection",
                text: "Please select a row to delete."
            });
        }

        const confirm = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete Confirmation",
            text: "Are you sure you want to delete this record?"
        });

        if (!confirm.isConfirmed) return;

        const success = await deleteRecord("/EolMaster/Delete", { Vin: row.Vin });

        if (success) setTimeout(() => window.location.href = "/EolMaster/Index", 900);
    });

    // ================================================================
    //  FORM SUBMIT (Add / Update)
    // ================================================================
    $form.on("submit", async function (e) {
        e.preventDefault();
        if (!validateNoSpaceOnlyInputs(this)) return;

        const formData = Object.fromEntries(new FormData(this).entries());

        // Include disabled fields
        $(this).find(":disabled").each(function () {
            if (this.name) formData[this.name] = this.value;
        });

        const fetchUrl =
            currentMode === "Add"
                ? "/EolMaster/Create"
                : "/EolMaster/Update";

        const success = await saveRecord(fetchUrl, formData, currentMode, addEditModal, this);

        if (success) setTimeout(() => window.location.href = "/EolMaster/Index", 900);
    });

    // ================================================================
    //  DOWNLOAD CSV
    // ================================================================
    $("#download-btn").on("click", function () {
        let rowCount = dataTable.getDataCount ? dataTable.getDataCount() : dataTable.getData().length;

        if (rowCount === 1) {
            const firstRow = dataTable.getData()[0];
            if (!firstRow["Eol_production_id"]) rowCount = 0;
        }

        if (rowCount === 0) {
            showAppAlert({
                icon: 'warning',
                title: 'No Data',
                text: 'No records found to download.'
            });
            return;
        }

        downloadCsv(dataTable, "EolMaster.csv");
    });

    // ================================================================
    //  UPLOAD HANDLER
    // ================================================================
    $("#upload-btn").on("click", function () {
        $("#upload-file").click();
    });

    $("#upload-file").on("change", function (event) {

        const file = event.target.files?.[0];
        if (!file) {
            return showAppAlert({
                icon: 'warning',
                title: 'No File',
                text: 'Please select a file to upload.'
            });
        }

        const isExcel = /\.(xlsx|xls)$/i.test(file.name);
        if (!isExcel) {
            showAppAlert({
                icon: 'warning',
                title: 'Invalid File',
                text: 'Please select an Excel file (.xlsx or .xls).'
            });
            return;
        }

        uploadFile('/EolMaster/Upload', file);
    });

    // Upload POST call
    async function uploadFile(url, file) {
        const formData = new FormData();
        formData.append("file", file);

        const csrf = $('#afForm input[name="__RequestVerificationToken"]').val();

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'RequestVerificationToken': csrf },
                body: formData
            });

            await handleUploadResponse(response);
        } catch (err) {
            showToast({ icon: "error", text: err.message });
        }
    }

    // Handle API Response from Upload
    async function handleUploadResponse(response) {

        const result = await response.json().catch(() => null);

        // SUCCESS
        if (response.ok) {

            showAppAlert({
                icon: result.status,
                title: result.title,
                text: result.message,
                timer: 2500,
                showConfirmButton: false
            });

            setTimeout(() => location.reload(), 800);
            $("#upload-file").val("");
            return;
        }

        // FIELD ERRORS
        if (result && result.errors) {
            let msg = "";
            result.errors.forEach(e => {
                msg += `VIN: ${e.vin}\nError: ${e.error}\n\n`;
            });

            showAppAlert({
                icon: "error",
                title: "Upload Failed",
                text: msg,
                timer: 4500,
                showConfirmButton: false
            });

            $("#upload-file").val("");
            return;
        }

        // GENERIC API MESSAGE
        if (result && result.message) {
            showAppAlert({
                icon: "error",
                title: "Upload Failed",
                text: result.message,
                timer: 3500,
                showConfirmButton: false
            });

            $("#upload-file").val("");
            return;
        }

        // UNKNOWN ERROR
        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: "Unexpected error.",
            timer: 3500,
            showConfirmButton: false
        });

        $("#upload-file").val("");
    }

    function downloadInvalidRecords(fileData) {
        const csvData = atob(fileData);
        const blob = new Blob([csvData], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'invalid_records.csv';
        link.click();
    }

});

// ================================================================
// Download Template 
// ================================================================
$("#download-template-btn").on("click", function () {

    const headers = [
        "Vin",
        "Production Order Id",
        "Product Description",
        "Shift Name",
        "Date Of Production",
        "Eol Quality Inspector Id",
        "Eol Quality Inspector Name",
        "Color Name",
        "Brand Name",
        "Vehicle Type Name",
        "Variant Name",
        "Batch Lot Number",
        "Line Id",
        "Shop Id",
        "Completion At",
        "Quality Status Name",
        "Certificate Id"
    ];

    downloadTemplate(headers, "EolMasterTemplate");
});
</script>
