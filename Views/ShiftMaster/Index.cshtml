<!-- Get View Data -->
@{
    var shiftMasterData = ViewData["ShiftMasterData"] ?? "[]";
    Layout = "_Layout";
}

<head></head>

<style>
    .main-container {
        margin-left: 5px;
        margin-right: 5px;
    }
</style>

<div class="main-container">

     <!------- Page Title Section ------->
    <div class="col-12 text-center py-1 mb-3" style="background:#242424;color:white;">
        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Shift Category</h6>
    </div>

     <!------- Toolbar: Search + Actions ------->
    <div class="row align-items-center mb-3">

         <!-- Spacer on xs devices -->
        <div class="w-100 d-md-none"></div>

        <div class="col-12 col-md d-flex justify-content-md-end align-items-center gap-2 flex-wrap">

             <!-- Search input -->
             <input type="search" id="searchField" class="form-control form-control-sm" placeholder="Search..." style="max-width: 280px; min-width: 150px;" />

             <!-- Action buttons group -->
            <div class="btn-group flex-wrap">

                 <!-- Add -->
                <button id="add-btn" class="btn btn-primary-professional btn-sm px-3" title="Add">
                    <span class="material-icons">add</span>
                </button>
               
                 <!-- Edit -->
                <button id="edit-btn" class="btn btn-primary-professional btn-sm px-3" title="Edit">
                    <span class="material-icons">edit</span>
                </button>

                  <!-- Delete -->
                <button id="delete-btn" class="btn btn-primary-professional btn-sm px-3" title="Delete">
                    <span class="material-icons">delete</span>
                </button>
                
                  <!-- Download -->
                <button id="download-btn" class="btn btn-primary-professional btn-sm px-3" title="Download">
                    <span class="material-icons">download</span>
                </button>

                  <!-- Upload -->
                <button id="upload-btn" class="btn btn-primary-professional btn-sm px-3" title="Upload">
                    <span class="material-icons">upload</span>
                </button>

                 <!-- Download Template -->
                <button id="download-template-btn" class="btn btn-primary-professional btn-sm px-3" title="Template">
                    <span class="material-icons">assignment_returned</span>
                </button>
            </div>

        </div>
    </div>

      <!------- Data grid + record count ------->
    <div id="shiftMastertable" class="tabulator-bootstrap5"></div>
    <div id="recordCount" class="footer-total-records"></div>
</div>


<!------- Add/Edit Modal ------->
<div class="modal fade modal-request" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

             <!-- Header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addEditModalLabel">Add/Edit Shift</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter:invert(1);"></button>
            </div>

             <!-- Body -->
            <div class="modal-body">
                <form id="addEditForm" autocomplete="off">

                    <input type="hidden" id="Shift_id" name="Shift_id" />

                    <div class="row g-3 mt-1 mb-2">

                         <!-- Shift name -->
                        <div>
                            <label class="form-label">Shift Name <span class="text-danger">*</span></label>
                            <input type="text" id="Shift_name" name="Shift_name" class="form-control"
                                   required maxlength="15"style="width: 150px;" autocomplete="off">
                        </div>

                         <!-- Shift Description -->
                        <div>
                            <label class="form-label">Description</label>
                            <input type="text" id="Shift_description" name="Shift_description"
                                   class="form-control" maxlength="20" style="width: 300px;"autocomplete="off">
                        </div>

                    </div>

                    <div class="row g-3 align-items-end mt-2">

                         <!-- Start time -->
                        <div>
                            <label class="form-label">From Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="start_time" name="start_time" required>
                        </div>

                         <!-- End time -->
                        <div>
                            <label class="form-label">To Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="end_time" name="end_time" required>
                        </div>

                         <!-- Add Break -->
                       <div class="d-flex align-items-center" style="margin-left:10px;">
                            <button type="button" id="addBreakBtn"
                                    style="background:#007bff;color:white;border:1px solid #007bff;">
                                <span class="material-icons" style="font-size:16px;">add</span> Add Break
                            </button>
                        </div>

                    </div>
                     <!-- Break container -->
                    <div id="breakContainer" class="mt-3 border rounded-3 p-3" style="display:none;">
                        <label class="form-label fw-bold mb-2">Break Timings</label>
                        <div id="breakRows"></div>
                    </div>

                </form>
            </div>

              <!-- Footer -->
            <div class="modal-footer">

                 <!-- Buttons -->
                <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" id="modalSubmitBtn" form="addEditForm" class="btn btn-submit">Add</button>
            </div>

        </div>
    </div>
</div>

 <!------- Hidden file input for CSV upload ------->
<form id="afForm" style="display:none" method="post">
    @Html.AntiForgeryToken()
  <input type="file" id="upload-file" style="display:none" accept=".xls,.xlsx" />
</form>

 <!-- Scrips -->
<script>
$(document).ready(function () {

    // ================================================================
    //  Utility: Check if value is blank or spaces only
    // ================================================================
    function isBlankOrSpaces(v) {
        return !v || $.trim(v).length === 0;
    }

    // ================================================================
    //  Normalize and validate input fields
    // ================================================================
    function normalizeAndValidateField($el) {
        if (!$el.is('input[type="text"], textarea')) return true;

        // Replace multiple spaces → single space & trim ends
        const trimmed = $el.val().replace(/\s+/g, ' ').trim();
        $el.val(trimmed);

        // Reset HTML5 validation
        $el[0].setCustomValidity("");

        // Required field check
        if ($el.is('[required]') && isBlankOrSpaces($el.val())) {
            $el[0].setCustomValidity("This field cannot be empty or only spaces.");
            return false;
        }

        return true;
    }
    
    // ================================================================
    //  Form input auto-validation
    // ================================================================
    const $form = $("#addEditForm");

    $form.on("input", 'input[type="text"], textarea', function () {
        this.setCustomValidity("");
    });

    $form.on("blur", 'input[type="text"], textarea', function () {
        normalizeAndValidateField($(this));
    });

    // Global validator for form submit
    window.validateNoSpaceOnlyInputs = function (formEl) {
        let ok = true;
        $(formEl).find('input[type="text"], textarea').each(function () {
            if (!normalizeAndValidateField($(this))) {
                this.reportValidity();
                this.focus();
                ok = false;
                return false;
            }
        });
        return ok;
    };

    // ================================================================
    //  Init tooltip + load initial data
    // ================================================================
    initTooltips();

    const shiftMasterData = @Html.Raw(shiftMasterData);
    let selectedRow = null;
    let currentMode = "";


    // ================================================================
    //  Tabulator table setup
    // ================================================================
    const dataTable = new Tabulator("#shiftMastertable", {
        data: shiftMasterData,
        columns: [
            { title: "Shift Name", field: "Shift_name",headerHozAlign: "center" },
            { title: "Shift Description", field: "Shift_description", headerHozAlign: "center" },
            { title: "Start Time", field: "Start_time",headerHozAlign: "center"},
            { title: "End Time", field: "End_time", headerHozAlign: "center" },
            { title: "Created By", field: "Created_by", headerHozAlign: "center"},
        ],
        layout: "fitColumns",
        height: "70vh",
        selectable: 1,

        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [5, 10, 20, 50, 100],

        resizableRows: false,
        resizableColumnGuide: false,
        columnDefaults: { resizable: false },
        movableColumns: false,

        locale: true,
        langs: {
	        "en": {
		        pagination: {
			        first: "<<",
			        first_title: "First",
			        last: ">>",
			        last_title: "Last",
			        prev: "<",
			        prev_title: "Prev",
			        next: ">",
			        next_title: "Next",
			        page_size: "Page Size"
		        }
	        }
        },

        rowClick: function (e, row) {
	        selectedRow = row.getData();
        }
        });

    dataTable.on("dataLoaded", data =>
        $("#recordCount").text("Total Records: " + data.length)
    );


    // ================================================================
    //  Search functionality
    // ================================================================
     $("#searchField").on("keyup", function () {
        const value = $(this).val().toLowerCase();

        if (value === "") {
            dataTable.clearFilter();
            return;
        }

        dataTable.setFilter(function (data) {
            return Object.values(data)
                .join(" ")
                .toLowerCase()
                .includes(value);
        });
    });


    // ================================================================
    //  Modal setup
    // ================================================================
    const modalEl = $("#addEditModal");
    const addEditModal = new bootstrap.Modal(modalEl[0]);
    const form = $("#addEditForm");

    const breakContainer = $("#breakContainer");
    const breakRows = $("#breakRows");
    let breakCount = 0;

    modalEl.on("hidden.bs.modal", () => {
        breakRows.html("");
        breakContainer.hide();
        breakCount = 0;
    });


    // ================================================================
    //  Add mode
    // ================================================================
    $("#add-btn").on("click", () => {
        currentMode = "Add";
        form[0].reset();
        $("#Shift_id").val(0);

        $("#modalSubmitBtn").text("Add");
        $("#addEditModalLabel").text("Add Shift");

        addEditModal.show();
    });


    // ================================================================
    //  Edit mode
    // ================================================================
    $("#edit-btn").on("click", () => {
        const row = dataTable.getSelectedData()?.[0];
        if (!row)
            return showAppAlert({ icon: "warning", title: "No Selection", text: "Select a row." });

        currentMode = "Edit";

        $("#Shift_id").val(row.Shift_id);
        $("#Shift_name").val(row.Shift_name);
        $("#Shift_description").val(row.Shift_description);

        if (row.Start_time) $("#start_time").val(row.Start_time.substring(0, 5));
        if (row.End_time) $("#end_time").val(row.End_time.substring(0, 5));

        // Load break details
        breakRows.html("");
        breakCount = 0;
        breakContainer.hide();

        if (row.Break_details) {
            try {
                const breaks = JSON.parse(row.Break_details);
                breaks.forEach((b, i) => {
                    breakCount++;
                    breakContainer.show();

                    const html = `
                        <div class="row g-2 align-items-center mb-2" id="breakRow_${breakCount}">
                            <div class="col-md-3">
                                <input type="time" class="form-control"
                                       name="Breaks[${breakCount}].In"
                                       value="${b[`Break${breakCount}In`] || ""}" required>
                            </div>
                            <div class="col-md-3">
                                <input type="time" class="form-control"
                                       name="Breaks[${breakCount}].Out"
                                       value="${b[`Break${breakCount}Out`] || ""}" required>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control"
                                       name="Breaks[${breakCount}].Description"
                                       value="${b[`Break${breakCount}Description`] || ""}"
                                       placeholder="Description">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger-professional btn-sm removeBreakBtn">
                                    <span class="material-icons" style="font-size:16px;">close</span>
                                </button>
                            </div>
                        </div>`;

                    breakRows.append(html);
                });

                $(".removeBreakBtn").on("click", function () {
                    $(this).closest(".row").remove();
                    if (!breakRows.children().length) breakContainer.hide();
                });

            } catch (err) {
                console.error("Break JSON parse failed", err);
            }
        }

        $("#modalSubmitBtn").text("Update");
        $("#addEditModalLabel").text("Edit Shift");

        addEditModal.show();
    });


    // ================================================================
    //  Delete record
    // ================================================================
    $("#delete-btn").on("click", async () => {
        const row = dataTable.getSelectedData()?.[0];
        if (!row)
            return showAppAlert({ icon: "warning", title: "No Selection", text: "Select a row." });

        const confirm = await showAppAlert({
            type: "confirm",
            icon: "question",
            title: "Delete Confirmation",
            text: "Are you sure?"
        });

        if (!confirm.isConfirmed) return;

        const success = await deleteRecord("/ShiftMaster/Delete", { Shift_id: row.Shift_id });
        if (success) setTimeout(() => location.reload(), 900);
    });


    // ================================================================
    //  Submit form (add/update)
    // ================================================================
    form.on("submit", async e => {
        e.preventDefault();

        const raw = new FormData(form[0]);
        const formData = Object.fromEntries(raw.entries());

        // Build break array
        const temp = {};
        const breakList = [];

        for (let key of raw.keys()) {
            if (key.startsWith("Breaks[")) {
                let m = key.match(/Breaks\[(\d+)\]\.(In|Out|Description)/);
                if (!m) continue;

                let idx = m[1];
                let field = m[2];

                if (!temp[idx]) temp[idx] = {};
                temp[idx][field] = raw.get(key);
            }
        }

        let i = 1;
        for (let idx in temp) {
            breakList.push({
                [`Break${i}In`]: temp[idx].In,
                [`Break${i}Out`]: temp[idx].Out,
                [`Break${i}Description`]: temp[idx].Description
            });
            i++;
        }

        formData.break_details = JSON.stringify(breakList);

        const url = currentMode === "Add" ? "/ShiftMaster/Create" : "/ShiftMaster/Update";

        const success = await saveRecord(url, formData, currentMode, addEditModal, form[0]);
        if (success) setTimeout(() => location.reload(), 900);
    });


    // ================================================================
    //  Add break
    // ================================================================
    $("#addBreakBtn").on("click", () => {
        breakCount++;
        breakContainer.show();

        const html = `
            <div class="row g-2 align-items-center mb-2" id="breakRow_${breakCount}">
                <div class="col-md-3">
                    <input type="time" class="form-control"
                           name="Breaks[${breakCount}].In" required>
                </div>
                <div class="col-md-3">
                    <input type="time" class="form-control"
                           name="Breaks[${breakCount}].Out" required>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control"
                           name="Breaks[${breakCount}].Description"
                           placeholder="Break Description" required>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger-professional btn-sm removeBreakBtn">
                        <span class="material-icons" style="font-size:16px;">close</span>
                    </button>
                </div>
            </div>`;

        breakRows.append(html);

        $(".removeBreakBtn").last().on("click", function () {
            $(this).closest(".row").remove();
            if (!breakRows.children().length) breakContainer.hide();
        });
    });


    // ================================================================
    //  Download CSV
    // ================================================================
    $("#download-btn").on("click", () => {
        let count = dataTable.getData()?.length || 0;
        if (count === 0)
            return showAppAlert({ icon: "warning", title: "No Data", text: "No records to download." });

        downloadCsv(dataTable, "ShiftMaster.csv");
    });


    // ================================================================
    //  Download template
    // ================================================================
    $("#download-template-btn").on("click", function () {
        const headers = [
            "Shift Name",
            "Shift Description",
            "Start Time",
            "End Time",
            "Break1In",
            "Break1Out",
            "Break1Description",
            "Break2In",
            "Break2Out",
            "Break2Description",
            "Break3In",
            "Break3Out",
            "Break3Description",
            "Break4In",
            "Break4Out",
            "Break4Description",
            "Break5In",
            "Break5Out",
            "Break5Description"
        ];

        downloadTemplate(headers, "ShiftMaster");
    });


    // ================================================================
    //  Upload file
    // ================================================================
    $("#upload-btn").on("click", function () {
        $("#upload-file").click();
    });

    $("#upload-file").on("change", function (event) {
        const file = event.target.files?.[0];

        if (!file) {
            return showAppAlert({
                icon: 'warning',
                title: 'No File',
                text: 'Please select a file to upload.'
            });
        }

        const isExcel = /\.(xlsx|xls)$/i.test(file.name);
        if (!isExcel) {
            showAppAlert({
                icon: 'warning',
                title: 'Invalid File',
                text: 'Please select an Excel file (.xlsx or .xls).'
            });
            return;
        }

        uploadFile('/ShiftMaster/Upload', file);
    });


    // ================================================================
    //  Upload function
    // ================================================================
    async function uploadFile(url, file) {
        const formData = new FormData();
        formData.append("file", file);

        const csrf = $('#afForm input[name="__RequestVerificationToken"]').val();

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'RequestVerificationToken': csrf },
                body: formData
            });

            await handleUploadResponse(response);

        } catch (err) {
            showToast({ icon: "error", text: err.message });
        }
    }


    // ================================================================
    //  Handle upload response
    // ================================================================
    async function handleUploadResponse(response) {

        const result = await response.json().catch(() => null);

        // SUCCESS
        if (response.ok) {

            showAppAlert({
                icon: result.status,
                title: result.title,
                text: result.message,
                timer: 2500,
                showConfirmButton: false
            });

            setTimeout(() => location.reload(), 800);
            $("#upload-file").val("");
            return;
        }

        // VALIDATION API ERRORS
        if (result && result.errors) {

            let msg = "";
            result.errors.forEach(e => {
                msg += `Error: ${e.error}\n\n`;
            });

            showAppAlert({
                icon: "error",
                title: "Upload Failed",
                text: msg,
                timer: 4500,
                showConfirmButton: false
            });

            $("#upload-file").val("");
            return;
        }

      // GENERIC API MESSAGE
        if (result && result.message) {
            showAppAlert({
                icon: "error",
                title: "Upload Failed",
                text: result.message,
                timer: 3500,
                showConfirmButton: false
            });

            $("#upload-file").val("");
            return;
        }

        // UNKNOWN ERROR
        showAppAlert({
            icon: "error",
            title: "Upload Failed",
            text: "Unexpected error.",
            timer: 3500,
            showConfirmButton: false
        });

        $("#upload-file").val("");
    }
        
});
</script>
